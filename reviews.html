<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reviews â€” Mosaic Pins</title>

  <style>
    :root{
      --bg:#0b0d11;
      --text:#e9eef7;
      --muted:#a8b3c7;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 30px rgba(0,0,0,.45);
      --r:18px;

      --overlay: rgba(0,0,0,.72);
      --overlay2: rgba(0,0,0,.82);
      --panel: rgba(0,0,0,.28);
      --panelHover: rgba(255,255,255,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color:var(--text);
      overflow:hidden;
      position:relative;
      isolation:isolate;
    }

    body::before{
      content:"";
      position:fixed;
      inset:-20vh -20vw;
      z-index:-1;
      pointer-events:none;
      background:
        radial-gradient(1100px 700px at 35% -10%, rgba(50,220,150,.25), transparent 55%),
        radial-gradient(900px 600px at 75% 10%, rgba(120,90,255,.22), transparent 55%),
        var(--bg);
      filter: blur(18px) saturate(1.05);
      transform: translateZ(0);
      will-change: transform;
    }

    /* Dark scrollbar like main */
    *{
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.18) rgba(0,0,0,.25);
    }
    *::-webkit-scrollbar{width:10px;height:10px}
    *::-webkit-scrollbar-track{background:rgba(0,0,0,.25); border-radius:999px}
    *::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18); border-radius:999px; border:2px solid rgba(0,0,0,.25)}
    *::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.25)}

    .app{display:grid; grid-template-columns: 280px 1fr; height:100vh; gap:16px; padding:16px;}

    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .sb-top{
      padding:18px 18px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex:0 0 auto;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px;}
    .dot{width:10px;height:10px;border-radius:50%; background:linear-gradient(135deg,#22c55e,#60a5fa);}
    .pill{
      padding:8px 10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .sb-nav{padding:6px; display:grid; gap:6px; flex:0 0 auto;}
    .nav-item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:12px;
      color:var(--muted);
      text-decoration:none;
      border:1px solid transparent;
    }
    .nav-item:hover{background:rgba(255,255,255,.05); color:var(--text);}
    .nav-item.active{
      background:rgba(34,197,94,.12);
      border-color: rgba(34,197,94,.22);
      color:var(--text);
    }

    .sb-scroll{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding:6px 6px 10px;
      position:relative;
    }
    .sb-scroll:before,
    .sb-scroll:after{
      content:"";
      position:sticky;
      left:0; right:0;
      height:14px;
      pointer-events:none;
      z-index:2;
      display:block;
    }
    .sb-scroll:before{
      top:0;
      background: linear-gradient(180deg, rgba(11,13,17,.95), rgba(11,13,17,0));
    }
    .sb-scroll:after{
      bottom:0;
      background: linear-gradient(0deg, rgba(11,13,17,.95), rgba(11,13,17,0));
    }

    .sb-card{
      margin:0 6px 10px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
    }
    .sb-card h3{
      margin:0 0 6px;
      font-size:13px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .sb-card p{
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      white-space:pre-line;
    }

    .main{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .topbar{
      padding: calc(16px + env(safe-area-inset-top)) 18px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
      flex:0 0 auto;
    }
    .top-left{display:flex; align-items:center; gap:10px; min-width:0}
    .h-title{font-weight:900; font-size:18px; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .sub{color:var(--muted); font-size:12px; margin-top:4px}

    .top-right{display:flex; align-items:center; gap:10px}
    .cartBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.28);
      border:1px solid var(--line);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
      min-height:44px;
      line-height:1.1;
    }
    .cartBtn:hover{background:rgba(255,255,255,.06)}
    .cartBadge{
      padding:4px 8px;
      border-radius:999px;
      background:rgba(34,197,94,.18);
      border:1px solid rgba(34,197,94,.25);
      color:var(--text);
      font-size:12px;
      font-weight:900;
      line-height:1;
      min-width:24px;
      text-align:center;
    }

    .content{padding:18px; overflow:auto; min-height:0;}

    /* ===== REVIEWS PAGE ===== */
    .hero{
      border-radius:18px;
      border:1px solid var(--line);
      overflow:hidden;
      background:rgba(0,0,0,.22);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .heroRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .heroTitle{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .heroMeta{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    .avgBox{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      min-height:44px;
    }
    .avgNum{
      font-weight:950;
      font-size:18px;
      letter-spacing:.2px;
    }
    .avgSub{
      color:var(--muted);
      font-size:12px;
    }

    .grid2{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:start;
    }

    .panel{
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:14px 16px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelTitle{
      margin:0;
      font-weight:950;
      letter-spacing:.2px;
      font-size:14px;
    }
    .hint{font-size:12px; color:var(--muted); opacity:.9;}

    .panelBody{padding:14px 16px 16px;}

    /* form */
    .field{display:grid; gap:8px; margin-bottom:12px;}
    .label{font-size:12px; color:var(--muted);}
    .input, .textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    .textarea{min-height:110px; resize:vertical;}

    .formRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .starsPick{
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
      flex-wrap:wrap;
    }
    .starBtn{
      width:38px;
      height:38px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-size:18px;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: transform .12s ease, background .12s ease;
    }
    .starBtn:hover{background:rgba(255,255,255,.08); transform: translateY(-1px);}
    .starBtn.active{
      background:rgba(34,197,94,.16);
      border-color: rgba(34,197,94,.25);
    }
    .ratingText{color:var(--muted); font-size:12px;}

    .btn{
      border:none; cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#07110b;
      font-weight:950;
      box-shadow: 0 10px 18px rgba(34,197,94,.18);
      transition: filter .15s ease, transform .15s ease;
      white-space:nowrap;
      width:100%;
    }
    .btn:hover{filter:brightness(1.05); transform: translateY(-1px)}
    .btn:disabled{
      cursor:not-allowed;
      background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.55);
      box-shadow:none;
      transform:none;
    }

    /* list */
    .list{
      display:grid;
      gap:12px;
    }
    .review{
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:12px;
    }
    .rTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .rName{
      font-weight:950;
      letter-spacing:.2px;
      margin:0;
      font-size:13px;
    }
    .rDate{color:var(--muted); font-size:12px;}
    .rStars{
      display:flex;
      gap:2px;
      font-size:14px;
      line-height:1;
      white-space:nowrap;
    }
    .rStars span{opacity:.95;}
    .rText{
      margin:10px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.55;
      white-space:pre-line;
    }
    .rPhotos{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .rPhoto{
      width:86px;
      height:86px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      overflow:hidden;
      cursor:pointer;
    }
    .rPhoto img{width:100%; height:100%; object-fit:cover; display:block;}

    .empty{
      padding:14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--muted);
      font-size:13px;
    }

    .siteFooter{
      padding: 12px 18px;
      border-top: 1px solid var(--line);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      flex: 0 0 auto;
    }
    .siteFooter a{
      color: var(--text);
      text-decoration:none;
      opacity:.9;
    }
    .siteFooter a:hover{opacity:1}
    .siteFooter .sep{opacity:.35}

    /* Lightbox (for photos) */
    .lightboxBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.78);
      display:none;
      z-index:2000;
      backdrop-filter: blur(6px);
    }
    .lightboxBack.show{display:block}
    .lightbox{
      position:fixed;
      inset:0;
      display:none;
      z-index:2001;
      place-items:center;
      padding: 18px;
    }
    .lightbox.show{display:grid}
    .lightboxCard{
      width: min(980px, 96vw);
      max-height: 86vh;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.55);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .lightboxImg{
      width:100%;
      height: 86vh;
      max-height: 86vh;
      object-fit: contain;
      display:block;
      background: rgba(0,0,0,.35);
    }
    .lbTop{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .lbPill{
      pointer-events:none;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.45);
      border:1px solid var(--line);
      color:var(--text);
      font-size:12px;
      backdrop-filter: blur(10px);
    }
    .lbClose{
      pointer-events:auto;
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.45);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:950;
      line-height:1;
    }
    .lbClose:hover{background:rgba(255,255,255,.08)}

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(0,0,0,.65);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 14px;
      color: var(--text);
      box-shadow: var(--shadow);
      max-width: 360px;
      display:none;
      z-index:999;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:block}
    .toast small{color:var(--muted)}

    @media (max-width:980px){
      body{overflow:auto}
      .app{grid-template-columns:1fr; height:auto; min-height:100vh}
      .sidebar{display:none}
      .main{height:auto; min-height:100vh}
      .content{padding:14px}
      .grid2{grid-template-columns:1fr;}
      .formRow{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand"><span class="dot"></span> Mosaic Pins</div>
        <div class="pill">Reviews</div>
      </div>

      <nav class="sb-nav">
        <a class="nav-item" href="/" id="navShop">Shop</a>
        <a class="nav-item" href="/about" id="navAbout">About</a>
        <a class="nav-item" href="/reviews" id="navReviews">Reviews</a>
        <a class="nav-item" href="/shipping" id="navShipping">Shipping</a>
        <a class="nav-item" href="/returns" id="navReturns">Returns</a>
      </nav>

      <div class="sb-scroll">
        <div class="sb-card">
          <h3>How it works</h3>
          <p>
            Leave a review â€” it will appear after approval.<br/>
            Rating: 1â€“5 stars.
          </p>
        </div>

        <div class="sb-card">
          <h3>Contact</h3>
          <p><a style="color:var(--text); text-decoration:none; opacity:.9" href="mailto:support@mosaipins.space">support@mosaipins.space</a></p>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="top-left">
          <div>
            <h1 class="h-title" id="topTitle">Reviews</h1>
            <div class="sub" id="topSub">Mosaic Pins Space</div>
          </div>
        </div>

        <div class="top-right">
          <button class="cartBtn" id="openCart" type="button" title="Cart">
            ðŸ›’ Cart <span class="cartBadge" id="cartBadge">0</span>
          </button>
        </div>
      </div>

      <div class="content">
        <section class="hero">
          <div class="heroRow">
            <div>
              <h2 class="heroTitle">Customer reviews</h2>
              <div class="heroMeta" id="heroMeta">Loadingâ€¦</div>
            </div>

            <div class="avgBox" aria-label="Average rating">
              <div class="avgNum" id="avgNum">â€”</div>
              <div>
                <div class="rStars" id="avgStars" aria-label="Average stars">â€”</div>
                <div class="avgSub" id="avgSub">â€”</div>
              </div>
            </div>
          </div>
        </section>

        <div class="grid2">
          <!-- FORM -->
          <section class="panel">
            <div class="panelHead">
              <h3 class="panelTitle">Leave a review</h3>
              <div class="hint">Will be published after approval</div>
            </div>

            <div class="panelBody">
              <div class="formRow">
                <div class="field">
                  <div class="label">Name</div>
                  <input class="input" id="name" placeholder="Your name" maxlength="60" />
                </div>

                <div class="field">
                  <div class="label">Country (optional)</div>
                  <input class="input" id="country" placeholder="Germany, USAâ€¦" maxlength="40" />
                </div>
              </div>

              <div class="field">
                <div class="label">Rating</div>
                <div class="starsPick" id="starsPick" aria-label="Choose rating">
                  <!-- stars injected -->
                  <div class="ratingText" id="ratingText">Select 5 stars</div>
                </div>
              </div>

              <div class="field">
                <div class="label">Review text</div>
                <textarea class="textarea" id="text" placeholder="Tell us what you likedâ€¦" maxlength="1200"></textarea>
              </div>

              <button class="btn" id="sendBtn" type="button">Send review</button>
              <div style="margin-top:10px; color:var(--muted); font-size:12px;">
                Tip: keep it short and clear ðŸ™‚
              </div>
            </div>
          </section>

          <!-- LIST -->
          <section class="panel">
            <div class="panelHead">
              <h3 class="panelTitle">Approved reviews</h3>
              <div class="hint" id="countHint">â€”</div>
            </div>

            <div class="panelBody">
              <div class="list" id="list"></div>
            </div>
          </section>
        </div>
      </div>

      <footer class="siteFooter">
        <a href="/shipping">Shipping</a>
        <span class="sep">|</span>
        <a href="/returns">Returns & Refunds</a>
        <span class="sep">|</span>
        <a href="mailto:support@mosaipins.space">support@mosaipins.space</a>
      </footer>
    </main>
  </div>

  <!-- Lightbox -->
  <div class="lightboxBack" id="lightboxBack"></div>
  <div class="lightbox" id="lightbox">
    <div class="lightboxCard">
      <div class="lbTop">
        <div class="lbPill" id="lbCounter">Photo</div>
        <button class="lbClose" id="lbClose" type="button" aria-label="Close">âœ•</button>
      </div>
      <img class="lightboxImg" id="lbImg" alt="Review photo" />
    </div>
  </div>

  <div class="toast" id="toast">
    <div style="font-weight:800" id="toastTitle">Notice</div>
    <small id="toastMsg">â€”</small>
  </div>

<script>
  const API_REVIEWS = "/api/reviews";
  const CART_KEY = "mp_cart";

  function readCart(){
    try{
      const raw = localStorage.getItem(CART_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(_){ return []; }
  }
  function cartCount(){ return readCart().reduce((s,it)=>s+(Number(it?.qty)||0),0); }

  const elCartBadge = document.getElementById("cartBadge");
  const elOpenCart = document.getElementById("openCart");
  function updateCartBadge(){ elCartBadge.textContent = String(cartCount()); }
  updateCartBadge();

  // simple cart toast (like your about page)
  const elToast = document.getElementById("toast");
  const elToastTitle = document.getElementById("toastTitle");
  const elToastMsg = document.getElementById("toastMsg");
  function toast(title, msg){
    elToastTitle.textContent = title;
    elToastMsg.textContent = msg;
    elToast.classList.add("show");
    setTimeout(()=> elToast.classList.remove("show"), 2600);
  }
  elOpenCart.addEventListener("click", () => {
    const c = readCart();
    if (!c.length) return toast("Cart", "Your cart is empty");
    toast("Cart", `Items: ${cartCount()}`);
  });

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // nav active
  (function navActive(){
    const path = window.location.pathname || "/";
    const ids = ["navShop","navAbout","navReviews","navShipping","navReturns"];
    ids.forEach(id => document.getElementById(id)?.classList.remove("active"));

    if (path.startsWith("/shipping")) document.getElementById("navShipping")?.classList.add("active");
    else if (path.startsWith("/returns")) document.getElementById("navReturns")?.classList.add("active");
    else if (path.startsWith("/about")) document.getElementById("navAbout")?.classList.add("active");
    else if (path.startsWith("/reviews")) document.getElementById("navReviews")?.classList.add("active");
    else document.getElementById("navShop")?.classList.add("active");
  })();

  // stars utils
  function starsText(r){
    r = Number(r)||0;
    let s = "";
    for (let i=1;i<=5;i++) s += (i<=r ? "â˜…" : "â˜†");
    return s;
  }
  function starsEl(r){
    const div = document.createElement("div");
    div.className = "rStars";
    div.setAttribute("aria-label", `${r} stars`);
    div.textContent = starsText(r);
    return div;
  }

  // rating picker
  const starsPick = document.getElementById("starsPick");
  const ratingText = document.getElementById("ratingText");
  let rating = 5;

  function renderPicker(){
    // keep ratingText at end
    starsPick.querySelectorAll("button.starBtn").forEach(x => x.remove());

    for (let i=1;i<=5;i++){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "starBtn" + (i<=rating ? " active" : "");
      b.textContent = "â˜…";
      b.setAttribute("aria-label", `${i} stars`);
      b.addEventListener("click", () => {
        rating = i;
        ratingText.textContent = `Selected: ${rating}/5`;
        renderPicker();
      });
      starsPick.insertBefore(b, ratingText);
    }
    ratingText.textContent = `Selected: ${rating}/5`;
  }
  renderPicker();

  // lightbox for photos
  const lbBack = document.getElementById("lightboxBack");
  const lb = document.getElementById("lightbox");
  const lbImg = document.getElementById("lbImg");
  const lbClose = document.getElementById("lbClose");
  const lbCounter = document.getElementById("lbCounter");

  function openPhoto(url){
    lbImg.src = url;
    lbCounter.textContent = "Photo";
    lbBack.classList.add("show");
    lb.classList.add("show");
    document.body.style.overflow = "hidden";
  }
  function closePhoto(){
    lbBack.classList.remove("show");
    lb.classList.remove("show");
    document.body.style.overflow = "";
  }
  lbClose.addEventListener("click", closePhoto);
  lbBack.addEventListener("click", closePhoto);
  window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closePhoto(); });

  // render reviews
  const elList = document.getElementById("list");
  const heroMeta = document.getElementById("heroMeta");
  const countHint = document.getElementById("countHint");

  const avgNum = document.getElementById("avgNum");
  const avgStars = document.getElementById("avgStars");
  const avgSub = document.getElementById("avgSub");

  function fmtDate(value){
    if (!value) return "";
    const d = new Date(value);
    if (isNaN(d.getTime())) return "";
    return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
  }

  function calcAverage(items){
    const arr = (items||[]).map(x => Number(x.rating)).filter(n => Number.isFinite(n) && n>=1 && n<=5);
    if (!arr.length) return { avg:null, count:0 };
    const sum = arr.reduce((a,b)=>a+b,0);
    return { avg: sum/arr.length, count: arr.length };
  }

  function reviewCard(r){
    const wrap = document.createElement("div");
    wrap.className = "review";

    const top = document.createElement("div");
    top.className = "rTop";

    const left = document.createElement("div");
    const name = document.createElement("p");
    name.className = "rName";
    name.textContent = r.name || "Anonymous";

    const date = document.createElement("div");
    date.className = "rDate";
    const country = (r.country ? ` â€¢ ${r.country}` : "");
    date.textContent = `${fmtDate(r.createdAt || r.date || "")}${country}`;

    left.appendChild(name);
    left.appendChild(date);

    const right = starsEl(r.rating || 0);

    top.appendChild(left);
    top.appendChild(right);

    const text = document.createElement("p");
    text.className = "rText";
    text.textContent = r.text || "";

    wrap.appendChild(top);
    wrap.appendChild(text);

    // Photos: expected array of urls
    if (Array.isArray(r.photos) && r.photos.length){
      const ph = document.createElement("div");
      ph.className = "rPhotos";
      r.photos.slice(0, 12).forEach(url => {
        const box = document.createElement("div");
        box.className = "rPhoto";
        box.innerHTML = `<img src="${escapeHtml(url)}" alt="Photo" loading="lazy" />`;
        box.addEventListener("click", ()=> openPhoto(url));
        ph.appendChild(box);
      });
      wrap.appendChild(ph);
    }

    return wrap;
  }

  async function loadReviews(){
    heroMeta.textContent = "Loadingâ€¦";
    elList.innerHTML = "";

    try{
      const r = await fetch(API_REVIEWS, { method:"GET", cache:"no-store" });
      const data = await r.json().catch(()=>({}));
      if (!r.ok) throw new Error(data?.error || "Failed to load reviews");

      const items = Array.isArray(data?.reviews) ? data.reviews : [];
      const { avg, count } = calcAverage(items);

      const total = items.length;

      heroMeta.textContent = total
        ? `Showing approved reviews from customers.`
        : `No approved reviews yet. Be the first ðŸ™‚`;

      countHint.textContent = total ? `${total} reviews` : "â€”";

      if (avg == null){
        avgNum.textContent = "â€”";
        avgStars.textContent = "â€”";
        avgSub.textContent = "No ratings yet";
      } else {
        avgNum.textContent = avg.toFixed(2);
        avgStars.textContent = starsText(Math.round(avg));
        avgSub.textContent = `${count} ratings`;
      }

      if (!items.length){
        elList.innerHTML = `<div class="empty">No reviews yet. Your review will appear after approval.</div>`;
        return;
      }

      // newest first if date exists
      items.sort((a,b) => {
        const ad = new Date(a.createdAt || a.date || 0).getTime() || 0;
        const bd = new Date(b.createdAt || b.date || 0).getTime() || 0;
        return bd - ad;
      });

      items.forEach(it => elList.appendChild(reviewCard(it)));
    }catch(e){
      heroMeta.textContent = "Failed to load reviews.";
      elList.innerHTML = `<div class="empty">Error: ${escapeHtml(String(e?.message || e))}</div>`;
      toast("Reviews", String(e?.message || e));
    }
  }

  // submit
  const elName = document.getElementById("name");
  const elCountry = document.getElementById("country");
  const elText = document.getElementById("text");
  const elSend = document.getElementById("sendBtn");

  function validate(){
    const name = (elName.value || "").trim();
    const text = (elText.value || "").trim();
    if (name.length < 2) return "Name is too short";
    if (rating < 1 || rating > 5) return "Rating must be 1..5";
    if (text.length < 10) return "Text is too short (min 10 chars)";
    return null;
  }

  async function sendReview(){
    const err = validate();
    if (err){ toast("Review", err); return; }

    const payload = {
      name: (elName.value || "").trim(),
      country: (elCountry.value || "").trim(),
      rating: rating,
      text: (elText.value || "").trim(),
      source: "site",
    };

    elSend.disabled = true;
    elSend.textContent = "Sendingâ€¦";

    try{
      const r = await fetch(API_REVIEWS, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
      });
      const data = await r.json().catch(()=>({}));
      if (!r.ok || !data?.ok){
        throw new Error(data?.error || "Failed to send review");
      }

      toast("Review", "Sent âœ… Waiting for approval");
      elText.value = "";
      // keep name/country for convenience
      // reload list (won't show until approved, but keeps stats fresh if you approve quickly)
      loadReviews();
    }catch(e){
      toast("Review", String(e?.message || e));
    }finally{
      elSend.disabled = false;
      elSend.textContent = "Send review";
    }
  }

  elSend.addEventListener("click", sendReview);

  // enter submit (optional)
  elText.addEventListener("keydown", (e)=>{
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") sendReview();
  });

  loadReviews();
</script>
</body>
</html>