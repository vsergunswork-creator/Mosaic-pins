<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reviews ‚Äî Mosaic Pins</title>

  <style>
    :root{
      --bg:#0b0d11;
      --text:#e9eef7;
      --muted:#a8b3c7;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 30px rgba(0,0,0,.45);
      --r:18px;
      --overlay: rgba(0,0,0,.72);
      --overlay2: rgba(0,0,0,.82);
      --panel: rgba(0,0,0,.28);
      --panelHover: rgba(255,255,255,.05);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color:var(--text);
      overflow:hidden;
      position:relative;
      isolation:isolate;
    }

    body::before{
      content:"";
      position:fixed;
      inset:-20vh -20vw;
      z-index:-1;
      pointer-events:none;
      background:
        radial-gradient(1100px 700px at 35% -10%, rgba(50,220,150,.25), transparent 55%),
        radial-gradient(900px 600px at 75% 10%, rgba(120,90,255,.22), transparent 55%),
        var(--bg);
      filter: blur(18px) saturate(1.05);
    }

    .app{
      display:grid;
      grid-template-columns:280px 1fr;
      height:100vh;
      gap:16px;
      padding:16px;
    }

    .sidebar{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .sb-top{
      padding:18px 18px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .brand{font-weight:800;display:flex;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,#22c55e,#60a5fa)}
    .pill{
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
    }

    .sb-nav{padding:6px;display:grid;gap:6px}
    .nav-item{
      padding:10px 12px;
      border-radius:12px;
      color:var(--muted);
      text-decoration:none;
    }
    .nav-item.active{
      background:rgba(34,197,94,.12);
      color:var(--text);
    }

    .main{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .topbar{
      padding:16px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
    }

    .cartBtn{
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.28);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }

    .content{
      padding:18px;
      overflow:auto;
      flex:1;
    }

.hero{
      border-radius:18px;
      border:1px solid var(--line);
      overflow:hidden;
      background:rgba(0,0,0,.22);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .heroRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .heroTitle{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .heroMeta{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    .avgBox{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      min-height:44px;
    }
    .avgNum{font-weight:950; font-size:18px; letter-spacing:.2px;}
    .avgSub{color:var(--muted); font-size:12px;}

    .grid2{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:start;
    }

    .panel{
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:14px 16px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelTitle{margin:0; font-weight:950; letter-spacing:.2px; font-size:14px;}
    .hint{font-size:12px; color:var(--muted); opacity:.9;}
    .panelBody{padding:14px 16px 16px;}

    .field{display:grid; gap:8px; margin-bottom:12px;}
    .label{font-size:12px; color:var(--muted);}
    .input, .textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    .textarea{min-height:110px; resize:vertical;}

    .formRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .starsPick{
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
      flex-wrap:wrap;
    }
    .starBtn{
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-size:18px;
      line-height:1;
      display:flex; align-items:center; justify-content:center;
      transition: transform .12s ease, background .12s ease;
    }
    .starBtn:hover{background:rgba(255,255,255,.08); transform: translateY(-1px);}
    .starBtn.active{background:rgba(34,197,94,.16); border-color: rgba(34,197,94,.25);}
    .ratingText{color:var(--muted); font-size:12px;}

    .btn{
      border:none; cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#07110b;
      font-weight:950;
      box-shadow: 0 10px 18px rgba(34,197,94,.18);
      transition: filter .15s ease, transform .15s ease;
      white-space:nowrap;
      width:100%;
    }
    .btn:hover{filter:brightness(1.05); transform: translateY(-1px)}
    .btn:disabled{
      cursor:not-allowed;
      background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.55);
      box-shadow:none;
      transform:none;
    }

    .list{display:grid; gap:12px;}
    .review{
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:12px;
    }
    .rTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .rName{font-weight:950; letter-spacing:.2px; margin:0; font-size:13px;}
    .rDate{color:var(--muted); font-size:12px;}
    .rStars{display:flex; gap:2px; font-size:14px; line-height:1; white-space:nowrap;}
    .rText{
      margin:10px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.55;
      white-space:pre-line;
    }

    .empty{
      padding:14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--muted);
      font-size:13px;
    }

    .rPhotos{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .rPhoto{
      width:72px;height:72px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      overflow:hidden;
      cursor:pointer;
    }
    .rPhoto img{width:100%;height:100%;object-fit:cover;display:block;}

    .footer{
      margin-top:auto;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.25);
      padding:14px 18px;
      flex: 0 0 auto;
    }
    .footerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .footerBrand{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .footerLinks{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .footerLinks a{
      text-decoration:none;
      color:var(--muted);
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      transition: background .15s ease, transform .15s ease;
      white-space:nowrap;
    }
    .footerLinks a:hover{
      background:rgba(255,255,255,.08);
      transform: translateY(-1px);
      color:var(--text);
    }

    /* ==========================
       ‚úÖ CART DRAWER (EXACT COPY)
    ========================== */
    .cartBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.74);
      display:none;
      z-index:1100;
      backdrop-filter: blur(6px);
    }
    .cartBack.show{display:block}
    .cartDrawer{
      position:fixed;
      top:0; right:0; bottom:0;
      width:min(420px, 92vw);
      border-left:1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,0,0,.92), rgba(0,0,0,.78));
      box-shadow: -18px 0 40px rgba(0,0,0,.60);
      transform: translateX(100%);
      transition: transform .18s ease;
      z-index:1101;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .cartDrawer.show{transform: translateX(0)}
    .cartHead{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
    }
    .cartTitle{font-weight:950; letter-spacing:.2px;}
    .cartClose{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.30);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:950;
      line-height:1;
    }
    .cartClose:hover{background:rgba(255,255,255,.06)}
    .cartBody{padding:12px; overflow:auto; min-height:0;}
    .cartEmpty{
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.04);
      color:var(--muted);
    }
    .cartItem{
      display:grid;
      grid-template-columns:64px 1fr;
      gap:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      margin-bottom:10px;
    }
    .cartImg{
      width:64px;height:64px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      color:var(--muted);
      font-size:12px;
    }
    .cartImg img{width:100%;height:100%;object-fit:cover;display:block;}
    .cartName{font-weight:900; font-size:13px; margin:0}
    .cartMeta{color:var(--muted); font-size:12px; margin:4px 0 0}
    .cartRow{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px;}
    .cartQty{
      display:flex; align-items:center; gap:6px;
      padding:6px 8px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
    }
    .cartQty button{
      width:30px;height:30px;border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .cartQty input{
      width:44px;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      text-align:center;
      font-weight:900;
    }
    .cartRemove{
      border:none;
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:900;
      line-height:1;
    }
    .cartRemove:hover{background:rgba(255,255,255,.06)}
    .cartFoot{
      padding:12px;
      border-top:1px solid var(--line);
      background:rgba(0,0,0,.40);
    }
    .cartSumRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px; color:var(--text); font-weight:950;
    }

    .cartActions{display:grid; gap:10px;}
    .actionRow{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      align-items:stretch;
    }
    .actionBtn{
      width:100%;
      min-height:44px;
      height:44px;
      padding:0 12px;
      line-height:44px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    .btn2{
      border:none; cursor:pointer;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:950;
      transition: background .15s ease, transform .15s ease;
      white-space:nowrap;
    }
    .btn2:hover{background:rgba(255,255,255,.10); transform: translateY(-1px)}
    .btn2:disabled{opacity:.45; cursor:not-allowed}

    .ppWrap{display:none; padding:0;}
    #paypal-button-container{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .ppNote{
      color:var(--muted);
      font-size:12px;
      margin-top:0;
      line-height:1.35;
      display:none;
      text-align:center;
    }

    @media (max-width:520px){
      .actionRow{grid-template-columns:1fr;}
      .actionBtn{height:46px; min-height:46px; line-height:46px;}
    }

    #cartCheckout{
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color:#07110b;
      border:none;
      box-shadow: 0 10px 18px rgba(34,197,94,.18);
    }
    #cartCheckout:hover{
      filter: brightness(1.05);
      transform: translateY(-1px);
    }
    #cartCheckout:disabled{
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.55);
      box-shadow:none;
      transform:none;
    }

    .lightboxBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.78);
      display:none;
      z-index:2000;
      backdrop-filter: blur(6px);
    }
    .lightboxBack.show{display:block}
    .lightbox{
      position:fixed;
      inset:0;
      display:none;
      z-index:2001;
      place-items:center;
      padding: 18px;
    }
    .lightbox.show{display:grid}

    .lightboxCard{
      width: min(980px, 96vw);
      max-height: 86vh;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.55);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .lightboxImg{
      width:100%;
      height: 86vh;
      max-height: 86vh;
      object-fit: contain;
      display:block;
      background: rgba(0,0,0,.35);
    }
    .lbTop{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .lbPill{
      pointer-events:none;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.45);
      border:1px solid var(--line);
      color:var(--text);
      font-size:12px;
      backdrop-filter: blur(10px);
    }
    .lbClose{
      pointer-events:auto;
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.45);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:950;
      line-height:1;
    }
    .lbClose:hover{background:rgba(255,255,255,.08)}

    @media (max-width:980px){
      .lightboxCard{width: 100%;}
      .lightboxImg{height: 80vh;}
    }

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(0,0,0,.65);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 14px;
      color: var(--text);
      box-shadow: var(--shadow);
      max-width: 360px;
      display:none;
      z-index:2605;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:block}
    .toast small{color:var(--muted)}

    .onlyMobile{display:none;}

    @media (max-width:980px){
      body{overflow:auto}
      .app{grid-template-columns:1fr; height:auto; min-height:100vh}
      .sidebar{display:none}
      .main{height:auto; min-height:100vh}
      .grid2{grid-template-columns:1fr;}
      .formRow{grid-template-columns:1fr;}

      .topbar{flex-wrap:wrap; align-items:flex-start}
      .top-left{flex:1 1 100%}
      .top-right{
        width:100%;
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:10px;
      }
      .cartBtn{justify-content:center; width:100%}
      .shipCountry{width:100%}

      .content{
        padding:14px;
        padding-bottom: calc(14px + env(safe-area-inset-bottom));
      }

      .onlyMobile{display:block;}

      .footer{padding:12px 14px;}
      .footerRow{justify-content:center;}
      .footerLinks{justify-content:center;}

      .cartDrawer,.cartBack,.toast{
        backdrop-filter:none !important;
        -webkit-backdrop-filter:none !important;
      }
    }

    @media (max-width:520px){
      .top-right{grid-template-columns: 1fr;}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand"><span class="dot"></span> Mosaic Pins</div>
        <div class="pill">Reviews</div>
      </div>

      <nav class="sb-nav">
        <a class="nav-item" href="/" id="navShop">Shop</a>
        <a class="nav-item" href="/about" id="navAbout">About</a>
        <a class="nav-item active" href="/reviews" id="navReviews">Reviews</a>
        <a class="nav-item" href="/shipping" id="navShipping">Shipping</a>
        <a class="nav-item" href="/returns" id="navReturns">Returns</a>
      </nav>

      <div class="sb-scroll">
        <div class="sb-card">
          <h3>How it works</h3>
          <p>
            Leave a review ‚Äî it will appear after approval.<br/>
            Rating: 1‚Äì5 stars.
          </p>
        </div>

        <div class="sb-card">
          <h3>Contact</h3>
          <p>
            <a style="color:var(--text); text-decoration:none; opacity:.9" href="mailto:support@mosaicpins.space">
              support@mosaicpins.space
            </a>
          </p>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="top-left">
          <div>
            <h1 class="h-title" id="topTitle">Reviews</h1>
            <div class="sub" id="topSub">Mosaic Pins Space</div>
          </div>
        </div>

        <div class="top-right">
          <button class="cartBtn" id="openCart" type="button" title="Cart">
            üõí Cart <span class="cartBadge" id="cartBadge">0</span>
          </button>

          <select class="shipCountry" id="shipCountry" title="Shipping country">
            <option value="DE">Germany (DE)</option>
            <option value="EU">Europe (EU)</option>
            <option value="US">United States (US)</option>
            <option value="CA">Canada (CA)</option>
          </select>
        </div>
      </div>

      <div class="content">
        <section class="hero">
          <div class="heroRow">
            <div>
              <h2 class="heroTitle">Customer reviews</h2>
              <div class="heroMeta" id="heroMeta">Loading‚Ä¶</div>
            </div>

            <div class="avgBox" aria-label="Average rating">
              <div class="avgNum" id="avgNum">‚Äî</div>
              <div>
                <div class="rStars" id="avgStars" aria-label="Average stars">‚Äî</div>
                <div class="avgSub" id="avgSub">‚Äî</div>
              </div>
            </div>
          </div>
        </section>

        <div class="grid2">
          <section class="panel">
            <div class="panelHead">
              <h3 class="panelTitle">Leave a review</h3>
              <div class="hint">Will be published after approval</div>
            </div>

            <div class="panelBody">
              <div class="formRow">
                <div class="field">
                  <div class="label">Name</div>
                  <input class="input" id="name" placeholder="Your name" maxlength="60" />
                </div>

                <div class="field">
                  <div class="label">Country (optional)</div>
                  <input class="input" id="country" placeholder="Germany, USA‚Ä¶" maxlength="40" />
                </div>
              </div>

              <div class="field">
                <div class="label">Rating</div>
                <div class="starsPick" id="starsPick" aria-label="Choose rating">
                  <div class="ratingText" id="ratingText">Selected: 5/5</div>
                </div>
              </div>

              <div class="field">
                <div class="label">Review text</div>
                <textarea class="textarea" id="text" placeholder="Tell us what you liked‚Ä¶" maxlength="1200"></textarea>
              </div>

              <button class="btn" id="sendBtn" type="button">Send review</button>

              <div style="margin-top:10px; color:var(--muted); font-size:12px;">
                Thank you very much for your feedback! üòâ
              </div>

              <div class="onlyMobile" style="margin-top:12px;">
                <a class="btn2 actionBtn" href="/" aria-label="Back to shop" style="display:flex; text-decoration:none;">
                  ‚Üê Back to Shop
                </a>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panelHead">
              <h3 class="panelTitle">Approved reviews</h3>
              <div class="hint" id="countHint">‚Äî</div>
            </div>

            <div class="panelBody">
              <div class="list" id="list"></div>
            </div>
          </section>
        </div>
      </div>

      <footer class="footer">
        <div class="footerRow">
          <div class="footerBrand">
            <span class="dot" aria-hidden="true"></span>
            <span>¬© <span id="year"></span> Mosaic Pins</span>
          </div>

          <div class="footerLinks" aria-label="Footer links">
            <a href="/index">Shop</a>
            <a href="/about">About</a>
            <a href="/shipping">Shipping</a>
            <a href="/returns">Returns</a>
            <a href="/reviews">Reviews</a>
            <a href="/privacy.html">Privacy Policy</a>
            <a href="/impressum.html">Impressum</a>
            <a href="mailto:mosaicpinsspace@gmail.com">Support</a>
          </div>
        </div>
      </footer>
    </main>
  </div>

  <!-- Lightbox -->
  <div class="lightboxBack" id="lightboxBack"></div>
  <div class="lightbox" id="lightbox">
    <div class="lightboxCard">
      <div class="lbTop">
        <div class="lbPill" id="lbCounter">‚Äî</div>
        <button class="lbClose" id="lbClose" type="button" aria-label="Close">‚úï</button>
      </div>
      <img class="lightboxImg" id="lbImg" alt="Photo large" />
    </div>
  </div>

  <!-- ‚úÖ CART DRAWER (EXACT COPY from About markup) -->
  <div class="cartBack" id="cartBack"></div>
  <div class="cartDrawer" id="cartDrawer">
    <div class="cartHead">
      <div class="cartTitle">Cart</div>
      <button class="cartClose" id="closeCart" type="button">‚úï</button>
    </div>

    <div class="cartBody" id="cartBody"></div>

    <div class="cartFoot">
      <div class="cartSumRow">
        <div>Total</div>
        <div id="cartTotal">‚Äî</div>
      </div>

      <div class="cartActions">
        <div class="actionRow">
          <div class="ppWrap btn2 actionBtn" id="ppWrap">
            <div id="paypal-button-container"></div>
          </div>

          <button class="btn2 actionBtn" id="cartCheckout" type="button">Checkout</button>

          <button class="btn2 actionBtn" id="cartClear" type="button">Clear cart</button>
        </div>

        <div class="ppNote" id="ppNote">PayPal is loading‚Ä¶</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div style="font-weight:800" id="toastTitle">Notice</div>
    <small id="toastMsg">‚Äî</small>
  </div>

  <script id="pp-sdk" data-loaded="0"></script>

  <script>
    (function(){
      const y = document.getElementById("year");
      if (y) y.textContent = new Date().getFullYear();
    })();

    const API_REVIEWS  = "/api/reviews";
    const API_CHECKOUT = "/api/checkout";

    const API_PP_CONFIG  = "/api/paypal/config";
    const API_PP_CREATE  = "/api/paypal/create-order";
    const API_PP_CAPTURE = "/api/paypal/capture";

    const CART_KEY = "mp_cart";
    const MP_CUR_KEY  = "mp_currency";
    const MP_SHIP_KEY = "mp_ship_country";
    const MP_USER_SET_KEY  = "mp_user_set_ship";
    const MP_GEO_CACHE_KEY = "mp_geo_cache";

    const EU_SET = new Set([
      "AT","BE","BG","HR","CY","CZ","DK","EE","FI","FR","DE","GR","HU","IE","IT",
      "LV","LT","LU","MT","NL","PL","PT","RO","SK","SI","ES","SE"
    ]);

    function isEUCountry(code){
      code = String(code||"").toUpperCase();
      return EU_SET.has(code);
    }

    function readCart(){
      try{
        const raw = localStorage.getItem(CART_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(_){ return []; }
    }
    function writeCart(arr){ localStorage.setItem(CART_KEY, JSON.stringify(arr)); }
    function cartCount(){ return readCart().reduce((s,it)=>s+(Number(it?.qty)||0),0); }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    const elToast = document.getElementById("toast");
    const elToastTitle = document.getElementById("toastTitle");
    const elToastMsg = document.getElementById("toastMsg");
    function toast(title, msg){
      elToastTitle.textContent = title;
      elToastMsg.textContent = msg;
      elToast.classList.add("show");
      setTimeout(()=> elToast.classList.remove("show"), 2600);
    }

    const elCartBadge = document.getElementById("cartBadge");
    const elOpenCart = document.getElementById("openCart");
    const elCartBack = document.getElementById("cartBack");
    const elCartDrawer = document.getElementById("cartDrawer");
    const elCloseCart = document.getElementById("closeCart");
    const elCartBody = document.getElementById("cartBody");
    const elCartTotal = document.getElementById("cartTotal");
    const elCartCheckout = document.getElementById("cartCheckout");
    const elCartClear = document.getElementById("cartClear");
    const elShipCountry = document.getElementById("shipCountry");

    const elPpWrap = document.getElementById("ppWrap");
    const elPpNote = document.getElementById("ppNote");

    function updateCartBadge(){ if (elCartBadge) elCartBadge.textContent = String(cartCount()); }

    function getCurrency(){
      const saved = (localStorage.getItem(MP_CUR_KEY) || "").toUpperCase();
      if (saved === "EUR" || saved === "USD") return saved;
      return "USD";
    }
    function setCurrency(cur){
      cur = String(cur || "USD").toUpperCase();
      if (cur !== "EUR" && cur !== "USD") cur = "USD";
      try{ localStorage.setItem(MP_CUR_KEY, cur); }catch(_){}
    }

    function enforceCurrencyByShipping(){
      const ship = String(elShipCountry?.value || "US").toUpperCase();
      const must = (ship === "US" || ship === "CA") ? "USD" : "EUR";
      if (getCurrency() !== must) setCurrency(must);
    }

    function setShipValue(v){
      v = String(v || "US").toUpperCase();
      if (!["DE","EU","US","CA"].includes(v)) v = "US";
      if (elShipCountry) elShipCountry.value = v;
      try{ localStorage.setItem(MP_SHIP_KEY, v); }catch(_){}
      enforceCurrencyByShipping();
      setCurrency(getCurrency());
    }

    function userHasSetShipping(){
      try{ return localStorage.getItem(MP_USER_SET_KEY) === "1"; }catch(_){ return false; }
    }

    function cacheGetShip(){
      try{
        const raw = localStorage.getItem(MP_GEO_CACHE_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !obj.ship || !obj.ts) return null;

        const ts = Number(obj.ts);
        if (!Number.isFinite(ts)) return null;

        const age = Date.now() - ts;
        const maxAge = 7 * 24 * 60 * 60 * 1000;
        if (age > maxAge) return null;

        const ship = String(obj.ship || "").toUpperCase();
        if (!["DE","EU","US","CA"].includes(ship)) return null;

        return ship;
      }catch(_){ return null; }
    }

    function cacheSetShip(ship){
      try{ localStorage.setItem(MP_GEO_CACHE_KEY, JSON.stringify({ ts: Date.now(), ship })); }catch(_){}
    }

    async function detectShipByIP(){
      try{
        const r = await fetch("https://ipwho.is/?fields=success,country_code", { cache: "no-store" });
        const j = await r.json().catch(()=>null);
        if (!j || j.success !== true) return null;

        const cc = String(j.country_code || "").toUpperCase();
        if (!cc) return null;

        if (cc === "DE") return "DE";
        if (cc === "US") return "US";
        if (cc === "CA") return "CA";
        if (isEUCountry(cc)) return "EU";
        return "US";
      }catch(_){ return null; }
    }

    (function restoreSettings(){
      try{
        if (!localStorage.getItem(MP_SHIP_KEY)) localStorage.setItem(MP_SHIP_KEY, "US");
        if (!localStorage.getItem(MP_CUR_KEY))  localStorage.setItem(MP_CUR_KEY, "USD");

        const savedShip = (localStorage.getItem(MP_SHIP_KEY) || "US").toUpperCase();
        if (savedShip && ["DE","EU","US","CA"].includes(savedShip) && elShipCountry){
          elShipCountry.value = savedShip;
        }

        const savedCur = (localStorage.getItem(MP_CUR_KEY) || "USD").toUpperCase();
        if (savedCur && (savedCur === "EUR" || savedCur === "USD")){
          localStorage.setItem(MP_CUR_KEY, savedCur);
        }

        enforceCurrencyByShipping();
        setCurrency(getCurrency());
      }catch(_){}
    })();

    (async function autoDetectShippingOnce(){
      try{
        if (userHasSetShipping()) return;

        const cached = cacheGetShip();
        if (cached){ setShipValue(cached); return; }

        const detected = await detectShipByIP();
        if (!detected) return;

        setShipValue(detected);
        cacheSetShip(detected);
      }catch(_){}
    })();

    function getShippingCountryISO2(){
      const v = String(elShipCountry?.value || "US").toUpperCase();
      if (v === "US") return "US";
      if (v === "CA") return "CA";
      if (v === "EU") return "FR";
      return "DE";
    }

    if (elShipCountry){
      elShipCountry.addEventListener("change", () => {
        try{
          localStorage.setItem(MP_SHIP_KEY, String(elShipCountry.value || "US").toUpperCase());
          localStorage.setItem(MP_USER_SET_KEY, "1");
        }catch(_){}
        enforceCurrencyByShipping();
        setCurrency(getCurrency());
        cacheSetShip(String(elShipCountry.value || "US").toUpperCase());

        resetPayPalHard();

        renderCart();
        toast("Shipping", `Destination: ${elShipCountry.value}`);
      });
    }

    function openCart(){
      elCartBack?.classList.add("show");
      elCartDrawer?.classList.add("show");
      document.body.style.overflow = "hidden";
      renderCart();
      maybeInitPayPal();
    }

    function closeCart(){
      elCartBack?.classList.remove("show");
      elCartDrawer?.classList.remove("show");
      document.body.style.overflow = "";
      // ‚úÖ FIX: PayPal race ‚Äî close() + sequence guard
      closePayPalButtons();
    }

    elOpenCart?.addEventListener("click", openCart);
    elCloseCart?.addEventListener("click", closeCart);
    elCartBack?.addEventListener("click", closeCart);

    window.addEventListener("keydown", (e)=>{
      if (e.key !== "Escape") return;
      const lbOpen = document.getElementById("lightbox")?.classList.contains("show");
      const cartOpen = elCartDrawer?.classList.contains("show");
      if (cartOpen && !lbOpen) closeCart();
    });

    // =========================
    // ‚úÖ PayPal FIX: close() + ppRenderSeq
    // =========================
    let ppReady = false;
    let ppLoading = false;
    let ppRenderedForKey = "";

    let ppButtons = null;     // last Buttons instance
    let ppRenderSeq = 0;      // monotonic render sequence

    function cartSnapshotKey(){
      const cart = readCart();
      const cur = getCurrency();
      const ship = String(elShipCountry?.value || "US").toUpperCase();
      const itemsKey = cart.map(it => `${String(it.pin)}:${Number(it.qty)||1}`).sort().join("|");
      return `${cur}|${ship}|${itemsKey}`;
    }

    function showPayPalNote(msg){
      if (!elPpNote) return;
      elPpNote.textContent = String(msg || "");
      elPpNote.style.display = msg ? "block" : "none";
    }

    async function fetchPayPalClientId(){
      const r = await fetch(API_PP_CONFIG, { method:"GET", cache:"no-store" });
      const j = await r.json().catch(()=>null);
      if (!r.ok || !j?.clientId) throw new Error(j?.error || "PayPal config error");
      return String(j.clientId);
    }

    function clearPayPalButtons(){
      const wrap = document.getElementById("paypal-button-container");
      if (wrap) wrap.innerHTML = "";
    }

    function closePayPalButtons(){
      try{
        if (ppButtons && typeof ppButtons.close === "function"){
          ppButtons.close();
        }
      }catch(_){}
      ppButtons = null;
    }

    function resetPayPalHard(){
      ppReady = false;
      ppLoading = false;
      ppRenderedForKey = "";
      ppRenderSeq++;

      try{ closePayPalButtons(); }catch(_){}
      try{ clearPayPalButtons(); }catch(_){}
      try{ showPayPalNote(""); }catch(_){}

      try{
        const old = document.getElementById("pp-sdk");
        if (old && old.parentNode){
          old.parentNode.removeChild(old);
        }
      }catch(_){}

      try{ delete window.paypal; }catch(_){}
      try{ window.paypal = undefined; }catch(_){}

      try{
        const s = document.createElement("script");
        s.id = "pp-sdk";
        s.setAttribute("data-loaded","0");
        document.body.appendChild(s);
      }catch(_){}
    }

    function loadPayPalSDK(clientId){
      return new Promise((resolve, reject) => {
        try{
          if (window.paypal && typeof window.paypal.Buttons === "function"){
            resolve(true);
            return;
          }

          const s = document.getElementById("pp-sdk");
          if (!s) throw new Error("pp-sdk tag missing");

          const cur = getCurrency();

          const url =
            "https://www.paypal.com/sdk/js" +
            `?client-id=${encodeURIComponent(clientId)}` +
            `&currency=${encodeURIComponent(cur)}` +
            `&intent=capture` +
            `&components=buttons` +
            `&disable-funding=card,sepa,ideal,bancontact,sofort,giropay,eps,mybank,p24,venmo`;

          if (s.src && s.src === url){
            const t0 = Date.now();
            const tick = () => {
              if (window.paypal && typeof window.paypal.Buttons === "function") return resolve(true);
              if (Date.now() - t0 > 12000) return reject(new Error("PayPal SDK timeout"));
              setTimeout(tick, 120);
            };
            tick();
            return;
          }

          if (s.src && s.src !== url){
            resetPayPalHard();
            return loadPayPalSDK(clientId).then(resolve).catch(reject);
          }

          s.onload = () => resolve(true);
          s.onerror = () => reject(new Error("PayPal SDK failed to load"));
          s.src = url;
          s.setAttribute("data-loaded","1");
        }catch(e){
          reject(e);
        }
      });
    }

    async function maybeInitPayPal(){
      try{
        const cart = readCart();
        if (!cart.length){
          if (elPpWrap) elPpWrap.style.display = "none";
          return;
        }
        if (elPpWrap) elPpWrap.style.display = "flex";

        enforceCurrencyByShipping();
        setCurrency(getCurrency());

        if (ppReady){
          renderPayPalButtonsIfNeeded();
          return;
        }
        if (ppLoading) return;

        ppLoading = true;
        showPayPalNote("PayPal is loading‚Ä¶");

        const clientId = await fetchPayPalClientId();
        await loadPayPalSDK(clientId);

        ppReady = true;
        ppLoading = false;

        showPayPalNote("");
        renderPayPalButtonsIfNeeded();
      }catch(e){
        ppLoading = false;
        ppReady = false;
        showPayPalNote(`PayPal unavailable: ${String(e?.message || e)}`);
      }
    }

    function renderPayPalButtonsIfNeeded(){
      if (!ppReady) return;
      if (!window.paypal || typeof window.paypal.Buttons !== "function") return;

      const cart = readCart();
      if (!cart.length){
        closePayPalButtons();
        clearPayPalButtons();
        ppRenderedForKey = "";
        return;
      }

      const key = cartSnapshotKey();
      if (key === ppRenderedForKey) return;

      // ‚úÖ sequence guard: invalidate older renders
      const seq = ++ppRenderSeq;

      closePayPalButtons();
      clearPayPalButtons();
      ppRenderedForKey = key;

      const buttons = window.paypal.Buttons({
        style: { layout:"vertical", shape:"rect", label:"paypal", height: 44 },

        createOrder: async () => {
          const cartNow = readCart();
          if (!cartNow.length) throw new Error("Cart is empty");

          enforceCurrencyByShipping();
          setCurrency(getCurrency());

          const payload = {
            currency: getCurrency(),
            shippingCountry: getShippingCountryISO2(),
            items: cartNow.map(it => ({ pin: String(it.pin), qty: Number(it.qty) || 1 })),
          };

          const r = await fetch(API_PP_CREATE, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(payload),
          });

          const data = await r.json().catch(()=>({}));
          if (!r.ok || !data?.id) throw new Error(data?.error || "PayPal create order failed");
          return data.id;
        },

        onApprove: async (data) => {
          try{
            const orderID = data?.orderID;
            if (!orderID) throw new Error("Missing orderID");

            const r = await fetch(API_PP_CAPTURE, {
              method: "POST",
              headers: { "Content-Type":"application/json" },
              body: JSON.stringify({ orderID }),
            });

            const j = await r.json().catch(()=>({}));
            if (!r.ok || !j?.ok) throw new Error(j?.error || "Capture failed");

            writeCart([]);
            updateCartBadge();
            renderCart();
            toast("PayPal", "Payment success ‚úÖ");
          }catch(e){
            toast("PayPal", String(e?.message || e));
          }
        },

        onCancel: () => toast("PayPal", "Canceled"),
        onError: (err) => toast("PayPal", String(err?.message || err || "PayPal error")),
      });

      // ‚úÖ render with guard (avoid race after close/reset)
      buttons.render("#paypal-button-container").then(() => {
        if (seq !== ppRenderSeq){
          try{ buttons.close(); }catch(_){}
          return;
        }
        ppButtons = buttons;
      }).catch((err)=>{
        if (seq !== ppRenderSeq) return;
        toast("PayPal", String(err?.message || err || "PayPal render error"));
      });
    }

// ==========================
    // Cart logic (Stripe + PayPal) - EXACT from About + PayPal race-safe
    // ==========================
    function setCartQty(pin, qty){
      const cart = readCart();
      const idx = cart.findIndex(x => String(x.pin) === String(pin));
      if (idx < 0) return;

      const stock = Number(cart[idx].stock ?? 0);
      qty = Number(qty);
      if (!Number.isFinite(qty)) qty = 1;
      qty = Math.max(1, qty);
      if (stock > 0) qty = Math.min(stock, qty);

      cart[idx].qty = qty;
      writeCart(cart);
      updateCartBadge();
      renderCart();

      ppRenderedForKey = "";
      renderPayPalButtonsIfNeeded();
    }

    function removeFromCart(pin){
      const cart = readCart().filter(x => String(x.pin) !== String(pin));
      writeCart(cart);
      updateCartBadge();
      renderCart();

      ppRenderedForKey = "";
      renderPayPalButtonsIfNeeded();
    }

    function clearCart(){
      writeCart([]);
      updateCartBadge();
      renderCart();

      ppRenderedForKey = "";
      renderPayPalButtonsIfNeeded();
    }

    function cartTotal(){
      const cur = getCurrency();
      const cart = readCart();
      let sum = 0;
      for (const it of cart){
        const unit = Number(it?.price?.[cur]);
        if (Number.isFinite(unit)) sum += unit * (Number(it?.qty)||0);
      }
      return sum;
    }

    function renderCart(){
      if (!elCartBody || !elCartTotal || !elCartCheckout) return;

      const cart = readCart();

      // show/hide PayPal "button"
      if (elPpWrap) elPpWrap.style.display = cart.length ? "flex" : "none";

      // enable/disable action buttons
      if (elCartCheckout) elCartCheckout.disabled = !cart.length;
      if (elCartClear) elCartClear.disabled = !cart.length;

      if (!cart.length){
        elCartBody.innerHTML = `<div class="cartEmpty">Your cart is empty.</div>`;
        elCartTotal.textContent = "‚Äî";

        // ‚úÖ PayPal cleanup + invalidate pending renders
        closePayPalButtons();
        clearPayPalButtons();
        ppRenderedForKey = "";
        ppRenderSeq++;
        return;
      }

      const cur = getCurrency();

      elCartBody.innerHTML = cart.map(it => {
        const img = it.image
          ? `<img src="${escapeHtml(it.image)}" alt="${escapeHtml(it.title)}" />`
          : `<span>‚Äî</span>`;

        const unit = it?.price?.[cur];
        const unitText = (typeof unit === "number")
          ? (cur==="EUR" ? `${unit.toFixed(2)} ‚Ç¨` : `${unit.toFixed(2)} $`)
          : "‚Äî";

        return `
          <div class="cartItem" data-pin="${escapeHtml(String(it.pin || ""))}">
            <div class="cartImg">${img}</div>
            <div>
              <p class="cartName">${escapeHtml(it.title || it.pin)}</p>
              <div class="cartMeta">${escapeHtml(it.pin)} ‚Ä¢ ${unitText}</div>
              <div class="cartRow">
                <div class="cartQty">
                  <button type="button" data-act="minus">‚àí</button>
                  <input value="${escapeHtml(String(it.qty || 1))}" inputmode="numeric" />
                  <button type="button" data-act="plus">+</button>
                </div>
                <button class="cartRemove" type="button" data-act="remove">‚úï</button>
              </div>
              <div class="cartMeta" style="margin-top:8px;">Stock: ${escapeHtml(it.stock ?? "‚Äî")}</div>
            </div>
          </div>
        `;
      }).join("");

      [...elCartBody.querySelectorAll(".cartItem")].forEach(row => {
        const pin = row.getAttribute("data-pin");
        const input = row.querySelector("input");

        row.querySelector('button[data-act="minus"]')?.addEventListener("click", () => setCartQty(pin, Number(input.value) - 1));
        row.querySelector('button[data-act="plus"]')?.addEventListener("click",  () => setCartQty(pin, Number(input.value) + 1));

        input?.addEventListener("input", () => {
          const v = Number(input.value);
          if (!Number.isFinite(v)) return;
          setCartQty(pin, v);
        });

        row.querySelector('button[data-act="remove"]')?.addEventListener("click", () => removeFromCart(pin));
      });

      const sum = cartTotal();
      elCartTotal.textContent = (cur==="EUR") ? `${sum.toFixed(2)} ‚Ç¨` : `${sum.toFixed(2)} $`;

      // init/render PayPal when cart visible (race-safe)
      maybeInitPayPal();
      renderPayPalButtonsIfNeeded();
    }

    elCartClear?.addEventListener("click", () => { clearCart(); toast("Cart", "Cleared"); });

    // Stripe checkout (same as About)
    async function startCheckout(){
      const cart = readCart();
      if (!cart.length) { toast("Checkout", "Cart is empty"); return; }

      enforceCurrencyByShipping();
      setCurrency(getCurrency());

      try{ localStorage.setItem(MP_SHIP_KEY, String(elShipCountry?.value || "US").toUpperCase()); }catch(_){}

      const payload = {
        currency: getCurrency(),
        shippingCountry: getShippingCountryISO2(),
        items: cart.map(it => ({ pin: String(it.pin), qty: Number(it.qty) || 1 })),
      };

      if (elCartCheckout){
        elCartCheckout.disabled = true;
        elCartCheckout.textContent = "Redirecting‚Ä¶";
      }

      try{
        const r = await fetch(API_CHECKOUT, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload),
        });

        const data = await r.json().catch(()=>({}));
        if (!r.ok || !data?.ok || !data?.url){
          throw new Error(data?.error || "Checkout failed");
        }

        window.location.href = data.url;
      }catch(e){
        toast("Checkout", String(e?.message || e));
        if (elCartCheckout){
          elCartCheckout.disabled = false;
          elCartCheckout.textContent = "Checkout";
        }
      }finally{
        if (elCartCheckout && !elCartCheckout.disabled) elCartCheckout.textContent = "Checkout";
      }
    }
    elCartCheckout?.addEventListener("click", startCheckout);

    // initial cart state
    updateCartBadge();
    renderCart();

    // enforce currency on first load too
    enforceCurrencyByShipping();
    setCurrency(getCurrency());

    // ==========================
    // ‚úÖ Lightbox for review photos
    // ==========================
    const lbBack = document.getElementById("lightboxBack");
    const lb = document.getElementById("lightbox");
    const lbImg = document.getElementById("lbImg");
    const lbClose = document.getElementById("lbClose");
    const lbCounter = document.getElementById("lbCounter");

    function openPhoto(url){
      if (!url) return;
      lbImg.src = url;
      lbCounter.textContent = "Photo";
      lbBack.classList.add("show");
      lb.classList.add("show");
      document.body.style.overflow = "hidden";
    }
    function closePhoto(){
      lbBack.classList.remove("show");
      lb.classList.remove("show");
      document.body.style.overflow = "";
    }
    lbClose.addEventListener("click", closePhoto);
    lbBack.addEventListener("click", closePhoto);

    window.addEventListener("keydown", (e)=>{
      if (lb.classList.contains("show") && e.key === "Escape") closePhoto();
    });

    // ==========================
    // ‚úÖ Active state for LEFT sidebar ONLY
    // ==========================
    (function navActive(){
      const path = (window.location.pathname || "/").toLowerCase();

      const idsDesktop = ["navShop","navAbout","navShipping","navReturns","navReviews"];
      idsDesktop.forEach(id => document.getElementById(id)?.classList.remove("active"));

      const set = (id) => document.getElementById(id)?.classList.add("active");

      if (path.startsWith("/shipping")) { set("navShipping"); }
      else if (path.startsWith("/returns")) { set("navReturns"); }
      else if (path.startsWith("/reviews")) { set("navReviews"); }
      else if (path.startsWith("/about")) { set("navAbout"); }
      else { set("navShop"); }
    })();

    // ==========================
    // Reviews helpers (unchanged)
    // ==========================
    function starsText(r){
      r = Number(r)||0;
      let s = "";
      for (let i=1;i<=5;i++) s += (i<=r ? "‚òÖ" : "‚òÜ");
      return s;
    }
    function starsEl(r){
      const div = document.createElement("div");
      div.className = "rStars";
      div.setAttribute("aria-label", `${r} stars`);
      div.textContent = starsText(r);
      return div;
    }

    const starsPick  = document.getElementById("starsPick");
    const ratingText = document.getElementById("ratingText");
    let rating = 5;

    function renderPicker(){
      if (!starsPick) return;
      starsPick.querySelectorAll("button.starBtn").forEach(x => x.remove());
      for (let i=1;i<=5;i++){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "starBtn" + (i<=rating ? " active" : "");
        b.textContent = "‚òÖ";
        b.setAttribute("aria-label", `${i} stars`);
        b.addEventListener("click", () => {
          rating = i;
          if (ratingText) ratingText.textContent = `Selected: ${rating}/5`;
          renderPicker();
        });
        starsPick.insertBefore(b, ratingText);
      }
      if (ratingText) ratingText.textContent = `Selected: ${rating}/5`;
    }
    renderPicker();

    const elList    = document.getElementById("list");
    const heroMeta  = document.getElementById("heroMeta");
    const countHint = document.getElementById("countHint");

    const avgNum    = document.getElementById("avgNum");
    const avgStars  = document.getElementById("avgStars");
    const avgSub    = document.getElementById("avgSub");

    function fmtDate(value){
      if (!value) return "";
      const d = new Date(value);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
    }

function calcAverage(items){
    const arr = (items||[]).map(x => Number(x.rating)).filter(n => Number.isFinite(n) && n>=1 && n<=5);
    if (!arr.length) return { avg:null, count:0 };
    const sum = arr.reduce((a,b)=>a+b,0);
    return { avg: sum/arr.length, count: arr.length };
  }

  function reviewCard(r){
    const wrap = document.createElement("div");
    wrap.className = "review";

    const top = document.createElement("div");
    top.className = "rTop";

    const left = document.createElement("div");
    const name = document.createElement("p");
    name.className = "rName";
    name.textContent = r.name || "Anonymous";

    const date = document.createElement("div");
    date.className = "rDate";
    const country = (r.country ? ` ‚Ä¢ ${r.country}` : "");
    date.textContent = `${fmtDate(r.createdAt || r.date || "")}${country}`;

    left.appendChild(name);
    left.appendChild(date);

    const right = starsEl(r.rating || 0);

    top.appendChild(left);
    top.appendChild(right);

    const text = document.createElement("p");
    text.className = "rText";
    text.textContent = r.text || "";

    wrap.appendChild(top);
    wrap.appendChild(text);

    if (Array.isArray(r.photos) && r.photos.length){
      const ph = document.createElement("div");
      ph.className = "rPhotos";
      r.photos.slice(0, 12).forEach(url => {
        const box = document.createElement("div");
        box.className = "rPhoto";
        box.innerHTML = `<img src="${escapeHtml(url)}" alt="Photo" loading="lazy" />`;
        box.addEventListener("click", ()=> openPhoto(url));
        ph.appendChild(box);
      });
      wrap.appendChild(ph);
    }

    return wrap;
  }

  async function loadReviews(){
    if (heroMeta) heroMeta.textContent = "Loading‚Ä¶";
    if (elList) elList.innerHTML = "";

    try{
      const r = await fetch(API_REVIEWS, { method:"GET", cache:"no-store" });
      const data = await r.json().catch(()=>({}));
      if (!r.ok) throw new Error(data?.error || "Failed to load reviews");

      const items = Array.isArray(data?.reviews) ? data.reviews : [];
      const { avg, count } = calcAverage(items);

      const total = items.length;

      if (heroMeta){
        heroMeta.textContent = total
          ? `Showing approved reviews from customers.`
          : `No approved reviews yet. Be the first üôÇ`;
      }
      if (countHint) countHint.textContent = total ? `${total} reviews` : "‚Äî";

      if (avg == null){
        if (avgNum) avgNum.textContent = "‚Äî";
        if (avgStars) avgStars.textContent = "‚Äî";
        if (avgSub) avgSub.textContent = "No ratings yet";
      } else {
        if (avgNum) avgNum.textContent = avg.toFixed(2);
        if (avgStars) avgStars.textContent = starsText(Math.round(avg));
        if (avgSub) avgSub.textContent = `${count} ratings`;
      }

      if (!items.length){
        if (elList){
          elList.innerHTML = `<div class="empty">No reviews yet. Your review will appear after approval.</div>`;
        }
        return;
      }

      items.sort((a,b) => {
        const ad = new Date(a.createdAt || a.date || 0).getTime() || 0;
        const bd = new Date(b.createdAt || b.date || 0).getTime() || 0;
        return bd - ad;
      });

      items.forEach(it => elList?.appendChild(reviewCard(it)));
    }catch(e){
      if (heroMeta) heroMeta.textContent = "Failed to load reviews.";
      if (elList){
        elList.innerHTML = `<div class="empty">Error: ${escapeHtml(String(e?.message || e))}</div>`;
      }
      toast("Reviews", String(e?.message || e));
    }
  }

  // ==========================
  // Submit review
  // ==========================
  const elName    = document.getElementById("name");
  const elCountry = document.getElementById("country");
  const elText    = document.getElementById("text");
  const elSend    = document.getElementById("sendBtn");

  function validate(){
    const name = (elName?.value || "").trim();
    const text = (elText?.value || "").trim();
    if (name.length < 2) return "Name is too short";
    if (rating < 1 || rating > 5) return "Rating must be 1..5";
    if (text.length < 10) return "Text is too short (min 10 chars)";
    return null;
  }

  async function sendReview(){
    const err = validate();
    if (err){ toast("Review", err); return; }

    const payload = {
      name: (elName.value || "").trim(),
      country: (elCountry.value || "").trim(),
      rating: rating,
      text: (elText.value || "").trim(),
      source: "site",
    };

    if (elSend){
      elSend.disabled = true;
      elSend.textContent = "Sending‚Ä¶";
    }

    try{
      const r = await fetch(API_REVIEWS, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
      });
      const data = await r.json().catch(()=>({}));
      if (!r.ok || !data?.ok){
        throw new Error(data?.error || "Failed to send review");
      }

      toast("Review", "Sent ‚úÖ Waiting for approval");
      if (elText) elText.value = "";
      loadReviews();
    }catch(e){
      toast("Review", String(e?.message || e));
    }finally{
      if (elSend){
        elSend.disabled = false;
        elSend.textContent = "Send review";
      }
    }
  }

  elSend?.addEventListener("click", sendReview);

  elText?.addEventListener("keydown", (e)=>{
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") sendReview();
  });

  // init
  loadReviews();
</script>
</body>
</html>