<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mosaic Pins</title>
  <style>
    :root{
      --bg:#0b0d11;
      --text:#e9eef7;
      --muted:#a8b3c7;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 30px rgba(0,0,0,.45);
      --r:18px;

      --overlay: rgba(0,0,0,.72);
      --overlay2: rgba(0,0,0,.82);
      --panel: rgba(0,0,0,.28);
      --panelHover: rgba(255,255,255,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color:var(--text);
      overflow:hidden;
      position:relative;
      isolation:isolate;
    }

    body::before{
      content:"";
      position:fixed;
      inset:-20vh -20vw;
      z-index:-1;
      pointer-events:none;
      background:
        radial-gradient(1100px 700px at 35% -10%, rgba(50,220,150,.25), transparent 55%),
        radial-gradient(900px 600px at 75% 10%, rgba(120,90,255,.22), transparent 55%),
        var(--bg);
      filter: blur(18px) saturate(1.05);
      transform: translateZ(0);
      will-change: transform;
    }

    *{
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.18) rgba(0,0,0,.25);
    }
    *::-webkit-scrollbar{width:10px;height:10px}
    *::-webkit-scrollbar-track{background:rgba(0,0,0,.25); border-radius:999px}
    *::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18); border-radius:999px; border:2px solid rgba(0,0,0,.25)}
    *::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.25)}

    .app{display:grid; grid-template-columns: 280px 1fr; height:100vh; gap:16px; padding:16px;}

    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;

      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .sb-top{
      padding:18px 18px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex:0 0 auto;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px;}
    .dot{width:10px;height:10px;border-radius:50%; background:linear-gradient(135deg,#22c55e,#60a5fa);}
    .pill{
      padding:8px 10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .sb-nav{padding:6px; display:grid; gap:6px; flex:0 0 auto;}
    .nav-item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:12px;
      color:var(--muted);
      text-decoration:none;
      border:1px solid transparent;
    }
    .nav-item:hover{background:rgba(255,255,255,.05); color:var(--text);}
    .nav-item.active{
      background:rgba(34,197,94,.12);
      border-color: rgba(34,197,94,.22);
      color:var(--text);
    }

    .sb-scroll{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding:6px 6px 10px;
      position:relative;
    }

    .sb-scroll:before,
    .sb-scroll:after{
      content:"";
      position:sticky;
      left:0; right:0;
      height:14px;
      pointer-events:none;
      z-index:2;
      display:block;
    }
    .sb-scroll:before{
      top:0;
      background: linear-gradient(180deg, rgba(11,13,17,.95), rgba(11,13,17,0));
    }
    .sb-scroll:after{
      bottom:0;
      background: linear-gradient(0deg, rgba(11,13,17,.95), rgba(11,13,17,0));
    }

    .sb-section{
      padding:14px 12px 10px;
      display:flex; align-items:center; justify-content:space-between;
      color:var(--muted);
      font-size:12px;
      letter-spacing:.6px;
      text-transform:uppercase;
    }

    .selectedWrap{padding:0 6px 10px; display:none;}
    .selectedBar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(34,197,94,.25);
      background:rgba(34,197,94,.10);
    }
    .selectedLeft{min-width:0;}
    .selectedTitle{font-size:12px; font-weight:900; color:var(--text); margin:0 0 4px; letter-spacing:.2px;}
    .selectedList{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px;}
    .clearBtn{
      flex:0 0 auto;
      border:none;
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:900;
      line-height:1;
    }
    .clearBtn:hover{background:rgba(255,255,255,.06)}

    .list{display:grid; gap:6px; padding:0 0 10px;}
    .item{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .item:hover{background:rgba(255,255,255,.05)}
    .item small{display:block; color:var(--muted); margin-top:4px}
    .item.active{background:rgba(34,197,94,.12); border-color: rgba(34,197,94,.22);}

    .main{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .topbar{
      padding: calc(16px + env(safe-area-inset-top)) 18px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
      flex:0 0 auto;
    }
    .top-left{display:flex; align-items:center; gap:10px; min-width:0}
    .h-title{font-weight:900; font-size:18px; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .sub{color:var(--muted); font-size:12px; margin-top:4px}

    .search{
      flex:1; max-width:520px; min-width:220px;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      min-height:44px;
    }
    .search input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:14px;
    }
    .top-right{display:flex; align-items:center; gap:10px}

    .filtersBtn,.cartBtn,.toggle,.currency,.shipCountry{
      min-height:44px;
      line-height:1.1;
      align-items:center;
    }

    .toggle{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
      user-select:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .toggle input{accent-color:#22c55e; width:16px; height:16px}
    .currency,.shipCountry{
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-size:13px;
      outline:none;
      white-space:nowrap;
      appearance:none;
    }

    .filtersBtn{
      display:none;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.28);
      border:1px solid var(--line);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
    }
    .filtersBtn:hover{background:rgba(255,255,255,.06)}
    .filtersBadge{
      padding:4px 8px;
      border-radius:999px;
      background:rgba(34,197,94,.18);
      border:1px solid rgba(34,197,94,.25);
      color:var(--text);
      font-size:12px;
      font-weight:900;
      line-height:1;
    }

    .cartBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.28);
      border:1px solid var(--line);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
    }
    .cartBtn:hover{background:rgba(255,255,255,.06)}
    .cartBadge{
      padding:4px 8px;
      border-radius:999px;
      background:rgba(34,197,94,.18);
      border:1px solid rgba(34,197,94,.25);
      color:var(--text);
      font-size:12px;
      font-weight:900;
      line-height:1;
      min-width:24px;
      text-align:center;
    }

    .content{padding:18px; overflow:auto; min-height:0;}
    .grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:14px;
    }
    @media (max-width:1200px){ .grid{grid-template-columns:repeat(4,1fr)} }

    /* ====== MOBILE LAYOUT ====== */
    @media (max-width:980px){
      body{overflow:auto}
      .app{grid-template-columns:1fr; height:auto; min-height:100vh}
      .sidebar{display:none}
      .main{height:auto; min-height:100vh}

      .topbar{flex-wrap:wrap; gap:10px}
      .top-left{width:100%}

      .search{order:3; width:100%; max-width:none; min-width:0}

      .top-right{
        order:2;
        width:100%;
        justify-content:flex-start;
        flex-wrap:wrap;
        gap:10px;
      }
      .top-right > *{flex: 1 1 auto}
      .filtersBtn,.cartBtn,.currency,.toggle,.shipCountry{justify-content:center}

      .filtersBtn{display:inline-flex}
      .content{padding:14px}

      .main{padding-bottom: env(safe-area-inset-bottom);}
      .grid{grid-template-columns:repeat(2, minmax(0, 1fr)); gap:12px}
    }
    @media (max-width:520px){
      .grid{grid-template-columns:1fr}
      .top-right > *{flex: 1 1 48%}
      .currency{flex:1 1 48%}
      .shipCountry{flex:1 1 48%}
    }

    .card{
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
      transition: transform .15s ease, background .15s ease;
      cursor:pointer;
    }
    .card:hover{transform: translateY(-2px); background:rgba(255,255,255,.04)}
    .thumb{
      aspect-ratio: 1/1;
      background:linear-gradient(135deg, rgba(34,197,94,.14), rgba(96,165,250,.10));
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .badge{
      position:absolute; left:10px; top:10px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.55);
      color:var(--text);
      backdrop-filter: blur(10px);
    }
    .sold{background:rgba(239,68,68,.22); border-color:rgba(239,68,68,.28)}
    .meta{padding:12px}
    .name{font-weight:800; font-size:14px; margin:0 0 6px}
    .desc{
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
      min-height: 32px;
      white-space: pre-line;
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px}
    .price{font-weight:900}
    .btn{
      border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#07110b;
      font-weight:900;
      box-shadow: 0 10px 18px rgba(34,197,94,.18);
      transition: filter .15s ease, transform .15s ease;
      white-space:nowrap;
    }
    .btn:hover{filter:brightness(1.05); transform: translateY(-1px)}
    .btn:disabled{
      cursor:not-allowed;
      background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.55);
      box-shadow:none;
    }

    .btn2{
      border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:900;
      transition: background .15s ease, transform .15s ease;
      white-space:nowrap;
    }
    .btn2:hover{background:rgba(255,255,255,.10); transform: translateY(-1px)}
    .btn2:disabled{opacity:.45; cursor:not-allowed}

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(0,0,0,.65);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 14px;
      color: var(--text);
      box-shadow: var(--shadow);
      max-width: 360px;
      display:none;
      z-index:999;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:block}
    .toast small{color:var(--muted)}

    /* Mobile Filters Sheet */
    .sheetBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.72);
      display:none;
      z-index:1000;
      backdrop-filter: blur(6px);
    }
    .sheetBack.show{display:block}

    .sheet{
      position:fixed;
      left:0; right:0; bottom:0;
      border-top-left-radius:18px;
      border-top-right-radius:18px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,0,0,.92), rgba(0,0,0,.78));
      box-shadow: 0 -18px 40px rgba(0,0,0,.55);
      transform: translateY(100%);
      transition: transform .18s ease;
      z-index:1001;

      max-height: 82vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .sheet.show{transform: translateY(0)}
    .sheetHead{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
    }
    .sheetTitle{font-weight:950; letter-spacing:.2px;}
    .sheetClose{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.30);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:950;
      line-height:1;
    }
    .sheetClose:hover{background:rgba(255,255,255,.06)}
    .sheetBody{padding:12px; overflow:auto; min-height:0;}
    .mSelectedWrap{display:none; margin-bottom:10px;}
    .mList .item{padding:12px 12px; border-radius:14px;}

    /* Cart Drawer */
    .cartBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.74);
      display:none;
      z-index:1100;
      backdrop-filter: blur(6px);
    }
    .cartBack.show{display:block}
    .cartDrawer{
      position:fixed;
      top:0; right:0; bottom:0;
      width:min(420px, 92vw);
      border-left:1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,0,0,.92), rgba(0,0,0,.78));
      box-shadow: -18px 0 40px rgba(0,0,0,.60);
      transform: translateX(100%);
      transition: transform .18s ease;
      z-index:1101;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .cartDrawer.show{transform: translateX(0)}
    .cartHead{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
    }
    .cartTitle{font-weight:950; letter-spacing:.2px;}
    .cartClose{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.30);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:950;
      line-height:1;
    }
    .cartClose:hover{background:rgba(255,255,255,.06)}
    .cartBody{padding:12px; overflow:auto; min-height:0;}
    .cartEmpty{
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.04);
      color:var(--muted);
    }
    .cartItem{
      display:grid;
      grid-template-columns:64px 1fr;
      gap:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      margin-bottom:10px;
    }
    .cartImg{
      width:64px;height:64px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      color:var(--muted);
      font-size:12px;
    }
    .cartImg img{width:100%;height:100%;object-fit:cover;display:block;}
    .cartName{font-weight:900; font-size:13px; margin:0}
    .cartMeta{color:var(--muted); font-size:12px; margin:4px 0 0}
    .cartRow{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px;}
    .cartQty{
      display:flex; align-items:center; gap:6px;
      padding:6px 8px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
    }
    .cartQty button{
      width:30px;height:30px;border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .cartQty input{
      width:44px;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      text-align:center;
      font-weight:900;
    }
    .cartRemove{
      border:none;
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:900;
      line-height:1;
    }
    .cartRemove:hover{background:rgba(255,255,255,.06)}
    .cartFoot{
      padding:12px;
      border-top:1px solid var(--line);
      background:rgba(0,0,0,.40);
    }
    .cartSumRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px; color:var(--text); font-weight:950;
    }

    /* =========================
       ‚úÖ NEW: 3 buttons in a row –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (–∫–∞–∫ Clear cart)
       PayPal / Checkout / Clear cart
       ========================= */
    .cartActions{display:grid; gap:10px;}

    .actionRow{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      align-items:stretch;
    }
    .actionBtn{
      width:100%;
      min-height:44px;
      height:44px;
      padding:0 12px;
      line-height:44px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden; /* –≤–∞–∂–Ω–æ –¥–ª—è PayPal iframe */
    }

    /* PayPal wrapper –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –æ–±—ã—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
    .ppWrap{
      display:none; /* –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∫–æ—Ä–∑–∏–Ω–∞ –Ω–µ –ø—É—Å—Ç–∞—è */
      padding:0;
    }
    #paypal-button-container{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* note under row */
    .ppNote{
      color:var(--muted);
      font-size:12px;
      margin-top:0;
      line-height:1.35;
      display:none;
      text-align:center;
    }

    @media (max-width:520px){
      .actionRow{grid-template-columns:1fr;}
      .actionBtn{height:46px; min-height:46px; line-height:46px;}
    }

    /* Footer */
    .footer{
      margin-top:auto;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.25);
      padding:14px 18px;
      flex: 0 0 auto;
    }
    .footerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .footerBrand{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .footerLinks{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .footerLinks a{
      text-decoration:none;
      color:var(--muted);
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      transition: background .15s ease, transform .15s ease;
      white-space:nowrap;
    }
    .footerLinks a:hover{
      background:rgba(255,255,255,.08);
      transform: translateY(-1px);
      color:var(--text);
    }
    @media (max-width:980px){
      .footer{padding:12px 14px;}
      .footerRow{justify-content:center;}
      .footerLinks{justify-content:center;}
    }
  </style>
  
/* ‚úÖ Checkout green (only this button) */
#cartCheckout{
  background: linear-gradient(135deg,#22c55e,#16a34a);
  color:#07110b;
  border:none;
  box-shadow: 0 10px 18px rgba(34,197,94,.18);
}

#cartCheckout:hover{
  filter: brightness(1.05);
  transform: translateY(-1px);
}

#cartCheckout:disabled{
  background: rgba(255,255,255,.10);
  color: rgba(255,255,255,.55);
  box-shadow:none;
  transform:none;
}  
</style>  
</head>
<body>

  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand"><span class="dot"></span> Mosaic Pins</div>
        <div class="pill" id="sbCount">‚Äî items</div>
      </div>

      <nav class="sb-nav">
        <a class="nav-item active" href="/" id="navShop">Shop</a>
        <a class="nav-item" href="/about" id="navAbout">About</a>
        <a class="nav-item" href="/shipping" id="navShipping">Shipping</a>
        <a class="nav-item" href="/returns" id="navReturns">Returns</a>
        <a class="nav-item" href="/reviews" id="navReviews">Reviews</a>
      </nav>

      <div class="sb-scroll">
        <div class="sb-section">
          <span>√ò</span>
          <span class="pill" id="diaCount">0</span>
        </div>

        <div class="selectedWrap" id="selectedWrap">
          <div class="selectedBar">
            <div class="selectedLeft">
              <div class="selectedTitle">Selected</div>
              <div class="selectedList" id="selectedList">‚Äî</div>
            </div>
            <button class="clearBtn" id="clearDiameters" title="Clear" type="button">‚úï</button>
          </div>
        </div>

        <div class="list" id="diameters"></div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="top-left">
          <div>
            <h1 class="h-title">Mosaic Pins Space</h1>
            <div class="sub">High-quality handcrafted mosaic pins for knife handles</div>
          </div>
        </div>

        <div class="search" title="Search by title or PIN code">
          <span style="color:var(--muted);">‚åï</span>
          <input id="q" placeholder="Search pins (e.g. G10N11gt, Mosaic, Brass‚Ä¶)" />
        </div>

        <div class="top-right">
          <button class="filtersBtn" id="openFilters" type="button" title="Filters">
            Filters <span class="filtersBadge" id="filtersBadge">0</span>
          </button>

          <button class="cartBtn" id="openCart" type="button" title="Cart">
            üõí Cart <span class="cartBadge" id="cartBadge">0</span>
          </button>

          <label class="toggle" title="Show only in-stock pins">
            <input id="inStockOnly" type="checkbox" />
            In stock
          </label>

          <select class="currency" id="currency" title="Currency">
            <option value="EUR">EUR ‚Ç¨</option>
            <option value="USD">USD $</option>
          </select>

          <select class="shipCountry" id="shipCountry" title="Shipping country">
            <option value="DE">Germany (DE)</option>
            <option value="EU">Europe (EU)</option>
            <option value="US">United States (US)</option>
            <option value="CA">Canada (CA)</option>
          </select>
        </div>
      </div>

      <div class="content">
        <div class="grid" id="grid"></div>
      </div>

      <footer class="footer">
        <div class="footerRow">
          <div class="footerBrand">
            <span class="dot" aria-hidden="true"></span>
            <span>¬© <span id="year"></span> Mosaic Pins</span>
          </div>

          <div class="footerLinks" aria-label="Footer links">
            <a href="/index.html">Shop</a>
            <a href="/about">About</a>
            <a href="/shipping">Shipping</a>
            <a href="/returns">Returns & Refunds</a>
            <a href="/reviews">Reviews</a>
            <a href="/impressum.html">Impressum</a>
            <a href="/privacy.html">Privacy Policy</a>
            <a href="mailto:mosaicpinsspace@gmail.com">Support</a>
          </div>
        </div>
      </footer>
    </main>
  </div>

  <div class="sheetBack" id="sheetBack"></div>
  <div class="sheet" id="sheet">
    <div class="sheetHead">
      <div class="sheetTitle">Filters</div>
      <button class="sheetClose" id="closeFilters" type="button">‚úï</button>
    </div>
    <div class="sheetBody">
      <div class="mSelectedWrap" id="mSelectedWrap">
        <div class="selectedBar">
          <div class="selectedLeft">
            <div class="selectedTitle">Selected</div>
            <div class="selectedList" id="mSelectedList">‚Äî</div>
          </div>
          <button class="clearBtn" id="mClearDiameters" title="Clear" type="button">‚úï</button>
        </div>
      </div>

      <div class="sb-section" style="padding:10px 2px 8px;">
        <span>Diameter (√ò)</span>
        <span class="pill" id="mDiaCount">0</span>
      </div>

      <div class="list mList" id="mDiameters"></div>
    </div>
  </div>

  <div class="cartBack" id="cartBack"></div>
  <div class="cartDrawer" id="cartDrawer">
    <div class="cartHead">
      <div class="cartTitle">Cart</div>
      <button class="cartClose" id="closeCart" type="button">‚úï</button>
    </div>

    <div class="cartBody" id="cartBody"></div>

    <div class="cartFoot">
      <div class="cartSumRow">
        <div>Total</div>
        <div id="cartTotal">‚Äî</div>
      </div>

      <div class="cartActions">

        <!-- ‚úÖ NEW: 3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥ (–∫–∞–∫ Clear cart) -->
        <div class="actionRow">
          <!-- PayPal button as "button" -->
          <div class="ppWrap btn2 actionBtn" id="ppWrap">
            <div id="paypal-button-container"></div>
          </div>

          <!-- Stripe Checkout -->
          <button class="btn2 actionBtn" id="cartCheckout" type="button">Checkout</button>

          <!-- Clear cart -->
          <button class="btn2 actionBtn" id="cartClear" type="button">Clear cart</button>
        </div>

        <!-- note under row -->
        <div class="ppNote" id="ppNote">PayPal is loading‚Ä¶</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div style="font-weight:800" id="toastTitle">Notice</div>
    <small id="toastMsg">‚Äî</small>
  </div>

  <!-- PayPal SDK placeholder -->
  <script id="pp-sdk" data-loaded="0"></script>

  <script>
    // footer year
    document.getElementById("year").textContent = String(new Date().getFullYear());

    const API_PRODUCTS = "/api/products";
    const API_CHECKOUT = "/api/checkout";

    // PayPal endpoints
    const API_PP_CONFIG  = "/api/paypal/config";       // returns { clientId }
    const API_PP_CREATE  = "/api/paypal/create-order"; // returns { id }
    const API_PP_CAPTURE = "/api/paypal/capture";      // returns capture result

    const CART_KEY = "mp_cart";

    // persisted settings
    const MP_CUR_KEY  = "mp_currency";
    const MP_SHIP_KEY = "mp_ship_country";

    // user override + geo cache (7 days)
    const MP_USER_SET_KEY  = "mp_user_set_ship";
    const MP_GEO_CACHE_KEY = "mp_geo_cache";

    const EU_SET = new Set([
      "AT","BE","BG","HR","CY","CZ","DK","EE","FI","FR","DE","GR","HU","IE","IT",
      "LV","LT","LU","MT","NL","PL","PT","RO","SK","SI","ES","SE"
    ]);

    function isEUCountry(code){
      code = String(code||"").toUpperCase();
      return EU_SET.has(code);
    }

    function readCart(){
      try{
        const raw = localStorage.getItem(CART_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(_){ return []; }
    }
    function writeCart(arr){ localStorage.setItem(CART_KEY, JSON.stringify(arr)); }
    function cartCount(){ return readCart().reduce((s,it)=>s+(Number(it?.qty)||0),0); }

    let products = [];
    let filtered = [];

    const selectedDiameters = new Set();
    let diameterMap = new Map();

    // refs
    const elGrid = document.getElementById("grid");
    const elQ = document.getElementById("q");
    const elStock = document.getElementById("inStockOnly");
    const elCurrency = document.getElementById("currency");
    const elShipCountry = document.getElementById("shipCountry");
    const elSbCount = document.getElementById("sbCount");

    const elDiaCount = document.getElementById("diaCount");
    const elDiameters = document.getElementById("diameters");
    const elSelectedWrap = document.getElementById("selectedWrap");
    const elSelectedList = document.getElementById("selectedList");
    const elClearDiameters = document.getElementById("clearDiameters");

    const elOpenFilters = document.getElementById("openFilters");
    const elFiltersBadge = document.getElementById("filtersBadge");
    const elSheetBack = document.getElementById("sheetBack");
    const elSheet = document.getElementById("sheet");
    const elCloseFilters = document.getElementById("closeFilters");
    const elMDiaCount = document.getElementById("mDiaCount");
    const elMDiameters = document.getElementById("mDiameters");
    const elMSelectedWrap = document.getElementById("mSelectedWrap");
    const elMSelectedList = document.getElementById("mSelectedList");
    const elMClearDiameters = document.getElementById("mClearDiameters");

    const elOpenCart = document.getElementById("openCart");
    const elCartBadge = document.getElementById("cartBadge");
    const elCartBack = document.getElementById("cartBack");
    const elCartDrawer = document.getElementById("cartDrawer");
    const elCloseCart = document.getElementById("closeCart");
    const elCartBody = document.getElementById("cartBody");
    const elCartTotal = document.getElementById("cartTotal");

    const elCartCheckout = document.getElementById("cartCheckout");
    const elCartClear = document.getElementById("cartClear");

    // PayPal
    const elPpWrap = document.getElementById("ppWrap");
    const elPpNote = document.getElementById("ppNote");

    const elToast = document.getElementById("toast");
    const elToastTitle = document.getElementById("toastTitle");
    const elToastMsg = document.getElementById("toastMsg");

    function toast(title, msg){
      elToastTitle.textContent = title;
      elToastMsg.textContent = msg;
      elToast.classList.add("show");
      setTimeout(()=> elToast.classList.remove("show"), 2600);
    }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function getCurrency(){
      const saved = (localStorage.getItem(MP_CUR_KEY) || "").toUpperCase();
      if (saved === "EUR" || saved === "USD") return saved;
      return "USD";
    }
    function setCurrency(cur){
      cur = String(cur || "USD").toUpperCase();
      if (cur !== "EUR" && cur !== "USD") cur = "USD";
      try{ localStorage.setItem(MP_CUR_KEY, cur); }catch(_){}
      if (elCurrency) elCurrency.value = cur;
    }

    // hard rule: US/CA => USD, DE/EU => EUR
    function enforceCurrencyByShipping(){
      const ship = String(elShipCountry?.value || "US").toUpperCase();
      const must = (ship === "US" || ship === "CA") ? "USD" : "EUR";
      if (getCurrency() !== must) setCurrency(must);
    }

    function setShipValue(v){
      v = String(v || "US").toUpperCase();
      if (!["DE","EU","US","CA"].includes(v)) v = "US";
      if (elShipCountry) elShipCountry.value = v;
      try{ localStorage.setItem(MP_SHIP_KEY, v); }catch(_){}
      enforceCurrencyByShipping();
      setCurrency(getCurrency());
    }

    function userHasSetShipping(){
      try{ return localStorage.getItem(MP_USER_SET_KEY) === "1"; }catch(_){ return false; }
    }

    function cacheGetShip(){
      try{
        const raw = localStorage.getItem(MP_GEO_CACHE_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !obj.ship || !obj.ts) return null;

        const ts = Number(obj.ts);
        if (!Number.isFinite(ts)) return null;

        const age = Date.now() - ts;
        const maxAge = 7 * 24 * 60 * 60 * 1000;
        if (age > maxAge) return null;

        const ship = String(obj.ship || "").toUpperCase();
        if (!["DE","EU","US","CA"].includes(ship)) return null;

        return ship;
      }catch(_){ return null; }
    }

    function cacheSetShip(ship){
      try{ localStorage.setItem(MP_GEO_CACHE_KEY, JSON.stringify({ ts: Date.now(), ship })); }catch(_){}
    }

    async function detectShipByIP(){
      try{
        const r = await fetch("https://ipwho.is/?fields=success,country_code", { cache: "no-store" });
        const j = await r.json().catch(()=>null);
        if (!j || j.success !== true) return null;

        const cc = String(j.country_code || "").toUpperCase();
        if (!cc) return null;

        if (cc === "DE") return "DE";
        if (cc === "US") return "US";
        if (cc === "CA") return "CA";
        if (isEUCountry(cc)) return "EU";
        return "US";
      }catch(_){ return null; }
    }

    // restore persisted selects
    (function restoreSettings(){
      try{
        if (!localStorage.getItem(MP_SHIP_KEY)) localStorage.setItem(MP_SHIP_KEY, "US");
        if (!localStorage.getItem(MP_CUR_KEY))  localStorage.setItem(MP_CUR_KEY, "USD");

        const savedShip = (localStorage.getItem(MP_SHIP_KEY) || "US").toUpperCase();
        if (savedShip && ["DE","EU","US","CA"].includes(savedShip) && elShipCountry){
          elShipCountry.value = savedShip;
        }

        const savedCur = (localStorage.getItem(MP_CUR_KEY) || "USD").toUpperCase();
        if (savedCur && (savedCur === "EUR" || savedCur === "USD") && elCurrency){
          elCurrency.value = savedCur;
        }

        enforceCurrencyByShipping();
        setCurrency(getCurrency());
      }catch(_){}
    })();

    // auto detect shipping once
    (async function autoDetectShippingOnce(){
      try{
        if (userHasSetShipping()) return;

        const cached = cacheGetShip();
        if (cached){ setShipValue(cached); return; }

        const detected = await detectShipByIP();
        if (!detected) return;

        setShipValue(detected);
        cacheSetShip(detected);
      }catch(_){}
    })();

    // UI selection -> ISO2 for API
    function getShippingCountryISO2(){
      const v = String(elShipCountry?.value || "US").toUpperCase();
      if (v === "US") return "US";
      if (v === "CA") return "CA";
      if (v === "EU") return "FR"; // EU bucket
      return "DE";
    }

    if (elCurrency){
      elCurrency.addEventListener("change", () => {
        setCurrency(elCurrency.value);
        enforceCurrencyByShipping();

        // PayPal SDK currency-bound ‚Üí –µ—Å–ª–∏ –≤–∞–ª—é—Ç–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º SDK
        resetPayPalHard();

        render();
        renderCart();
      });
    }

    if (elShipCountry){
      elShipCountry.addEventListener("change", () => {
        try{
          localStorage.setItem(MP_SHIP_KEY, String(elShipCountry.value || "US").toUpperCase());
          localStorage.setItem(MP_USER_SET_KEY, "1");
        }catch(_){}
        enforceCurrencyByShipping();
        setCurrency(getCurrency());
        cacheSetShip(String(elShipCountry.value || "US").toUpperCase());

        // shipping –º–æ–∂–µ—Ç —Å–º–µ–Ω–∏—Ç—å –≤–∞–ª—é—Ç—É ‚Üí PayPal –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
        resetPayPalHard();

        render();
        renderCart();
        toast("Shipping", `Destination: ${elShipCountry.value}`);
      });
    }

    function priceText(priceObj){
      const cur = getCurrency();
      const v = priceObj?.[cur];
      if (typeof v !== "number") return cur === "EUR" ? "‚Äî ‚Ç¨" : "‚Äî $";
      return cur === "EUR" ? `${v.toFixed(2)} ‚Ç¨` : `${v.toFixed(2)} $`;
    }

    // sheet/cart open-close
    function openSheet(){
      elSheetBack.classList.add("show");
      elSheet.classList.add("show");
      document.body.style.overflow = "hidden";
    }
    function closeSheet(){
      elSheetBack.classList.remove("show");
      elSheet.classList.remove("show");
      document.body.style.overflow = "";
    }
    elOpenFilters.addEventListener("click", openSheet);
    elCloseFilters.addEventListener("click", closeSheet);
    elSheetBack.addEventListener("click", closeSheet);

    function openCart(){
      elCartBack.classList.add("show");
      elCartDrawer.classList.add("show");
      document.body.style.overflow = "hidden";
      renderCart();
      maybeInitPayPal();
    }
    function closeCart(){
      elCartBack.classList.remove("show");
      elCartDrawer.classList.remove("show");
      document.body.style.overflow = "";
    }
    elOpenCart.addEventListener("click", openCart);
    elCloseCart.addEventListener("click", closeCart);
    elCartBack.addEventListener("click", closeCart);

    window.addEventListener("keydown", (e)=>{
      if (e.key !== "Escape") return;
      if (elCartDrawer.classList.contains("show")) closeCart();
      if (elSheet.classList.contains("show")) closeSheet();
    });

    function updateCartBadge(){ elCartBadge.textContent = String(cartCount()); }

    // =========================
    // PayPal integration (ONLY PayPal button, disable cards+sepa)
    // =========================
    let ppReady = false;
    let ppLoading = false;
    let ppRenderedForKey = "";

    function cartSnapshotKey(){
      const cart = readCart();
      const cur = getCurrency();
      const ship = String(elShipCountry?.value || "US").toUpperCase();
      const itemsKey = cart.map(it => `${String(it.pin)}:${Number(it.qty)||1}`).sort().join("|");
      return `${cur}|${ship}|${itemsKey}`;
    }

    function showPayPalNote(msg){
      if (!elPpNote) return;
      elPpNote.textContent = String(msg || "");
      elPpNote.style.display = msg ? "block" : "none";
    }

    async function fetchPayPalClientId(){
      const r = await fetch(API_PP_CONFIG, { method:"GET", cache:"no-store" });
      const j = await r.json().catch(()=>null);
      if (!r.ok || !j?.clientId) throw new Error(j?.error || "PayPal config error");
      return String(j.clientId);
    }

    // HARD reset: remove SDK script + window.paypal (important for currency changes)
    function resetPayPalHard(){
      ppReady = false;
      ppLoading = false;
      ppRenderedForKey = "";
      try{ clearPayPalButtons(); }catch(_){}
      try{ showPayPalNote(""); }catch(_){}

      try{
        const old = document.getElementById("pp-sdk");
        if (old && old.parentNode){
          old.parentNode.removeChild(old);
        }
      }catch(_){}

      try{ delete window.paypal; }catch(_){}
      try{ window.paypal = undefined; }catch(_){}

      // recreate placeholder
      try{
        const s = document.createElement("script");
        s.id = "pp-sdk";
        s.setAttribute("data-loaded","0");
        document.body.appendChild(s);
      }catch(_){}
    }

    function loadPayPalSDK(clientId){
      return new Promise((resolve, reject) => {
        try{
          if (window.paypal && typeof window.paypal.Buttons === "function"){
            resolve(true);
            return;
          }

          const s = document.getElementById("pp-sdk");
          if (!s) throw new Error("pp-sdk tag missing");

          const cur = getCurrency();

          // ONLY PayPal funding (disable cards etc)
          const url =
            "https://www.paypal.com/sdk/js" +
            `?client-id=${encodeURIComponent(clientId)}` +
            `&currency=${encodeURIComponent(cur)}` +
            `&intent=capture` +
            `&components=buttons` +
            `&disable-funding=card,sepa,ideal,bancontact,sofort,giropay,eps,mybank,p24,venmo`;

          // same src ‚Üí wait
          if (s.src && s.src === url){
            const t0 = Date.now();
            const tick = () => {
              if (window.paypal && typeof window.paypal.Buttons === "function") return resolve(true);
              if (Date.now() - t0 > 12000) return reject(new Error("PayPal SDK timeout"));
              setTimeout(tick, 120);
            };
            tick();
            return;
          }

          // different src ‚Üí hard reset then load again
          if (s.src && s.src !== url){
            resetPayPalHard();
            return loadPayPalSDK(clientId).then(resolve).catch(reject);
          }

          s.onload = () => resolve(true);
          s.onerror = () => reject(new Error("PayPal SDK failed to load"));
          s.src = url;
          s.setAttribute("data-loaded","1");
        }catch(e){
          reject(e);
        }
      });
    }

    async function maybeInitPayPal(){
      try{
        const cart = readCart();
        if (!cart.length){
          if (elPpWrap) elPpWrap.style.display = "none";
          return;
        }
        if (elPpWrap) elPpWrap.style.display = "flex";

        // enforce currency BEFORE sdk load
        enforceCurrencyByShipping();
        setCurrency(getCurrency());

        if (ppReady){
          renderPayPalButtonsIfNeeded();
          return;
        }
        if (ppLoading) return;

        ppLoading = true;
        showPayPalNote("PayPal is loading‚Ä¶");

        const clientId = await fetchPayPalClientId();
        await loadPayPalSDK(clientId);

        ppReady = true;
        ppLoading = false;

        showPayPalNote("");
        renderPayPalButtonsIfNeeded();
      }catch(e){
        ppLoading = false;
        ppReady = false;
        showPayPalNote(`PayPal unavailable: ${String(e?.message || e)}`);
      }
    }

    function clearPayPalButtons(){
      const wrap = document.getElementById("paypal-button-container");
      if (wrap) wrap.innerHTML = "";
    }

    function renderPayPalButtonsIfNeeded(){
      if (!ppReady) return;
      if (!window.paypal || typeof window.paypal.Buttons !== "function") return;

      const cart = readCart();
      if (!cart.length){
        clearPayPalButtons();
        ppRenderedForKey = "";
        return;
      }

      const key = cartSnapshotKey();
      if (key === ppRenderedForKey) return;

      clearPayPalButtons();
      ppRenderedForKey = key;

      window.paypal.Buttons({
        // ‚úÖ style –ø–æ–¥ –Ω–∞—à—É –∫–Ω–æ–ø–∫—É: –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫, –≤—ã—Å–æ—Ç–∞ 44
        style: { layout:"vertical", shape:"rect", label:"paypal", height: 44 },

        createOrder: async () => {
          const cartNow = readCart();
          if (!cartNow.length) throw new Error("Cart is empty");

          enforceCurrencyByShipping();
          setCurrency(getCurrency());

          const payload = {
            currency: getCurrency(),
            shippingCountry: getShippingCountryISO2(),
            items: cartNow.map(it => ({ pin: String(it.pin), qty: Number(it.qty) || 1 })),
          };

          const r = await fetch(API_PP_CREATE, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(payload),
          });

          const data = await r.json().catch(()=>({}));
          if (!r.ok || !data?.id) throw new Error(data?.error || "PayPal create order failed");
          return data.id;
        },

        onApprove: async (data) => {
          try{
            const orderID = data?.orderID;
            if (!orderID) throw new Error("Missing orderID");

            const r = await fetch(API_PP_CAPTURE, {
              method: "POST",
              headers: { "Content-Type":"application/json" },
              body: JSON.stringify({ orderID }),
            });

            const j = await r.json().catch(()=>({}));
            if (!r.ok || !j?.ok) throw new Error(j?.error || "Capture failed");

            writeCart([]);
            updateCartBadge();
            renderCart();
            toast("PayPal", "Payment success ‚úÖ");
            loadProducts();
          }catch(e){
            toast("PayPal", String(e?.message || e));
          }
        },

        onCancel: () => toast("PayPal", "Canceled"),
        onError: (err) => toast("PayPal", String(err?.message || err || "PayPal error")),
      }).render("#paypal-button-container");
    }

    // =========================
    // Cart logic (Stripe + PayPal)
    // =========================

    function addToCartFromProduct(p, qty){
      qty = Number(qty);
      if (!Number.isFinite(qty) || qty <= 0) qty = 1;

      const stock = Number(p.stock ?? 0);
      if (stock <= 0){ toast("Cart", "Sold out"); return; }

      const cart = readCart();
      const idx = cart.findIndex(x => String(x.pin) === String(p.pin));

      if (idx >= 0){
        const next = Math.min(stock, (Number(cart[idx].qty)||0) + qty);
        cart[idx].qty = next;
        cart[idx].stock = stock;
        cart[idx].title = p.title;
        cart[idx].image = (p.images && p.images[0]) ? p.images[0] : (cart[idx].image || "");
        cart[idx].price = p.price || cart[idx].price || {};
      } else {
        cart.push({
          pin: String(p.pin),
          qty: Math.min(stock, qty),
          title: String(p.title || p.pin),
          image: (p.images && p.images[0]) ? p.images[0] : "",
          price: p.price || {},
          stock: stock
        });
      }

      writeCart(cart);
      updateCartBadge();
      renderCart();
      toast("Cart", "Added ‚úÖ");

      ppRenderedForKey = "";
      renderPayPalButtonsIfNeeded();
    }

    function setCartQty(pin, qty){
      const cart = readCart();
      const idx = cart.findIndex(x => String(x.pin) === String(pin));
      if (idx < 0) return;

      const stock = Number(cart[idx].stock ?? 0);
      qty = Number(qty);
      if (!Number.isFinite(qty)) qty = 1;
      qty = Math.max(1, qty);
      if (stock > 0) qty = Math.min(stock, qty);

      cart[idx].qty = qty;
      writeCart(cart);
      updateCartBadge();
      renderCart();

      ppRenderedForKey = "";
      renderPayPalButtonsIfNeeded();
    }

    function removeFromCart(pin){
      const cart = readCart().filter(x => String(x.pin) !== String(pin));
      writeCart(cart);
      updateCartBadge();
      renderCart();

      ppRenderedForKey = "";
      renderPayPalButtonsIfNeeded();
    }

    function clearCart(){
      writeCart([]);
      updateCartBadge();
      renderCart();

      ppRenderedForKey = "";
      renderPayPalButtonsIfNeeded();
    }

    function cartTotal(){
      const cur = getCurrency();
      const cart = readCart();
      let sum = 0;
      for (const it of cart){
        const unit = Number(it?.price?.[cur]);
        if (Number.isFinite(unit)) sum += unit * (Number(it?.qty)||0);
      }
      return sum;
    }

    function renderCart(){
      const cart = readCart();

      // show/hide PayPal "button"
      if (elPpWrap) elPpWrap.style.display = cart.length ? "flex" : "none";

      // enable/disable action buttons
      if (elCartCheckout) elCartCheckout.disabled = !cart.length;
      if (elCartClear) elCartClear.disabled = !cart.length;

      if (!cart.length){
        elCartBody.innerHTML = `<div class="cartEmpty">Your cart is empty.</div>`;
        elCartTotal.textContent = "‚Äî";

        clearPayPalButtons();
        ppRenderedForKey = "";
        return;
      }

      const cur = getCurrency();

      elCartBody.innerHTML = cart.map(it => {
        const img = it.image
          ? `<img src="${escapeHtml(it.image)}" alt="${escapeHtml(it.title)}" />`
          : `<span>‚Äî</span>`;

        const unit = it?.price?.[cur];
        const unitText = (typeof unit === "number")
          ? (cur==="EUR" ? `${unit.toFixed(2)} ‚Ç¨` : `${unit.toFixed(2)} $`)
          : "‚Äî";

        return `
          <div class="cartItem" data-pin="${escapeHtml(String(it.pin || ""))}">
            <div class="cartImg">${img}</div>
            <div>
              <p class="cartName">${escapeHtml(it.title || it.pin)}</p>
              <div class="cartMeta">${escapeHtml(it.pin)} ‚Ä¢ ${unitText}</div>
              <div class="cartRow">
                <div class="cartQty">
                  <button type="button" data-act="minus">‚àí</button>
                  <input value="${escapeHtml(String(it.qty || 1))}" inputmode="numeric" />
                  <button type="button" data-act="plus">+</button>
                </div>
                <button class="cartRemove" type="button" data-act="remove">‚úï</button>
              </div>
              <div class="cartMeta" style="margin-top:8px;">Stock: ${escapeHtml(it.stock ?? "‚Äî")}</div>
            </div>
          </div>
        `;
      }).join("");

      [...elCartBody.querySelectorAll(".cartItem")].forEach(row => {
        const pin = row.getAttribute("data-pin");
        const input = row.querySelector("input");

        row.querySelector('button[data-act="minus"]').addEventListener("click", () => setCartQty(pin, Number(input.value) - 1));
        row.querySelector('button[data-act="plus"]').addEventListener("click",  () => setCartQty(pin, Number(input.value) + 1));

        input.addEventListener("input", () => {
          const v = Number(input.value);
          if (!Number.isFinite(v)) return;
          setCartQty(pin, v);
        });

        row.querySelector('button[data-act="remove"]').addEventListener("click", () => removeFromCart(pin));
      });

      const sum = cartTotal();
      elCartTotal.textContent = (cur==="EUR") ? `${sum.toFixed(2)} ‚Ç¨` : `${sum.toFixed(2)} $`;

      // init/render PayPal when cart visible
      maybeInitPayPal();
      renderPayPalButtonsIfNeeded();
    }

    // Clear cart button
    elCartClear.addEventListener("click", () => { clearCart(); toast("Cart", "Cleared"); });

    // Stripe checkout
    async function startCheckout(){
      const cart = readCart();
      if (!cart.length) { toast("Checkout", "Cart is empty"); return; }

      enforceCurrencyByShipping();
      setCurrency(getCurrency());

      try{ localStorage.setItem(MP_SHIP_KEY, String(elShipCountry.value || "US").toUpperCase()); }catch(_){}

      const payload = {
        currency: getCurrency(),
        shippingCountry: getShippingCountryISO2(),
        items: cart.map(it => ({ pin: String(it.pin), qty: Number(it.qty) || 1 })),
      };

      elCartCheckout.disabled = true;
      elCartCheckout.textContent = "Redirecting‚Ä¶";

      try{
        const r = await fetch(API_CHECKOUT, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload),
        });

        const data = await r.json().catch(()=>({}));
        if (!r.ok || !data?.ok || !data?.url){
          throw new Error(data?.error || "Checkout failed");
        }

        window.location.href = data.url;
      }catch(e){
        toast("Checkout", String(e?.message || e));
        elCartCheckout.disabled = false;
        elCartCheckout.textContent = "Checkout";
      }finally{
        // restore text when coming back without redirect
        if (!elCartCheckout.disabled) elCartCheckout.textContent = "Checkout";
      }
    }
    elCartCheckout.addEventListener("click", startCheckout);

    function parseDiameter(raw){
      if (raw == null) return { key:null, num:null, display:null, note:null, raw:null };

      if (typeof raw === "number" && Number.isFinite(raw)){
        const s = String(raw);
        return { key: s, num: raw, display: s.replace(".",","), note:null, raw:s };
      }

      const str = String(raw).trim();
      if (!str) return { key:null, num:null, display:null, note:null, raw:str };

      const noteMatch = str.match(/\(([^)]+)\)/);
      const note = noteMatch ? noteMatch[1].trim() : null;

      const m = str.match(/(\d+(?:[.,]\d+)?)/);
      if (!m) return { key: str, num:null, display:str, note: note, raw:str };

      const captured = m[1];
      const key = captured.replace(",",".");
      const num = parseFloat(key);
      const display = captured.replace(".",",");

      return { key, num: (Number.isFinite(num) ? num : null), display, note, raw: str };
    }

    function diameterLabelByKey(key){
      const info = diameterMap.get(key);
      if (!info) return key;
      return info.display || key;
    }

    function updateSelectedUI(){
      const arr = [...selectedDiameters].map(k => ({ k, n: (diameterMap.get(k)?.num ?? Infinity) }))
        .sort((a,b)=>a.n-b.n)
        .map(x => x.k);

      elDiaCount.textContent = String(arr.length);
      elMDiaCount.textContent = String(arr.length);
      elFiltersBadge.textContent = String(arr.length);

      const text = (arr.length ? arr.map(k => `√ò${diameterLabelByKey(k)}`).join(", ") : "‚Äî");

      if (arr.length === 0){
        elSelectedWrap.style.display = "none";
        elSelectedList.textContent = "‚Äî";
      } else {
        elSelectedWrap.style.display = "block";
        elSelectedList.textContent = text;
      }

      if (arr.length === 0){
        elMSelectedWrap.style.display = "none";
        elMSelectedList.textContent = "‚Äî";
      } else {
        elMSelectedWrap.style.display = "block";
        elMSelectedList.textContent = text;
      }
    }

    function applyFilters(){
      const q = (elQ.value || "").trim().toLowerCase();
      const inStockOnly = elStock.checked;

      filtered = products.filter(p => {
        if (selectedDiameters.size > 0) {
          if (!p.diameterKey || !selectedDiameters.has(p.diameterKey)) return false;
        }
        if (inStockOnly && !(Number(p.stock||0) > 0)) return false;

        if (!q) return true;
        const hay = `${p.pin} ${p.title} ${(p.materials||[]).join(" ")} ${(p.diameterRaw||"")}`.toLowerCase();
        return hay.includes(q);
      });

      render();
    }

    function cardTemplate(p){
      const img = (p.images && p.images[0]) ? `<img src="${escapeHtml(p.images[0])}" alt="${escapeHtml(p.title)}" />` : "";
      const soldOut = !(Number(p.stock||0) > 0);

      const diaText = p.diameterDisplay ? p.diameterDisplay : (p.diameterNum != null ? String(p.diameterNum).replace(".",",") : "‚Äî");

      return `
        <div class="card" data-open="${escapeHtml(String(p.pin))}">
          <div class="thumb">
            ${img}
            <div class="badge ${soldOut ? "sold" : ""}">${soldOut ? "Sold out" : `In stock: ${escapeHtml(p.stock)}`}</div>
          </div>
          <div class="meta">
            <p class="name">${escapeHtml(p.title)} <span style="color:var(--muted); font-weight:700;">‚Ä¢ ${escapeHtml(p.pin)}</span></p>
            <p class="desc">${escapeHtml((p.description || "").trim())}</p>
            <div class="row">
              <div>
                <div class="price">${priceText(p.price)}</div>
                <div style="color:var(--muted); font-size:12px; margin-top:2px;">√ò ${escapeHtml(diaText)}</div>
              </div>
              <div style="display:flex; gap:8px;">
                <button class="btn2" ${soldOut ? "disabled" : ""} data-add="${escapeHtml(p.pin)}" title="Add to cart" type="button">Ôºã</button>
                <button class="btn" ${soldOut ? "disabled" : ""} data-openbuy="${escapeHtml(p.pin)}" type="button">Buy</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function render(){
      elSbCount.textContent = `${filtered.length} items`;
      elGrid.innerHTML = filtered.map(cardTemplate).join("");

      [...document.querySelectorAll("button[data-add]")].forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const pin = btn.getAttribute("data-add");
          const p = products.find(x => String(x.pin) === String(pin));
          if (!p) return;
          addToCartFromProduct(p, 1);
        });
      });

      [...document.querySelectorAll("button[data-openbuy]")].forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const pin = btn.getAttribute("data-openbuy");
          window.location.href = `/product.html?pin=${encodeURIComponent(pin)}`;
        });
      });

      [...document.querySelectorAll(".card[data-open]")].forEach(card => {
        card.addEventListener("click", () => {
          const pin = card.getAttribute("data-open");
          window.location.href = `/product.html?pin=${encodeURIComponent(pin)}`;
        });
      });
    }

    function normalizeProducts(data){
      const arr = Array.isArray(data) ? data : (data.products || []);
      return arr.map(x => {
        const pin = x.pin || x.pin_code || x.PIN || x["PIN Code"] || "‚Äî";
        const title = x.title || x.name || "Untitled";
        const description = x.description || "";
        const diameterRaw = (x.diameter ?? x.diameter_mm ?? x["Diameter"] ?? null);

        const dia = parseDiameter(diameterRaw);

        return {
          pin,
          title,
          description,
          diameterRaw: diameterRaw == null ? "" : String(diameterRaw),
          diameterKey: dia.key,
          diameterNum: dia.num,
          diameterDisplay: dia.display,
          diameterNote: dia.note,

          materials: x.materials || x["Materials"] || [],
          stock: (x.stock ?? x["Stock"] ?? 0),
          images: x.images || x["Images"] || [],
          price: x.price || { EUR: x.price_eur, USD: x.price_usd },
        };
      });
    }

    function buildDiameterLists(){
      diameterMap = new Map();

      for (const p of products){
        if (!p.diameterKey) continue;
        if (!diameterMap.has(p.diameterKey)){
          diameterMap.set(p.diameterKey, {
            key: p.diameterKey,
            num: p.diameterNum,
            display: p.diameterDisplay || p.diameterKey.replace(".",","),
            note: p.diameterNote || null
          });
        }
      }

      const diameters = [...diameterMap.values()].sort((a,b)=>{
        const an = (a.num == null ? -Infinity : a.num);
        const bn = (b.num == null ? -Infinity : b.num);
        if (an !== bn) return bn - an;
        return String(a.display).localeCompare(String(b.display));
      });

      const buildInto = (container) => {
        container.innerHTML = "";

        const makeItem = ({label, sub, valueKey, isAll=false}) => {
          const div = document.createElement("div");
          const active = isAll ? (selectedDiameters.size === 0) : selectedDiameters.has(valueKey);
          div.className = "item" + (active ? " active" : "");
          div.innerHTML = `${escapeHtml(label)}<small>${escapeHtml(sub)}</small>`;

          div.addEventListener("click", () => {
            if (isAll) selectedDiameters.clear();
            else {
              if (selectedDiameters.has(valueKey)) selectedDiameters.delete(valueKey);
              else selectedDiameters.add(valueKey);
            }
            updateSelectedUI();
            buildDiameterLists();
            applyFilters();
          });

          return div;
        };

        container.appendChild(makeItem({ label:"All", sub:"Any size", valueKey:null, isAll:true }));

        for (const d of diameters){
          const sub = d.note ? d.note : "Exact";
          container.appendChild(makeItem({ label:`√ò ${d.display}`, sub, valueKey:d.key }));
        }
      };

      buildInto(elDiameters);
      buildInto(elMDiameters);
      updateSelectedUI();
    }

    function clearDiameters(){
      selectedDiameters.clear();
      updateSelectedUI();
      buildDiameterLists();
      applyFilters();
    }
    elClearDiameters.addEventListener("click", (e) => { e.preventDefault(); clearDiameters(); });
    elMClearDiameters.addEventListener("click", (e) => { e.preventDefault(); clearDiameters(); });

    async function loadProducts(){
      try{
        const r = await fetch(API_PRODUCTS, { method:"GET", cache:"no-store" });
        if (r.ok){
          const data = await r.json();
          products = normalizeProducts(data);
          buildDiameterLists();
          applyFilters();

          // refresh cart items with latest product data
          const cart = readCart();
          if (cart.length){
            const next = cart.map(it => {
              const p = products.find(x => String(x.pin) === String(it.pin));
              if (!p) return it;
              return {
                ...it,
                title: p.title,
                image: (p.images && p.images[0]) ? p.images[0] : (it.image || ""),
                price: p.price || it.price || {},
                stock: Number(p.stock ?? it.stock ?? 0)
              };
            });
            writeCart(next);
          }

          updateCartBadge();
          renderCart();

          ppRenderedForKey = "";
          renderPayPalButtonsIfNeeded();
          return;
        }
      }catch(_){
        toast("Error", "Products API is not reachable");
      }

      products = [];
      buildDiameterLists();
      applyFilters();
      updateCartBadge();
      renderCart();

      ppRenderedForKey = "";
      renderPayPalButtonsIfNeeded();
    }

    elQ.addEventListener("input", applyFilters);
    elStock.addEventListener("change", applyFilters);

    window.addEventListener("resize", () => { if (window.innerWidth > 980) closeSheet(); });

    // initial
    updateCartBadge();
    renderCart();
    loadProducts();

    // enforce currency on first load too
    enforceCurrencyByShipping();
    setCurrency(getCurrency());

    (function handleReturn(){
      const u = new URL(window.location.href);

      if (u.searchParams.get("success") === "1"){
        writeCart([]);
        updateCartBadge();
        renderCart();
        toast("Payment", "Success ‚úÖ Stock –æ–±–Ω–æ–≤–∏—Ç—Å—è –∏–∑ Airtable");

        u.searchParams.delete("success");
        history.replaceState({}, "", u.toString());
        loadProducts();
      }

      if (u.searchParams.get("canceled") === "1"){
        toast("Payment", "Canceled");
        u.searchParams.delete("canceled");
        history.replaceState({}, "", u.toString());
      }
    })();

    (function navActive(){
      const path = (window.location.pathname || "/").toLowerCase();

      const idsDesktop = ["navShop","navAbout","navShipping","navReturns","navReviews"];
      idsDesktop.forEach(id => document.getElementById(id)?.classList.remove("active"));

      const set = (id) => document.getElementById(id)?.classList.add("active");

      if (path.startsWith("/shipping")) { set("navShipping"); }
      else if (path.startsWith("/returns")) { set("navReturns"); }
      else if (path.startsWith("/reviews")) { set("navReviews"); }
      else if (path.startsWith("/about")) { set("navAbout"); }
      else { set("navShop"); }
    })();
  </script>
</body>
</html>
