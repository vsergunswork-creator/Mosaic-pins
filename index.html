<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mosaic Pins</title>
  <style>
    :root{
      --bg:#0b0d11;
      --panel:#11141b;
      --panel2:#0f1218;
      --text:#e9eef7;
      --muted:#a8b3c7;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 30px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1100px 700px at 35% -10%, rgba(50,220,150,.25), transparent 55%),
                  radial-gradient(900px 600px at 75% 10%, rgba(120,90,255,.22), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* Layout */
    .app{display:grid; grid-template-columns: 280px 1fr; height:100vh; gap:16px; padding:16px;}
    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sb-top{
      padding:18px 18px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px;}
    .dot{width:10px;height:10px;border-radius:50%; background:linear-gradient(135deg,#22c55e,#60a5fa);}
    .pill{
      padding:8px 10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
    }
    .sb-nav{padding:6px; display:grid; gap:6px;}
    .nav-item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:12px;
      color:var(--muted);
      text-decoration:none;
      border:1px solid transparent;
    }
    .nav-item:hover{background:rgba(255,255,255,.05); color:var(--text);}
    .nav-item.active{
      background:rgba(34,197,94,.12);
      border-color: rgba(34,197,94,.22);
      color:var(--text);
    }
    .sb-section{
      padding:14px 12px 10px;
      display:flex; align-items:center; justify-content:space-between;
      color:var(--muted);
      font-size:12px;
      letter-spacing:.6px;
      text-transform:uppercase;
    }
    .collections{
      padding:0 6px 10px;
      display:grid;
      gap:6px;
      max-height:calc(100vh - 240px);
      overflow:auto;
    }
    .col-item{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
    }
    .col-item:hover{background:rgba(255,255,255,.05)}
    .col-item small{display:block; color:var(--muted); margin-top:4px}

    /* NEW: active state for diameter filter items */
    #diameterFilters .col-item.active{
      background:rgba(34,197,94,.12);
      border-color: rgba(34,197,94,.22);
    }

    /* Main */
    .main{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .topbar{
      padding:16px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
    }
    .top-left{display:flex; align-items:center; gap:10px; min-width:0}
    .h-title{font-weight:900; font-size:18px; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .sub{color:var(--muted); font-size:12px; margin-top:4px}
    .search{
      flex:1; max-width:520px; min-width:220px;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
    }
    .search input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:14px;
    }
    .top-right{display:flex; align-items:center; gap:10px}
    .toggle{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
      user-select:none;
      cursor:pointer;
    }
    .toggle input{accent-color:#22c55e; width:16px; height:16px}
    .currency{
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-size:13px;
      outline:none;
    }

    .content{padding:18px; overflow:auto; min-height:0;}
    .grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:14px;
    }
    @media (max-width:1200px){ .grid{grid-template-columns:repeat(4,1fr)} }
    @media (max-width:980px){
      .app{grid-template-columns:1fr}
      .sidebar{display:none}
      .grid{grid-template-columns:repeat(2,1fr)}
      body{overflow:auto}
      .main{height:auto; min-height:100vh}
    }
    @media (max-width:520px){ .grid{grid-template-columns:1fr} }

    .card{
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
      transition: transform .15s ease, background .15s ease;
      cursor:pointer;
    }
    .card:hover{transform: translateY(-2px); background:rgba(255,255,255,.04)}
    .thumb{
      aspect-ratio: 1/1;
      background:linear-gradient(135deg, rgba(34,197,94,.14), rgba(96,165,250,.10));
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .badge{
      position:absolute; left:10px; top:10px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.35);
      color:var(--text);
      backdrop-filter: blur(6px);
    }
    .sold{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.25)}
    .meta{padding:12px}
    .name{font-weight:800; font-size:14px; margin:0 0 6px}
    .desc{margin:0; color:var(--muted); font-size:12px; line-height:1.35; height:32px; overflow:hidden}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px}
    .price{font-weight:900}
    .btn{
      border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#07110b;
      font-weight:900;
      box-shadow: 0 10px 18px rgba(34,197,94,.18);
      transition: filter .15s ease, transform .15s ease;
      white-space:nowrap;
    }
    .btn:hover{filter:brightness(1.05); transform: translateY(-1px)}
    .btn:disabled{
      cursor:not-allowed;
      background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.55);
      box-shadow:none;
    }

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(0,0,0,.55);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 14px;
      color: var(--text);
      box-shadow: var(--shadow);
      max-width: 360px;
      display:none;
    }
    .toast.show{display:block}
    .toast small{color:var(--muted)}
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand"><span class="dot"></span> Mosaic Pins</div>
        <div class="pill" id="sbCount">— items</div>
      </div>

      <nav class="sb-nav">
        <a class="nav-item active" href="#" id="navShop">Shop</a>
        <a class="nav-item" href="#" id="navAbout">About</a>
        <a class="nav-item" href="#" id="navShipping">Shipping</a>
        <a class="nav-item" href="#" id="navReturns">Returns</a>
      </nav>

      <div class="sb-section">
        <span>Collections</span>
        <span class="pill" style="padding:6px 10px;">New</span>
      </div>

      <div class="collections" id="collections">
        <div class="col-item" data-filter="all">
          All pins
          <small>Everything in stock</small>
        </div>
        <div class="col-item" data-filter="popular">
          Popular materials
          <small>Brass / Copper / Mosaic</small>
        </div>
        <div class="col-item" data-filter="large">
          Large diameters
          <small>Ø 10 mm+</small>
        </div>
      </div>

      <!-- NEW: Diameter filter (auto from Airtable list) -->
      <div class="sb-section">
        <span>Diameter</span>
        <span class="pill" id="diaCount" style="padding:6px 10px;">—</span>
      </div>
      <div class="collections" id="diameterFilters"></div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="top-left">
          <div>
            <h1 class="h-title">Shop</h1>
            <div class="sub">Handmade mosaic pins for custom knife handles</div>
          </div>
        </div>

        <div class="search" title="Search by title or PIN code">
          <span style="color:var(--muted);">⌕</span>
          <input id="q" placeholder="Search pins (e.g. G10N11gt, Mosaic, Brass…)" />
        </div>

        <div class="top-right">
          <label class="toggle" title="Show only in-stock pins">
            <input id="inStockOnly" type="checkbox" />
            In stock
          </label>

          <select class="currency" id="currency" title="Currency">
            <option value="EUR">EUR €</option>
            <option value="USD">USD $</option>
          </select>
        </div>
      </div>

      <div class="content">
        <div class="grid" id="grid"></div>
      </div>
    </main>
  </div>

  <div class="toast" id="toast">
    <div style="font-weight:800" id="toastTitle">Checkout</div>
    <small id="toastMsg">Opening Stripe…</small>
  </div>

<script>
  // ========= CONFIG =========
  const API_PRODUCTS = "/api/products";
  const API_CHECKOUT  = "/api/checkout";

  // Demo fallback (когда /api/products ещё не сделан)
  const DEMO = [
    {
      pin: "G10N11gt",
      title: "Emerald Mosaic",
      description: "Handmade mosaic pin. Perfect for custom knife handles.",
      price: { EUR: 22, USD: 24 },
      stock: 1,
      diameter: 10,
      materials: ["Brass", "Copper", "Mosaic"],
      images: []
    },
    {
      pin: "PIN-002",
      title: "Copper Wave",
      description: "Copper + nickel accents. Clean pattern.",
      price: { EUR: 19, USD: 21 },
      stock: 0,
      diameter: 8,
      materials: ["Copper", "Nickel"],
      images: []
    },
    {
      pin: "PIN-003",
      title: "Brass Grid",
      description: "Brass dominant. High contrast, crisp look.",
      price: { EUR: 25, USD: 27 },
      stock: 1,
      diameter: 12,
      materials: ["Brass", "Steel"],
      images: []
    }
  ];

  // ========= STATE =========
  let products = [];
  let filtered = [];
  let collectionMode = "all";

  // NEW: diameter filter mode
  let diameterMode = "all"; // all | "10" | "<=8" | ">=12" | "8-10"

  const elGrid = document.getElementById("grid");
  const elQ = document.getElementById("q");
  const elStock = document.getElementById("inStockOnly");
  const elCurrency = document.getElementById("currency");
  const elSbCount = document.getElementById("sbCount");
  const elToast = document.getElementById("toast");
  const elToastTitle = document.getElementById("toastTitle");
  const elToastMsg = document.getElementById("toastMsg");

  function toast(title, msg){
    elToastTitle.textContent = title;
    elToastMsg.textContent = msg;
    elToast.classList.add("show");
    setTimeout(()=> elToast.classList.remove("show"), 2400);
  }

  function priceText(p){
    const cur = elCurrency.value;
    const v = p?.[cur];
    if (typeof v !== "number") return cur === "EUR" ? "— €" : "— $";
    return cur === "EUR" ? `${v.toFixed(2)} €` : `${v.toFixed(2)} $`;
  }

  function passesCollection(p){
    if (collectionMode === "all") return true;
    if (collectionMode === "large") return (Number(p.diameter||0) >= 10);
    if (collectionMode === "popular") {
      const mats = (p.materials||[]).map(x=>String(x).toLowerCase());
      return mats.some(m => ["brass","copper","mosaic"].includes(m));
    }
    return true;
  }

  // ===== NEW: diameter filter helpers (auto from Airtable list) =====
  function getDiametersFromProducts(list){
    const set = new Set();
    for (const p of (list || [])){
      const d = Number(p.diameter);
      if (Number.isFinite(d) && d > 0) set.add(d);
    }
    return [...set].sort((a,b)=>a-b);
  }

  function buildDiameterButtons(diams){
    const host = document.getElementById("diameterFilters");
    const count = document.getElementById("diaCount");
    if (!host) return;

    count.textContent = diams.length ? `${diams.length}` : "0";

    const item = (label, value, sub="") => `
      <div class="col-item ${value==="all" ? "active" : ""}" data-diameter="${value}">
        ${label}
        ${sub ? `<small>${sub}</small>` : `<small></small>`}
      </div>
    `;

    let html = item("All", "all", "Any size");

    if (!diams.length){
      host.innerHTML = html;
      return;
    }

    if (diams.length <= 10){
      // exact sizes
      html += diams.map(d => item(`Ø ${d} mm`, String(d), "Exact")).join("");
      count.textContent = `${diams.length}`;
    } else {
      // many sizes -> ranges using quartiles
      const min = diams[0];
      const max = diams[diams.length-1];
      const q1 = diams[Math.floor(diams.length*0.25)];
      const q2 = diams[Math.floor(diams.length*0.50)];
      const q3 = diams[Math.floor(diams.length*0.75)];

      html += item(`≤ Ø ${q1} mm`, `<=${q1}`, "Small");
      html += item(`Ø ${q1}–${q2} mm`, `${q1}-${q2}`, "Medium");
      html += item(`Ø ${q2}–${q3} mm`, `${q2}-${q3}`, "Large");
      html += item(`≥ Ø ${q3} mm`, `>=${q3}`, "XL");

      count.textContent = `${diams.length} (${min}-${max}mm)`;
    }

    host.innerHTML = html;
  }

  function diameterPasses(p){
    if (diameterMode === "all") return true;

    const d = Number(p.diameter || 0);
    if (!Number.isFinite(d) || d <= 0) return false;

    // exact number
    if (/^\d+(\.\d+)?$/.test(diameterMode)){
      return d === Number(diameterMode);
    }

    // <=X
    if (diameterMode.startsWith("<=")){
      const x = Number(diameterMode.slice(2));
      return d <= x;
    }

    // >=X
    if (diameterMode.startsWith(">=")){
      const x = Number(diameterMode.slice(2));
      return d >= x;
    }

    // A-B
    if (diameterMode.includes("-")){
      const [a,b] = diameterMode.split("-").map(Number);
      if (!Number.isFinite(a) || !Number.isFinite(b)) return true;
      return d >= a && d <= b;
    }

    return true;
  }

  function applyFilters(){
    const q = (elQ.value || "").trim().toLowerCase();
    const inStockOnly = elStock.checked;

    filtered = products.filter(p => {
      if (!passesCollection(p)) return false;
      if (!diameterPasses(p)) return false;
      if (inStockOnly && !(Number(p.stock||0) > 0)) return false;

      if (!q) return true;
      const hay = `${p.pin} ${p.title} ${(p.materials||[]).join(" ")} ${(p.diameter||"")}`.toLowerCase();
      return hay.includes(q);
    });

    render();
  }

  function cardTemplate(p){
    const img = (p.images && p.images[0]) ? `<img src="${p.images[0]}" alt="${escapeHtml(p.title)}" />` : "";
    const soldOut = !(Number(p.stock||0) > 0);

    return `
      <div class="card" data-open="${escapeHtml(p.pin)}">
        <div class="thumb">
          ${img}
          <div class="badge ${soldOut ? "sold" : ""}">${soldOut ? "Sold out" : `In stock: ${p.stock}`}</div>
        </div>
        <div class="meta">
          <p class="name">${escapeHtml(p.title)} <span style="color:var(--muted); font-weight:700;">• ${escapeHtml(p.pin)}</span></p>
          <p class="desc">${escapeHtml(p.description || "")}</p>
          <div class="row">
            <div>
              <div class="price">${priceText(p.price)}</div>
              <div style="color:var(--muted); font-size:12px; margin-top:2px;">Ø ${p.diameter || "—"} mm</div>
            </div>
            <button class="btn" ${soldOut ? "disabled" : ""} data-pin="${escapeHtml(p.pin)}">Buy</button>
          </div>
        </div>
      </div>
    `;
  }

  function render(){
    elSbCount.textContent = `${filtered.length} items`;
    elGrid.innerHTML = filtered.map(cardTemplate).join("");

    // bind buy buttons
    [...document.querySelectorAll("button[data-pin]")].forEach(btn => {
      btn.addEventListener("click", async (e) => {
        e.stopPropagation(); // ← чтобы клик не открыл карточку
        const pin = btn.getAttribute("data-pin");
        toast("Checkout", "Opening Stripe…");

        try{
          const res = await fetch(API_CHECKOUT, {
            method:"POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ pin, quantity: 1 })
          });
          const data = await res.json();
          if (data.url) window.location.href = data.url;
          else {
            toast("Error", data.error || "Checkout failed");
            console.log(data);
          }
        }catch(err){
          toast("Error", "Network error");
          console.error(err);
        }
      });
    });
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  async function loadProducts(){
    // 1) Try real API
    try{
      const r = await fetch(API_PRODUCTS, { method:"GET" });
      if (r.ok){
        const data = await r.json();
        products = normalizeProducts(data);

        // NEW: build diameter filters from Airtable products
        buildDiameterButtons(getDiametersFromProducts(products));

        applyFilters();
        return;
      }
    }catch(_){}

    // 2) Fallback demo
    products = DEMO;

    // NEW: build from demo too
    buildDiameterButtons(getDiametersFromProducts(products));

    applyFilters();
  }

  // Normalize API format to our UI shape
  function normalizeProducts(data){
    const arr = Array.isArray(data) ? data : (data.products || []);
    return arr.map(x => ({
      pin: x.pin || x.pin_code || x.PIN || x["PIN Code"] || "—",
      title: x.title || x.name || "Untitled",
      description: x.description || "",
      diameter: x.diameter || x.diameter_mm || x["Diameter"] || null,
      materials: x.materials || x["Materials"] || [],
      stock: (x.stock ?? x["Stock"] ?? 0),
      images: x.images || x["Images"] || [],
      price: x.price || { EUR: x.price_eur, USD: x.price_usd },
    }));
  }

  // Events
  elQ.addEventListener("input", applyFilters);
  elStock.addEventListener("change", applyFilters);
  elCurrency.addEventListener("change", render);

  document.getElementById("collections").addEventListener("click", (e) => {
    const item = e.target.closest("[data-filter]");
    if (!item) return;
    collectionMode = item.getAttribute("data-filter") || "all";
    applyFilters();
  });

  // NEW: diameter filters click
  document.getElementById("diameterFilters").addEventListener("click", (e) => {
    const item = e.target.closest("[data-diameter]");
    if (!item) return;

    diameterMode = item.getAttribute("data-diameter") || "all";

    // active ui
    [...document.querySelectorAll("#diameterFilters .col-item")].forEach(x => x.classList.remove("active"));
    item.classList.add("active");

    applyFilters();
  });

  // NEW: open product page on card click (delegation, no duplicates)
  elGrid.addEventListener("click", (e) => {
    if (e.target.closest("button[data-pin]")) return; // buy button handled separately
    const card = e.target.closest(".card[data-open]");
    if (!card) return;
    const pin = card.getAttribute("data-open");
    window.location.href = `/product.html?pin=${encodeURIComponent(pin)}`;
  });

  loadProducts();
</script>
</body>
</html>
