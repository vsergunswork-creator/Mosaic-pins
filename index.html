<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mosaic Pins</title>
  <style>
    :root{
      --bg:#0b0d11;
      --panel:#11141b;
      --panel2:#0f1218;
      --text:#e9eef7;
      --muted:#a8b3c7;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 30px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1100px 700px at 35% -10%, rgba(50,220,150,.25), transparent 55%),
                  radial-gradient(900px 600px at 75% 10%, rgba(120,90,255,.22), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* Layout */
    .app{display:grid; grid-template-columns: 280px 1fr; height:100vh; gap:16px; padding:16px;}

    /* Sidebar */
    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;

      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .sb-top{
      padding:18px 18px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex:0 0 auto;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px;}
    .dot{width:10px;height:10px;border-radius:50%; background:linear-gradient(135deg,#22c55e,#60a5fa);}
    .pill{
      padding:8px 10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .sb-nav{padding:6px; display:grid; gap:6px; flex:0 0 auto;}
    .nav-item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:12px;
      color:var(--muted);
      text-decoration:none;
      border:1px solid transparent;
    }
    .nav-item:hover{background:rgba(255,255,255,.05); color:var(--text);}
    .nav-item.active{
      background:rgba(34,197,94,.12);
      border-color: rgba(34,197,94,.22);
      color:var(--text);
    }

    .sb-scroll{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding:6px;
      padding-bottom:10px;
    }
    .sb-section{
      padding:14px 12px 10px;
      display:flex; align-items:center; justify-content:space-between;
      color:var(--muted);
      font-size:12px;
      letter-spacing:.6px;
      text-transform:uppercase;
    }

    /* ✅ Selected pill (Shopify-style) */
    .selectedWrap{
      padding:0 6px 10px;
      display:none; /* shown only when selection exists */
    }
    .selectedBar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;

      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(34,197,94,.25);
      background:rgba(34,197,94,.10);
    }
    .selectedLeft{
      min-width:0;
    }
    .selectedTitle{
      font-size:12px;
      font-weight:900;
      color:var(--text);
      margin:0 0 4px;
      letter-spacing:.2px;
    }
    .selectedList{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:180px;
    }
    .clearBtn{
      flex:0 0 auto;
      border:none;
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:900;
      line-height:1;
    }
    .clearBtn:hover{background:rgba(255,255,255,.06)}

    .list{
      display:grid;
      gap:6px;
      padding:0 0 10px;
    }
    .item{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .item:hover{background:rgba(255,255,255,.05)}
    .item small{display:block; color:var(--muted); margin-top:4px}
    .item.active{
      background:rgba(34,197,94,.12);
      border-color: rgba(34,197,94,.22);
    }

    /* Main */
    .main{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .topbar{
      padding:16px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
      flex:0 0 auto;
    }
    .h-title{font-weight:900; font-size:18px; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .sub{color:var(--muted); font-size:12px; margin-top:4px}

    .search{
      flex:1; max-width:520px; min-width:220px;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
    }
    .search input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:14px;
    }
    .top-right{display:flex; align-items:center; gap:10px}
    .toggle{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
      user-select:none;
      cursor:pointer;
    }
    .toggle input{accent-color:#22c55e; width:16px; height:16px}
    .currency{
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-size:13px;
      outline:none;
    }

    .content{padding:18px; overflow:auto; min-height:0;}
    .grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:14px;
    }
    @media (max-width:1200px){ .grid{grid-template-columns:repeat(4,1fr)} }
    @media (max-width:980px){
      .app{grid-template-columns:1fr}
      .sidebar{display:none}
      .grid{grid-template-columns:repeat(2,1fr)}
      body{overflow:auto}
      .main{height:auto; min-height:100vh}
    }
    @media (max-width:520px){ .grid{grid-template-columns:1fr} }

    .card{
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
      transition: transform .15s ease, background .15s ease;
      cursor:pointer;
    }
    .card:hover{transform: translateY(-2px); background:rgba(255,255,255,.04)}
    .thumb{
      aspect-ratio: 1/1;
      background:linear-gradient(135deg, rgba(34,197,94,.14), rgba(96,165,250,.10));
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .badge{
      position:absolute; left:10px; top:10px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.35);
      color:var(--text);
      backdrop-filter: blur(6px);
    }
    .sold{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.25)}
    .meta{padding:12px}
    .name{font-weight:800; font-size:14px; margin:0 0 6px}
    .desc{margin:0; color:var(--muted); font-size:12px; line-height:1.35; height:32px; overflow:hidden}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px}
    .price{font-weight:900}
    .btn{
      border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#07110b;
      font-weight:900;
      box-shadow: 0 10px 18px rgba(34,197,94,.18);
      transition: filter .15s ease, transform .15s ease;
      white-space:nowrap;
    }
    .btn:hover{filter:brightness(1.05); transform: translateY(-1px)}
    .btn:disabled{
      cursor:not-allowed;
      background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.55);
      box-shadow:none;
    }

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(0,0,0,.55);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 14px;
      color: var(--text);
      box-shadow: var(--shadow);
      max-width: 360px;
      display:none;
      z-index:999;
    }
    .toast.show{display:block}
    .toast small{color:var(--muted)}
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand"><span class="dot"></span> Mosaic Pins</div>
        <div class="pill" id="sbCount">— items</div>
      </div>

      <nav class="sb-nav">
        <a class="nav-item active" href="#" id="navShop">Shop</a>
        <a class="nav-item" href="#" id="navAbout">About</a>
        <a class="nav-item" href="#" id="navShipping">Shipping</a>
        <a class="nav-item" href="#" id="navReturns">Returns</a>
      </nav>

      <div class="sb-scroll">
        <div class="sb-section">
          <span>Ø</span>
          <span class="pill" id="diaCount">0</span>
        </div>

        <!-- ✅ Selected pill -->
        <div class="selectedWrap" id="selectedWrap">
          <div class="selectedBar">
            <div class="selectedLeft">
              <div class="selectedTitle">Selected</div>
              <div class="selectedList" id="selectedList">—</div>
            </div>
            <button class="clearBtn" id="clearDiameters" title="Clear">✕</button>
          </div>
        </div>

        <div class="list" id="diameters"></div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <h1 class="h-title">Shop</h1>
          <div class="sub">Handmade mosaic pins for custom knife handles</div>
        </div>

        <div class="search" title="Search by title or PIN code">
          <span style="color:var(--muted);">⌕</span>
          <input id="q" placeholder="Search pins (e.g. G10N11gt, Mosaic, Brass…)" />
        </div>

        <div class="top-right">
          <label class="toggle" title="Show only in-stock pins">
            <input id="inStockOnly" type="checkbox" />
            In stock
          </label>

          <select class="currency" id="currency" title="Currency">
            <option value="EUR">EUR €</option>
            <option value="USD">USD $</option>
          </select>
        </div>
      </div>

      <div class="content">
        <div class="grid" id="grid"></div>
      </div>
    </main>
  </div>

  <div class="toast" id="toast">
    <div style="font-weight:800" id="toastTitle">Checkout</div>
    <small id="toastMsg">Opening Stripe…</small>
  </div>

<script>
  const API_PRODUCTS = "/api/products";
  const API_CHECKOUT  = "/api/checkout";

  let products = [];
  let filtered = [];

  // ✅ Multi select for diameters
  const selectedDiameters = new Set(); // numbers

  const elGrid = document.getElementById("grid");
  const elQ = document.getElementById("q");
  const elStock = document.getElementById("inStockOnly");
  const elCurrency = document.getElementById("currency");
  const elSbCount = document.getElementById("sbCount");

  const elDiaCount = document.getElementById("diaCount");
  const elDiameters = document.getElementById("diameters");

  // ✅ Selected pill elements
  const elSelectedWrap = document.getElementById("selectedWrap");
  const elSelectedList = document.getElementById("selectedList");
  const elClearDiameters = document.getElementById("clearDiameters");

  const elToast = document.getElementById("toast");
  const elToastTitle = document.getElementById("toastTitle");
  const elToastMsg = document.getElementById("toastMsg");

  function toast(title, msg){
    elToastTitle.textContent = title;
    elToastMsg.textContent = msg;
    elToast.classList.add("show");
    setTimeout(()=> elToast.classList.remove("show"), 2400);
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function priceText(p){
    const cur = elCurrency.value;
    const v = p?.[cur];
    if (typeof v !== "number") return cur === "EUR" ? "— €" : "— $";
    return cur === "EUR" ? `${v.toFixed(2)} €` : `${v.toFixed(2)} $`;
  }

  function updateSelectedPill(){
    const arr = [...selectedDiameters].sort((a,b)=>a-b);
    elDiaCount.textContent = String(arr.length);

    if (arr.length === 0){
      elSelectedWrap.style.display = "none";
      elSelectedList.textContent = "—";
      return;
    }

    elSelectedWrap.style.display = "block";
    elSelectedList.textContent = arr.map(d => `Ø${d}`).join(", ");
  }

  function applyFilters(){
    const q = (elQ.value || "").trim().toLowerCase();
    const inStockOnly = elStock.checked;

    filtered = products.filter(p => {
      if (selectedDiameters.size > 0) {
        const d = Number(p.diameter);
        if (!Number.isFinite(d) || !selectedDiameters.has(d)) return false;
      }
      if (inStockOnly && !(Number(p.stock||0) > 0)) return false;

      if (!q) return true;
      const hay = `${p.pin} ${p.title} ${(p.materials||[]).join(" ")} ${(p.diameter||"")}`.toLowerCase();
      return hay.includes(q);
    });

    render();
  }

  function cardTemplate(p){
    const img = (p.images && p.images[0]) ? `<img src="${p.images[0]}" alt="${escapeHtml(p.title)}" />` : "";
    const soldOut = !(Number(p.stock||0) > 0);

    return `
      <div class="card" data-open="${escapeHtml(p.pin)}">
        <div class="thumb">
          ${img}
          <div class="badge ${soldOut ? "sold" : ""}">${soldOut ? "Sold out" : `In stock: ${p.stock}`}</div>
        </div>
        <div class="meta">
          <p class="name">${escapeHtml(p.title)} <span style="color:var(--muted); font-weight:700;">• ${escapeHtml(p.pin)}</span></p>
          <p class="desc">${escapeHtml(p.description || "")}</p>
          <div class="row">
            <div>
              <div class="price">${priceText(p.price)}</div>
              <div style="color:var(--muted); font-size:12px; margin-top:2px;">Ø ${p.diameter ?? "—"}</div>
            </div>
            <button class="btn" ${soldOut ? "disabled" : ""} data-pin="${escapeHtml(p.pin)}">Buy</button>
          </div>
        </div>
      </div>
    `;
  }

  function render(){
    elSbCount.textContent = `${filtered.length} items`;
    elGrid.innerHTML = filtered.map(cardTemplate).join("");

    // Buy
    [...document.querySelectorAll("button[data-pin]")].forEach(btn => {
      btn.addEventListener("click", async (e) => {
        e.stopPropagation();
        const pin = btn.getAttribute("data-pin");
        toast("Checkout", "Opening Stripe…");

        try{
          const res = await fetch(API_CHECKOUT, {
            method:"POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ pin, quantity: 1 })
          });
          const data = await res.json();
          if (data.url) window.location.href = data.url;
          else {
            toast("Error", data.error || "Checkout failed");
            console.log(data);
          }
        }catch(err){
          toast("Error", "Network error");
          console.error(err);
        }
      });
    });

    // Open product
    [...document.querySelectorAll(".card[data-open]")].forEach(card => {
      card.addEventListener("click", () => {
        const pin = card.getAttribute("data-open");
        window.location.href = `/product.html?pin=${encodeURIComponent(pin)}`;
      });
    });
  }

  function normalizeProducts(data){
    const arr = Array.isArray(data) ? data : (data.products || []);
    return arr.map(x => ({
      pin: x.pin || x.pin_code || x.PIN || x["PIN Code"] || "—",
      title: x.title || x.name || "Untitled",
      description: x.description || "",
      diameter: (x.diameter ?? x.diameter_mm ?? x["Diameter"] ?? null),
      materials: x.materials || x["Materials"] || [],
      stock: (x.stock ?? x["Stock"] ?? 0),
      images: x.images || x["Images"] || [],
      price: x.price || { EUR: x.price_eur, USD: x.price_usd },
    })).map(p => ({
      ...p,
      diameter: (p.diameter == null ? null : Number(p.diameter)),
    }));
  }

  function buildDiameterFilter(){
    const set = new Set();
    for (const p of products){
      const d = Number(p.diameter);
      if (Number.isFinite(d)) set.add(d);
    }
    const diameters = [...set].sort((a,b)=>a-b);

    updateSelectedPill();

    const makeItem = ({label, sub, value, isAll=false}) => {
      const div = document.createElement("div");
      const active = isAll ? (selectedDiameters.size === 0) : selectedDiameters.has(value);
      div.className = "item" + (active ? " active" : "");
      div.innerHTML = `${escapeHtml(label)}<small>${escapeHtml(sub)}</small>`;

      div.addEventListener("click", () => {
        if (isAll){
          selectedDiameters.clear();
        } else {
          if (selectedDiameters.has(value)) selectedDiameters.delete(value);
          else selectedDiameters.add(value);
        }
        buildDiameterFilter();
        applyFilters();
      });

      return div;
    };

    elDiameters.innerHTML = "";
    elDiameters.appendChild(makeItem({ label:"All", sub:"Any size", value:null, isAll:true }));

    for (const d of diameters){
      elDiameters.appendChild(makeItem({ label:`Ø ${d}`, sub:"Exact", value:d }));
    }
  }

  // ✅ clear button
  elClearDiameters.addEventListener("click", (e) => {
    e.preventDefault();
    selectedDiameters.clear();
    buildDiameterFilter();
    applyFilters();
  });

  async function loadProducts(){
    try{
      const r = await fetch(API_PRODUCTS, { method:"GET" });
      if (r.ok){
        const data = await r.json();
        products = normalizeProducts(data);
        buildDiameterFilter();
        applyFilters();
        return;
      }
    }catch(_){}

    products = [];
    buildDiameterFilter();
    applyFilters();
  }

  elQ.addEventListener("input", applyFilters);
  elStock.addEventListener("change", applyFilters);
  elCurrency.addEventListener("change", render);

  loadProducts();
</script>
</body>
</html>