<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mosaic Pins</title>
  <style>
    :root{
      --bg:#0b0d11;
      --panel:#11141b;
      --panel2:#0f1218;
      --text:#e9eef7;
      --muted:#a8b3c7;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 30px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1100px 700px at 35% -10%, rgba(50,220,150,.25), transparent 55%),
                  radial-gradient(900px 600px at 75% 10%, rgba(120,90,255,.22), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* Layout */
    .app{display:grid; grid-template-columns: 280px 1fr; height:100vh; gap:16px; padding:16px;}

    /* Sidebar */
    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;

      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .sb-top{
      padding:18px 18px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex:0 0 auto;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px;}
    .dot{width:10px;height:10px;border-radius:50%; background:linear-gradient(135deg,#22c55e,#60a5fa);}
    .pill{
      padding:8px 10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .sb-nav{padding:6px; display:grid; gap:6px; flex:0 0 auto;}
    .nav-item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:12px;
      color:var(--muted);
      text-decoration:none;
      border:1px solid transparent;
    }
    .nav-item:hover{background:rgba(255,255,255,.05); color:var(--text);}
    .nav-item.active{
      background:rgba(34,197,94,.12);
      border-color: rgba(34,197,94,.22);
      color:var(--text);
    }

    .sb-scroll{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding:6px;
      padding-bottom:10px;
    }
    .sb-section{
      padding:14px 12px 10px;
      display:flex; align-items:center; justify-content:space-between;
      color:var(--muted);
      font-size:12px;
      letter-spacing:.6px;
      text-transform:uppercase;
    }

    /* Selected pill (desktop sidebar) */
    .selectedWrap{
      padding:0 6px 10px;
      display:none;
    }
    .selectedBar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;

      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(34,197,94,.25);
      background:rgba(34,197,94,.10);
    }
    .selectedLeft{min-width:0;}
    .selectedTitle{
      font-size:12px;
      font-weight:900;
      color:var(--text);
      margin:0 0 4px;
      letter-spacing:.2px;
    }
    .selectedList{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:180px;
    }
    .clearBtn{
      flex:0 0 auto;
      border:none;
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:900;
      line-height:1;
    }
    .clearBtn:hover{background:rgba(255,255,255,.06)}

    .list{
      display:grid;
      gap:6px;
      padding:0 0 10px;
    }
    .item{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .item:hover{background:rgba(255,255,255,.05)}
    .item small{display:block; color:var(--muted); margin-top:4px}
    .item.active{
      background:rgba(34,197,94,.12);
      border-color: rgba(34,197,94,.22);
    }

    /* Main */
    .main{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .topbar{
      padding:16px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
      flex:0 0 auto;
    }
    .top-left{display:flex; align-items:center; gap:10px; min-width:0}
    .h-title{font-weight:900; font-size:18px; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .sub{color:var(--muted); font-size:12px; margin-top:4px}

    .search{
      flex:1; max-width:520px; min-width:220px;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
    }
    .search input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:14px;
    }
    .top-right{display:flex; align-items:center; gap:10px}

    .toggle{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
      user-select:none;
      cursor:pointer;
    }
    .toggle input{accent-color:#22c55e; width:16px; height:16px}
    .currency{
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-size:13px;
      outline:none;
    }

    /* âœ… Filters button (mobile only) */
    .filtersBtn{
      display:none;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
    }
    .filtersBtn:hover{background:rgba(255,255,255,.06)}
    .filtersBadge{
      padding:4px 8px;
      border-radius:999px;
      background:rgba(34,197,94,.18);
      border:1px solid rgba(34,197,94,.25);
      color:var(--text);
      font-size:12px;
      font-weight:900;
      line-height:1;
    }

    /* âœ… Cart button */
    .cartBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
    }
    .cartBtn:hover{background:rgba(255,255,255,.06)}
    .cartBadge{
      padding:4px 8px;
      border-radius:999px;
      background:rgba(34,197,94,.18);
      border:1px solid rgba(34,197,94,.25);
      color:var(--text);
      font-size:12px;
      font-weight:900;
      line-height:1;
      min-width:24px;
      text-align:center;
    }

    .content{padding:18px; overflow:auto; min-height:0;}
    .grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:14px;
    }
    @media (max-width:1200px){ .grid{grid-template-columns:repeat(4,1fr)} }

    @media (max-width:980px){
      body{overflow:auto}
      .app{grid-template-columns:1fr; height:auto; min-height:100vh}
      .sidebar{display:none}
      .main{height:auto; min-height:100vh}

      .topbar{flex-wrap:wrap; gap:10px}
      .top-left{width:100%}
      .search{order:3; width:100%; max-width:none; min-width:0}
      .top-right{order:2; width:100%; justify-content:space-between}

      .filtersBtn{display:inline-flex}
      .content{padding:14px}
      .grid{grid-template-columns:repeat(2, minmax(0, 1fr)); gap:12px}
    }
    @media (max-width:520px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
      transition: transform .15s ease, background .15s ease;
      cursor:pointer;
    }
    .card:hover{transform: translateY(-2px); background:rgba(255,255,255,.04)}
    .thumb{
      aspect-ratio: 1/1;
      background:linear-gradient(135deg, rgba(34,197,94,.14), rgba(96,165,250,.10));
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .badge{
      position:absolute; left:10px; top:10px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.35);
      color:var(--text);
      backdrop-filter: blur(6px);
    }
    .sold{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.25)}
    .meta{padding:12px}
    .name{font-weight:800; font-size:14px; margin:0 0 6px}
    .desc{margin:0; color:var(--muted); font-size:12px; line-height:1.35; height:32px; overflow:hidden}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px}
    .price{font-weight:900}
    .btn{
      border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#07110b;
      font-weight:900;
      box-shadow: 0 10px 18px rgba(34,197,94,.18);
      transition: filter .15s ease, transform .15s ease;
      white-space:nowrap;
    }
    .btn:hover{filter:brightness(1.05); transform: translateY(-1px)}
    .btn:disabled{
      cursor:not-allowed;
      background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.55);
      box-shadow:none;
    }

    /* Add to cart button */
    .btn2{
      border:none; cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:900;
      transition: background .15s ease, transform .15s ease;
      white-space:nowrap;
    }
    .btn2:hover{background:rgba(255,255,255,.10); transform: translateY(-1px)}
    .btn2:disabled{opacity:.45; cursor:not-allowed}

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(0,0,0,.55);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 14px;
      color: var(--text);
      box-shadow: var(--shadow);
      max-width: 360px;
      display:none;
      z-index:999;
    }
    .toast.show{display:block}
    .toast small{color:var(--muted)}

    /* âœ… Mobile Filters Sheet */
    .sheetBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      z-index:1000;
    }
    .sheetBack.show{display:block}

    .sheet{
      position:fixed;
      left:0; right:0; bottom:0;
      border-top-left-radius:18px;
      border-top-right-radius:18px;
      border:1px solid var(--line);
      /* darker */
      background: linear-gradient(180deg, rgba(0,0,0,.85), rgba(0,0,0,.68));
      box-shadow: 0 -18px 40px rgba(0,0,0,.45);
      transform: translateY(100%);
      transition: transform .18s ease;
      z-index:1001;

      max-height: 82vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .sheet.show{transform: translateY(0)}
    .sheetHead{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
    }
    .sheetTitle{
      font-weight:950;
      letter-spacing:.2px;
    }
    .sheetClose{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:950;
      line-height:1;
    }
    .sheetClose:hover{background:rgba(255,255,255,.06)}
    .sheetBody{
      padding:12px;
      overflow:auto;
      min-height:0;
    }
    .mSelectedWrap{display:none; margin-bottom:10px;}
    .mList .item{padding:12px 12px; border-radius:14px;}

    /* âœ… Cart Drawer */
    .cartBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      z-index:1100;
    }
    .cartBack.show{display:block}
    .cartDrawer{
      position:fixed;
      top:0; right:0; bottom:0;
      width:min(420px, 92vw);
      border-left:1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,0,0,.88), rgba(0,0,0,.70));
      box-shadow: -18px 0 40px rgba(0,0,0,.50);
      transform: translateX(100%);
      transition: transform .18s ease;
      z-index:1101;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .cartDrawer.show{transform: translateX(0)}
    .cartHead{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
    }
    .cartTitle{font-weight:950; letter-spacing:.2px;}
    .cartClose{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:950;
      line-height:1;
    }
    .cartClose:hover{background:rgba(255,255,255,.06)}
    .cartBody{
      padding:12px;
      overflow:auto;
      min-height:0;
    }
    .cartEmpty{
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.04);
      color:var(--muted);
    }
    .cartItem{
      display:grid;
      grid-template-columns:64px 1fr;
      gap:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      margin-bottom:10px;
    }
    .cartImg{
      width:64px;height:64px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      color:var(--muted);
      font-size:12px;
    }
    .cartImg img{width:100%;height:100%;object-fit:cover;display:block;}
    .cartName{font-weight:900; font-size:13px; margin:0}
    .cartMeta{color:var(--muted); font-size:12px; margin:4px 0 0}
    .cartRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top:10px;
    }
    .cartQty{
      display:flex; align-items:center; gap:6px;
      padding:6px 8px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
    }
    .cartQty button{
      width:30px;height:30px;border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .cartQty input{
      width:44px;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      text-align:center;
      font-weight:900;
    }
    .cartRemove{
      border:none;
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:900;
      line-height:1;
    }
    .cartRemove:hover{background:rgba(255,255,255,.06)}
    .cartFoot{
      padding:12px;
      border-top:1px solid var(--line);
      background:rgba(0,0,0,.35);
    }
    .cartSumRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
      color:var(--text);
      font-weight:950;
    }
    .cartActions{
      display:grid;
      gap:10px;
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand"><span class="dot"></span> Mosaic Pins</div>
        <div class="pill" id="sbCount">â€” items</div>
      </div>

      <nav class="sb-nav">
        <a class="nav-item active" href="#" id="navShop">Shop</a>
        <a class="nav-item" href="#" id="navAbout">About</a>
        <a class="nav-item" href="#" id="navShipping">Shipping</a>
        <a class="nav-item" href="#" id="navReturns">Returns</a>
      </nav>

      <div class="sb-scroll">
        <div class="sb-section">
          <span>Ã˜</span>
          <span class="pill" id="diaCount">0</span>
        </div>

        <div class="selectedWrap" id="selectedWrap">
          <div class="selectedBar">
            <div class="selectedLeft">
              <div class="selectedTitle">Selected</div>
              <div class="selectedList" id="selectedList">â€”</div>
            </div>
            <button class="clearBtn" id="clearDiameters" title="Clear">âœ•</button>
          </div>
        </div>

        <div class="list" id="diameters"></div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="top-left">
          <div>
            <h1 class="h-title">Shop</h1>
            <div class="sub">Handmade mosaic pins for custom knife handles</div>
          </div>
        </div>

        <div class="search" title="Search by title or PIN code">
          <span style="color:var(--muted);">âŒ•</span>
          <input id="q" placeholder="Search pins (e.g. G10N11gt, Mosaic, Brassâ€¦)" />
        </div>

        <div class="top-right">
          <!-- âœ… mobile only -->
          <button class="filtersBtn" id="openFilters" type="button" title="Filters">
            Filters <span class="filtersBadge" id="filtersBadge">0</span>
          </button>

          <!-- âœ… cart -->
          <button class="cartBtn" id="openCart" type="button" title="Cart">
            ðŸ›’ Cart <span class="cartBadge" id="cartBadge">0</span>
          </button>

          <label class="toggle" title="Show only in-stock pins">
            <input id="inStockOnly" type="checkbox" />
            In stock
          </label>

          <select class="currency" id="currency" title="Currency">
            <option value="EUR">EUR â‚¬</option>
            <option value="USD">USD $</option>
          </select>
        </div>
      </div>

      <div class="content">
        <div class="grid" id="grid"></div>
      </div>
    </main>
  </div>

  <!-- âœ… Mobile Filters Sheet -->
  <div class="sheetBack" id="sheetBack"></div>
  <div class="sheet" id="sheet">
    <div class="sheetHead">
      <div class="sheetTitle">Filters</div>
      <button class="sheetClose" id="closeFilters" type="button">âœ•</button>
    </div>
    <div class="sheetBody">
      <div class="mSelectedWrap" id="mSelectedWrap">
        <div class="selectedBar">
          <div class="selectedLeft">
            <div class="selectedTitle">Selected</div>
            <div class="selectedList" id="mSelectedList">â€”</div>
          </div>
          <button class="clearBtn" id="mClearDiameters" title="Clear">âœ•</button>
        </div>
      </div>

      <div class="sb-section" style="padding:10px 2px 8px;">
        <span>Diameter (Ã˜)</span>
        <span class="pill" id="mDiaCount">0</span>
      </div>

      <div class="list mList" id="mDiameters"></div>
    </div>
  </div>

  <!-- âœ… Cart Drawer -->
  <div class="cartBack" id="cartBack"></div>
  <div class="cartDrawer" id="cartDrawer">
    <div class="cartHead">
      <div class="cartTitle">Cart</div>
      <button class="cartClose" id="closeCart" type="button">âœ•</button>
    </div>
    <div class="cartBody" id="cartBody"></div>
    <div class="cartFoot">
      <div class="cartSumRow">
        <div>Total</div>
        <div id="cartTotal">â€”</div>
      </div>
      <div class="cartActions">
        <button class="btn" id="cartCheckout">Checkout</button>
        <button class="btn2" id="cartClear">Clear cart</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div style="font-weight:800" id="toastTitle">Notice</div>
    <small id="toastMsg">â€”</small>
  </div>

<script>
  const API_PRODUCTS = "/api/products";

  // âœ… Cart checkout endpoint (main + fallback)
  const API_CHECKOUT_CART_PRIMARY = "/api/checkout-cart";
  const API_CHECKOUT_CART_FALLBACK = "/api/checkout";

  // ========= CART (localStorage) =========
  const CART_KEY = "mp_cart"; // [{pin, qty, title, image, price, stock}]
  function readCart(){
    try{
      const raw = localStorage.getItem(CART_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(_){ return []; }
  }
  function writeCart(arr){ localStorage.setItem(CART_KEY, JSON.stringify(arr)); }
  function cartCount(){ return readCart().reduce((s,it)=>s+(Number(it?.qty)||0),0); }

  // ========= STATE =========
  let products = [];
  let filtered = [];
  const selectedDiameters = new Set(); // numbers

  const elGrid = document.getElementById("grid");
  const elQ = document.getElementById("q");
  const elStock = document.getElementById("inStockOnly");
  const elCurrency = document.getElementById("currency");
  const elSbCount = document.getElementById("sbCount");

  // desktop diameter UI
  const elDiaCount = document.getElementById("diaCount");
  const elDiameters = document.getElementById("diameters");
  const elSelectedWrap = document.getElementById("selectedWrap");
  const elSelectedList = document.getElementById("selectedList");
  const elClearDiameters = document.getElementById("clearDiameters");

  // mobile filters sheet
  const elOpenFilters = document.getElementById("openFilters");
  const elFiltersBadge = document.getElementById("filtersBadge");
  const elSheetBack = document.getElementById("sheetBack");
  const elSheet = document.getElementById("sheet");
  const elCloseFilters = document.getElementById("closeFilters");
  const elMDiaCount = document.getElementById("mDiaCount");
  const elMDiameters = document.getElementById("mDiameters");
  const elMSelectedWrap = document.getElementById("mSelectedWrap");
  const elMSelectedList = document.getElementById("mSelectedList");
  const elMClearDiameters = document.getElementById("mClearDiameters");

  // cart drawer
  const elOpenCart = document.getElementById("openCart");
  const elCartBadge = document.getElementById("cartBadge");
  const elCartBack = document.getElementById("cartBack");
  const elCartDrawer = document.getElementById("cartDrawer");
  const elCloseCart = document.getElementById("closeCart");
  const elCartBody = document.getElementById("cartBody");
  const elCartTotal = document.getElementById("cartTotal");
  const elCartCheckout = document.getElementById("cartCheckout");
  const elCartClear = document.getElementById("cartClear");

  // toast
  const elToast = document.getElementById("toast");
  const elToastTitle = document.getElementById("toastTitle");
  const elToastMsg = document.getElementById("toastMsg");

  function toast(title, msg){
    elToastTitle.textContent = title;
    elToastMsg.textContent = msg;
    elToast.classList.add("show");
    setTimeout(()=> elToast.classList.remove("show"), 2400);
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function priceText(priceObj){
    const cur = elCurrency.value;
    const v = priceObj?.[cur];
    if (typeof v !== "number") return cur === "EUR" ? "â€” â‚¬" : "â€” $";
    return cur === "EUR" ? `${v.toFixed(2)} â‚¬` : `${v.toFixed(2)} $`;
  }

  // ===== Filters sheet open/close =====
  function openSheet(){
    elSheetBack.classList.add("show");
    elSheet.classList.add("show");
    document.body.style.overflow = "hidden";
  }
  function closeSheet(){
    elSheetBack.classList.remove("show");
    elSheet.classList.remove("show");
    document.body.style.overflow = "";
  }
  elOpenFilters.addEventListener("click", openSheet);
  elCloseFilters.addEventListener("click", closeSheet);
  elSheetBack.addEventListener("click", closeSheet);

  // ===== Cart drawer open/close =====
  function openCart(){
    elCartBack.classList.add("show");
    elCartDrawer.classList.add("show");
    document.body.style.overflow = "hidden";
    renderCart();
  }
  function closeCart(){
    elCartBack.classList.remove("show");
    elCartDrawer.classList.remove("show");
    document.body.style.overflow = "";
  }
  elOpenCart.addEventListener("click", openCart);
  elCloseCart.addEventListener("click", closeCart);
  elCartBack.addEventListener("click", closeCart);
  window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeCart(); });

  function updateCartBadge(){
    elCartBadge.textContent = String(cartCount());
  }

  // ===== Cart helpers =====
  function addToCartFromProduct(p, qty){
    qty = Number(qty);
    if (!Number.isFinite(qty) || qty <= 0) qty = 1;

    const stock = Number(p.stock ?? 0);
    if (stock <= 0){
      toast("Cart", "Sold out");
      return;
    }

    const cart = readCart();
    const idx = cart.findIndex(x => String(x.pin) === String(p.pin));

    if (idx >= 0){
      const next = Math.min(stock, (Number(cart[idx].qty)||0) + qty);
      cart[idx].qty = next;
      cart[idx].stock = stock;
      cart[idx].title = p.title;
      cart[idx].image = (p.images && p.images[0]) ? p.images[0] : (cart[idx].image || "");
      cart[idx].price = p.price || cart[idx].price || {};
    } else {
      cart.push({
        pin: String(p.pin),
        qty: Math.min(stock, qty),
        title: String(p.title || p.pin),
        image: (p.images && p.images[0]) ? p.images[0] : "",
        price: p.price || {},
        stock: stock
      });
    }

    writeCart(cart);
    updateCartBadge();
    renderCart();
    toast("Cart", "Added âœ…");
  }

  function setCartQty(pin, qty){
    const cart = readCart();
    const idx = cart.findIndex(x => String(x.pin) === String(pin));
    if (idx < 0) return;

    const stock = Number(cart[idx].stock ?? 0);
    qty = Number(qty);
    if (!Number.isFinite(qty)) qty = 1;
    qty = Math.max(1, qty);
    if (stock > 0) qty = Math.min(stock, qty);

    cart[idx].qty = qty;
    writeCart(cart);
    updateCartBadge();
    renderCart();
  }

  function removeFromCart(pin){
    const cart = readCart().filter(x => String(x.pin) !== String(pin));
    writeCart(cart);
    updateCartBadge();
    renderCart();
  }

  function clearCart(){
    writeCart([]);
    updateCartBadge();
    renderCart();
  }

  function cartTotal(){
    const cur = elCurrency.value;
    const cart = readCart();
    let sum = 0;
    for (const it of cart){
      const unit = Number(it?.price?.[cur]);
      if (Number.isFinite(unit)) sum += unit * (Number(it?.qty)||0);
    }
    return sum;
  }

  function renderCart(){
    const cart = readCart();
    if (!cart.length){
      elCartBody.innerHTML = `<div class="cartEmpty">Your cart is empty.</div>`;
      elCartTotal.textContent = "â€”";
      elCartCheckout.disabled = true;
      return;
    }

    elCartCheckout.disabled = false;

    elCartBody.innerHTML = cart.map(it => {
      const img = it.image ? `<img src="${it.image}" alt="${escapeHtml(it.title)}" />` : `<span>â€”</span>`;
      const cur = elCurrency.value;
      const unit = it?.price?.[cur];
      const unitText = (typeof unit === "number") ? (cur==="EUR" ? `${unit.toFixed(2)} â‚¬` : `${unit.toFixed(2)} $`) : "â€”";
      return `
        <div class="cartItem" data-pin="${escapeHtml(it.pin)}">
          <div class="cartImg">${img}</div>
          <div>
            <p class="cartName">${escapeHtml(it.title || it.pin)}</p>
            <div class="cartMeta">${escapeHtml(it.pin)} â€¢ ${unitText}</div>
            <div class="cartRow">
              <div class="cartQty">
                <button type="button" data-act="minus">âˆ’</button>
                <input value="${escapeHtml(it.qty)}" inputmode="numeric" />
                <button type="button" data-act="plus">+</button>
              </div>
              <button class="cartRemove" type="button" data-act="remove">âœ•</button>
            </div>
            <div class="cartMeta" style="margin-top:8px;">Stock: ${escapeHtml(it.stock ?? "â€”")}</div>
          </div>
        </div>
      `;
    }).join("");

    [...elCartBody.querySelectorAll(".cartItem")].forEach(row => {
      const pin = row.getAttribute("data-pin");
      const input = row.querySelector("input");
      const btnMinus = row.querySelector('button[data-act="minus"]');
      const btnPlus  = row.querySelector('button[data-act="plus"]');
      const btnRem   = row.querySelector('button[data-act="remove"]');

      btnMinus.addEventListener("click", () => setCartQty(pin, Number(input.value) - 1));
      btnPlus.addEventListener("click",  () => setCartQty(pin, Number(input.value) + 1));
      input.addEventListener("input", () => {
        const v = Number(input.value);
        if (!Number.isFinite(v)) return;
        setCartQty(pin, v);
      });
      btnRem.addEventListener("click", () => removeFromCart(pin));
    });

    const sum = cartTotal();
    const cur = elCurrency.value;
    elCartTotal.textContent = (cur==="EUR") ? `${sum.toFixed(2)} â‚¬` : `${sum.toFixed(2)} $`;
  }

  elCartClear.addEventListener("click", () => { clearCart(); toast("Cart", "Cleared"); });

  async function postCheckoutCart(endpoint){
    const cart = readCart();
    const items = cart
      .map(it => ({
        pin: String(it.pin || "").trim(),
        quantity: Number(it.qty || 0)
      }))
      .filter(it => it.pin && Number.isFinite(it.quantity) && it.quantity > 0);

    if (!items.length){
      toast("Cart", "Cart is empty");
      return null;
    }

    const currency = (elCurrency.value || "EUR").toUpperCase();

    const res = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ currency, items })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok){
      const msg = data?.error || "Checkout failed";
      const details = data?.details ? (" " + (typeof data.details === "string" ? data.details : JSON.stringify(data.details))) : "";
      throw new Error(msg + details);
    }
    return data;
  }

  elCartCheckout.addEventListener("click", async () => {
    const prevText = elCartCheckout.textContent;
    elCartCheckout.disabled = true;
    elCartCheckout.textContent = "Openingâ€¦";
    toast("Checkout", "Opening Stripeâ€¦");

    try{
      // try primary
      let out = null;
      try{
        out = await postCheckoutCart(API_CHECKOUT_CART_PRIMARY);
      }catch(err){
        // fallback only if primary endpoint not present / route mismatch
        out = await postCheckoutCart(API_CHECKOUT_CART_FALLBACK);
      }

      if (out?.url){
        window.location.href = out.url;
        return;
      }

      throw new Error(out?.error || "Missing checkout url");
    }catch(e){
      toast("Error", String(e?.message || e));
      elCartCheckout.disabled = false;
      elCartCheckout.textContent = prevText;
    }
  });

  // ===== Diameter filter UI =====
  function updateSelectedUI(){
    const arr = [...selectedDiameters].sort((a,b)=>a-b);

    elDiaCount.textContent = String(arr.length);
    elMDiaCount.textContent = String(arr.length);
    elFiltersBadge.textContent = String(arr.length);

    const text = (arr.length ? arr.map(d => `Ã˜${d}`).join(", ") : "â€”");

    if (arr.length === 0){
      elSelectedWrap.style.display = "none";
      elSelectedList.textContent = "â€”";
    } else {
      elSelectedWrap.style.display = "block";
      elSelectedList.textContent = text;
    }

    if (arr.length === 0){
      elMSelectedWrap.style.display = "none";
      elMSelectedList.textContent = "â€”";
    } else {
      elMSelectedWrap.style.display = "block";
      elMSelectedList.textContent = text;
    }
  }

  function applyFilters(){
    const q = (elQ.value || "").trim().toLowerCase();
    const inStockOnly = elStock.checked;

    filtered = products.filter(p => {
      if (selectedDiameters.size > 0) {
        const d = Number(p.diameter);
        if (!Number.isFinite(d) || !selectedDiameters.has(d)) return false;
      }
      if (inStockOnly && !(Number(p.stock||0) > 0)) return false;

      if (!q) return true;
      const hay = `${p.pin} ${p.title} ${(p.materials||[]).join(" ")} ${(p.diameter||"")}`.toLowerCase();
      return hay.includes(q);
    });

    render();
  }

  function cardTemplate(p){
    const img = (p.images && p.images[0]) ? `<img src="${p.images[0]}" alt="${escapeHtml(p.title)}" />` : "";
    const soldOut = !(Number(p.stock||0) > 0);

    return `
      <div class="card" data-open="${escapeHtml(p.pin)}">
        <div class="thumb">
          ${img}
          <div class="badge ${soldOut ? "sold" : ""}">${soldOut ? "Sold out" : `In stock: ${p.stock}`}</div>
        </div>
        <div class="meta">
          <p class="name">${escapeHtml(p.title)} <span style="color:var(--muted); font-weight:700;">â€¢ ${escapeHtml(p.pin)}</span></p>
          <p class="desc">${escapeHtml(p.description || "")}</p>
          <div class="row">
            <div>
              <div class="price">${priceText(p.price)}</div>
              <div style="color:var(--muted); font-size:12px; margin-top:2px;">Ã˜ ${p.diameter ?? "â€”"}</div>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn2" ${soldOut ? "disabled" : ""} data-add="${escapeHtml(p.pin)}" title="Add to cart">ï¼‹</button>
              <button class="btn" ${soldOut ? "disabled" : ""} data-openbuy="${escapeHtml(p.pin)}">Buy</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function render(){
    elSbCount.textContent = `${filtered.length} items`;
    elGrid.innerHTML = filtered.map(cardTemplate).join("");

    // Add to cart
    [...document.querySelectorAll("button[data-add]")].forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const pin = btn.getAttribute("data-add");
        const p = products.find(x => String(x.pin) === String(pin));
        if (!p) return;
        addToCartFromProduct(p, 1);
      });
    });

    // Buy -> product page
    [...document.querySelectorAll("button[data-openbuy]")].forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const pin = btn.getAttribute("data-openbuy");
        window.location.href = `/product.html?pin=${encodeURIComponent(pin)}`;
      });
    });

    // Open product on card click
    [...document.querySelectorAll(".card[data-open]")].forEach(card => {
      card.addEventListener("click", () => {
        const pin = card.getAttribute("data-open");
        window.location.href = `/product.html?pin=${encodeURIComponent(pin)}`;
      });
    });
  }

  function normalizeProducts(data){
    const arr = Array.isArray(data) ? data : (data.products || []);
    return arr.map(x => ({
      pin: x.pin || x.pin_code || x.PIN || x["PIN Code"] || "â€”",
      title: x.title || x.name || "Untitled",
      description: x.description || "",
      diameter: (x.diameter ?? x.diameter_mm ?? x["Diameter"] ?? null),
      materials: x.materials || x["Materials"] || [],
      stock: (x.stock ?? x["Stock"] ?? 0),
      images: x.images || x["Images"] || [],
      price: x.price || { EUR: x.price_eur, USD: x.price_usd },
    })).map(p => ({ ...p, diameter: (p.diameter == null ? null : Number(p.diameter)) }));
  }

  function buildDiameterLists(){
    const set = new Set();
    for (const p of products){
      const d = Number(p.diameter);
      if (Number.isFinite(d)) set.add(d);
    }
    const diameters = [...set].sort((a,b)=>a-b);

    const buildInto = (container) => {
      container.innerHTML = "";

      const makeItem = ({label, sub, value, isAll=false}) => {
        const div = document.createElement("div");
        const active = isAll ? (selectedDiameters.size === 0) : selectedDiameters.has(value);
        div.className = "item" + (active ? " active" : "");
        div.innerHTML = `${escapeHtml(label)}<small>${escapeHtml(sub)}</small>`;

        div.addEventListener("click", () => {
          if (isAll){
            selectedDiameters.clear();
          } else {
            if (selectedDiameters.has(value)) selectedDiameters.delete(value);
            else selectedDiameters.add(value);
          }
          updateSelectedUI();
          buildDiameterLists();
          applyFilters();
        });

        return div;
      };

      container.appendChild(makeItem({ label:"All", sub:"Any size", value:null, isAll:true }));
      for (const d of diameters){
        container.appendChild(makeItem({ label:`Ã˜ ${d}`, sub:"Exact", value:d }));
      }
    };

    buildInto(elDiameters);
    buildInto(elMDiameters);
    updateSelectedUI();
  }

  function clearDiameters(){
    selectedDiameters.clear();
    updateSelectedUI();
    buildDiameterLists();
    applyFilters();
  }

  elClearDiameters.addEventListener("click", (e) => { e.preventDefault(); clearDiameters(); });
  elMClearDiameters.addEventListener("click", (e) => { e.preventDefault(); clearDiameters(); });

  async function loadProducts(){
    try{
      const r = await fetch(API_PRODUCTS, { method:"GET" });
      if (r.ok){
        const data = await r.json();
        products = normalizeProducts(data);
        buildDiameterLists();
        applyFilters();

        // sync cart meta (title/image/price/stock) with latest products
        const cart = readCart();
        if (cart.length){
          const next = cart.map(it => {
            const p = products.find(x => String(x.pin) === String(it.pin));
            if (!p) return it;
            return {
              ...it,
              title: p.title,
              image: (p.images && p.images[0]) ? p.images[0] : (it.image || ""),
              price: p.price || it.price || {},
              stock: Number(p.stock ?? it.stock ?? 0)
            };
          });
          writeCart(next);
        }

        updateCartBadge();
        renderCart();
        return;
      }
    }catch(_){}

    products = [];
    buildDiameterLists();
    applyFilters();
    updateCartBadge();
    renderCart();
  }

  // Events
  elQ.addEventListener("input", applyFilters);
  elStock.addEventListener("change", applyFilters);
  elCurrency.addEventListener("change", () => { render(); renderCart(); });

  window.addEventListener("resize", () => {
    if (window.innerWidth > 980) closeSheet();
  });

  // init
  updateCartBadge();
  renderCart();
  loadProducts();
</script>
</body>
</html>