<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Product ‚Ä¢ Mosaic Pins</title>
  <style>
    :root{
      --bg:#0b0d11;
      --text:#e9eef7;
      --muted:#a8b3c7;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 30px rgba(0,0,0,.45);
      --r:18px;

      --overlay: rgba(0,0,0,.72);
      --overlay2: rgba(0,0,0,.82);
      --panel: rgba(0,0,0,.28);
      --panelHover: rgba(255,255,255,.05);
    }

    *{box-sizing:border-box}

    *{ -webkit-tap-highlight-color: rgba(0,0,0,0); }
    html{ -webkit-tap-highlight-color: rgba(0,0,0,0); }
    a, button, input, select, textarea{ -webkit-tap-highlight-color: rgba(0,0,0,0); }
    button, a{ touch-action: manipulation; -webkit-user-select:none; user-select:none; }
    button:focus{ outline:none; }
    :focus:not(:focus-visible){ outline:none; }
    button::-moz-focus-inner{ border:0; }

    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1100px 700px at 35% -10%, rgba(50,220,150,.25), transparent 55%),
                  radial-gradient(900px 600px at 75% 10%, rgba(120,90,255,.22), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow:hidden;
      overscroll-behavior: none;
    }

    *{
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.18) rgba(0,0,0,.25);
    }
    *::-webkit-scrollbar{width:10px;height:10px}
    *::-webkit-scrollbar-track{background:rgba(0,0,0,.25); border-radius:999px}
    *::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18); border-radius:999px; border:2px solid rgba(0,0,0,.25)}
    *::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.25)}

    .app{display:grid; grid-template-columns: 280px 1fr; height:100vh; gap:16px; padding:16px;}
    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sb-top{padding:18px 18px 10px; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px;}
    .dot{width:10px;height:10px;border-radius:50%; background:linear-gradient(135deg,#22c55e,#60a5fa);}
    .pill{padding:8px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--line); color:var(--muted); font-size:12px; white-space:nowrap;}

    .sb-nav{padding:6px; display:grid; gap:6px;}
    .nav-item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:12px;
      color:var(--muted); text-decoration:none; border:1px solid transparent;
    }
    .nav-item:hover{background:rgba(255,255,255,.05); color:var(--text);}
    .nav-item.active{background:rgba(34,197,94,.12); border-color: rgba(34,197,94,.22); color:var(--text);}

    .main{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column; min-width:0;
    }
    .topbar{
      padding:16px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
      flex-wrap:wrap;
    }
    .h-title{font-weight:900; font-size:18px; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .sub{color:var(--muted); font-size:12px; margin-top:4px}
    .topRight{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}

    .backBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.28);
      border:1px solid var(--line);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
      text-decoration:none;
      min-height:44px;
      line-height:1.1;
    }
    .backBtn:hover{background:rgba(255,255,255,.06)}

    .currency,
    .shipCountry{
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-size:13px;
      outline:none;
      white-space:nowrap;
      min-height:44px;
      appearance:none;
    }

    .cartBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.28);
      border:1px solid var(--line);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
      text-decoration:none;
      min-height:44px;
      line-height:1.1;
    }
    .cartBtn:hover{background:rgba(255,255,255,.06)}
    .cartBadge{
      padding:4px 8px;
      border-radius:999px;
      background:rgba(34,197,94,.18);
      border:1px solid rgba(34,197,94,.25);
      color:var(--text);
      font-size:12px;
      font-weight:900;
      line-height:1;
      min-width:24px;
      text-align:center;
    }

    .content{
      padding:18px;
      overflow:auto;
      min-height:0;
      overscroll-behavior: none;
      padding-bottom: calc(18px + max(34px, env(safe-area-inset-bottom, 0px)) + 40px);
    }

    .wrap{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      align-items:stretch;
    }

    @media (max-width:980px){
      .app{grid-template-columns:1fr}
      .sidebar{display:none}
      body{overflow:auto}
      .main{height:auto; min-height:100vh}
      .wrap{grid-template-columns:1fr; align-items:start;}
      .content{
        padding:14px;
        overflow:auto;
        padding-bottom: calc(14px + max(44px, env(safe-area-inset-bottom, 0px)) + 56px);
      }
    }

    .panel{
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      border-radius:16px;
      overflow:hidden;
    }

    #rightPanel{
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    #rightPanel .details{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
    }

    .gallery{padding:12px; display:grid; gap:10px;}

    .hero{
      aspect-ratio: 1/1;
      border-radius:14px;
      overflow:hidden;
      background:linear-gradient(135deg, rgba(34,197,94,.14), rgba(96,165,250,.10));
      border:1px solid var(--line);
      position:relative;
      perspective: 900px;
      user-select:none;
      touch-action: pan-y;
    }

    .hero-inner{
      width:100%;
      height:100%;
      transform-style: preserve-3d;
      will-change: transform;
    }
    .carousel{
      width:100%;
      height:100%;
      overflow-x:auto;
      overflow-y:hidden;
      display:flex;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
      user-select:none;
      cursor: grab;
    }
    .carousel::-webkit-scrollbar{display:none;}
    .carousel.dragging{cursor: grabbing;}
    .slide{flex: 0 0 100%; width:100%; height:100%; scroll-snap-align:center;}
    .slide img{width:100%; height:100%; object-fit:cover; display:block; pointer-events:none;}
    .heroEmpty{width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--muted);}

    .navBtn{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.55);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      backdrop-filter: blur(10px);
      transition: transform .15s ease, filter .15s ease, opacity .15s ease;
      opacity:.95;
      user-select:none;
      z-index:5;
    }
    .navBtn:hover{filter:brightness(1.1); transform:translateY(-50%) scale(1.03)}
    .navBtn:active{transform:translateY(-50%) scale(.98)}
    .navPrev{left:10px;}
    .navNext{right:10px;}
    .navBtn[disabled]{opacity:.35; cursor:not-allowed;}
    @media (max-width:980px){ .navBtn{display:none;} }

    .counter{
      position:absolute;
      left:10px;
      bottom:10px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.55);
      color:var(--text);
      backdrop-filter: blur(10px);
      z-index:5;
      display:none;
    }

    .thumbs{display:flex; gap:10px; overflow:auto; padding-bottom:4px;}

    .t{
      width:72px; height:72px; border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      overflow:hidden; cursor:pointer;
      flex:0 0 auto;
      opacity:.8;
    }
    .t.active{outline:2px solid rgba(34,197,94,.45); opacity:1}
    .t img{width:100%; height:100%; object-fit:cover; display:block;}

    .details{padding:16px;}
    .kicker{color:var(--muted); font-size:12px}
    .title{font-size:22px; font-weight:950; margin:6px 0 8px;}

    .meta{
      color:var(--muted);
      font-size:13px;
      line-height:1.65;
      white-space: pre-wrap;
      word-break: break-word;
      margin-top:8px;
    }

    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px;}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      font-size:12px;
    }

    .priceRow{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      margin:16px 0 10px;
    }
    .price{font-size:20px; font-weight:950;}
    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.55);
      color:var(--text);
      backdrop-filter: blur(10px);
    }
    .sold{background:rgba(239,68,68,.22); border-color:rgba(239,68,68,.28)}

    .actions{display:grid; gap:10px; margin-top:14px; position:relative; z-index:1;}
    .qtyRow{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .qtyRow label{color:var(--muted); font-size:13px}
    .qty{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
    }
    .qty button{
      width:34px; height:34px; border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .qty input{
      width:52px;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:14px;
      text-align:center;
      font-weight:900;
    }

    .btn{
      border:none; cursor:pointer;
      padding:12px 14px;
      border-radius:12px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#07110b;
      font-weight:950;
      box-shadow: 0 10px 18px rgba(34,197,94,.18);
      transition: filter .15s ease, transform .15s ease;
      display:block;
      width:100%;
    }
    .btn:hover{filter:brightness(1.05); transform: translateY(-1px)}
    .btn:disabled{
      cursor:not-allowed;
      background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.55);
      box-shadow:none;
    }

    .btn2{
      border:none; cursor:pointer;
      padding:12px 14px;
      border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:950;
      transition: background .15s ease, transform .15s ease;
      display:block;
      width:100%;
    }
    .btn2:hover{background:rgba(255,255,255,.10); transform: translateY(-1px)}
    .btn2:disabled{opacity:.45; cursor:not-allowed}

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(0,0,0,.65);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 14px;
      color: var(--text);
      box-shadow: var(--shadow);
      max-width: 360px;
      display:none;
      z-index:999;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:block}
    .toast small{color:var(--muted)}

    .cartBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.74);
      display:none;
      z-index:1100;
      backdrop-filter: blur(6px);
    }
    .cartBack.show{display:block}
    .cartDrawer{
      position:fixed;
      top:0; right:0; bottom:0;
      width:min(420px, 92vw);
      border-left:1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,0,0,.92), rgba(0,0,0,.78));
      box-shadow: -18px 0 40px rgba(0,0,0,.60);
      transform: translateX(100%);
      transition: transform .18s ease;
      z-index:1101;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .cartDrawer.show{transform: translateX(0)}
    .cartHead{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
    }
    .cartTitle{font-weight:950; letter-spacing:.2px;}
    .cartClose{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.30);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:950;
      line-height:1;
    }
    .cartClose:hover{background:rgba(255,255,255,.06)}
    .cartBody{padding:12px; overflow:auto; min-height:0;}
    .cartEmpty{
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.04);
      color:var(--muted);
    }
    .cartItem{
      display:grid;
      grid-template-columns:64px 1fr;
      gap:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      margin-bottom:10px;
    }
    .cartImg{
      width:64px;height:64px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      color:var(--muted);
      font-size:12px;
    }
    .cartImg img{width:100%;height:100%;object-fit:cover;display:block;}
    .cartName{font-weight:900; font-size:13px; margin:0}
    .cartMeta{color:var(--muted); font-size:12px; margin:4px 0 0}
    .cartRow{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px;}
    .cartQty{
      display:flex; align-items:center; gap:6px;
      padding:6px 8px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
    }
    .cartQty button{
      width:30px;height:30px;border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .cartQty input{
      width:44px;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      text-align:center;
      font-weight:900;
    }
    .cartRemove{
      border:none;
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:900;
      line-height:1;
    }
    .cartRemove:hover{background:rgba(255,255,255,.06)}
    .cartFoot{
      padding:12px;
      border-top:1px solid var(--line);
      background:rgba(0,0,0,.40);
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
    }
    .cartSumRow{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; color:var(--text); font-weight:950;}
    .cartActions{display:grid; gap:10px;}

    @media (prefers-reduced-motion: reduce){
      .hero-inner{will-change:auto}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand"><span class="dot"></span> Mosaic Pins</div>
        <div class="pill" id="sbCount">Product</div>
      </div>

      <nav class="sb-nav">
        <a class="nav-item" href="/" id="navShop">‚Üê Back to shop</a>
        <a class="nav-item active" href="#" id="navProduct">Product</a>
      </nav>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <h1 class="h-title" id="hTitle">Loading‚Ä¶</h1>
          <div class="sub" id="hSub"></div>
        </div>

        <div class="topRight">
          <a class="backBtn" href="/" id="backTopShop" title="Back to shop">‚Üê Back to shop</a>

          <button class="cartBtn" id="openCart" type="button" title="Cart">
            üõí Cart <span class="cartBadge" id="cartBadge">0</span>
          </button>

          <select class="currency" id="currency" title="Currency">
            <option value="EUR">EUR ‚Ç¨</option>
            <option value="USD">USD $</option>
          </select>

          <select class="shipCountry" id="shipCountry" title="Shipping country">
            <option value="DE">Germany (DE)</option>
            <option value="EU">Europe (EU)</option>
            <option value="US">United States (US)</option>
            <option value="CA">Canada (CA)</option>
          </select>
        </div>
      </div>

      <div class="content">
        <div class="wrap" id="wrap">
          <section class="panel" id="leftPanel">
            <div class="gallery">
              <div class="hero" id="hero">
                <div class="hero-inner" id="heroInner">
                  <div class="carousel" id="carousel" aria-label="Product images">
                    <div class="heroEmpty">No image</div>
                  </div>
                </div>

                <button class="navBtn navPrev" id="prevBtn" type="button" aria-label="Previous image">‚Üê</button>
                <button class="navBtn navNext" id="nextBtn" type="button" aria-label="Next image">‚Üí</button>
                <div class="counter" id="counter">1 / 1</div>
              </div>

              <div class="thumbs" id="thumbs"></div>
            </div>
          </section>

          <aside class="panel" id="rightPanel">
            <div class="details">
              <div class="kicker" id="kicker"></div>
              <div class="title" id="title"></div>
              <div class="meta" id="desc"></div>

              <div class="chips" id="chips"></div>

              <div class="priceRow">
                <div class="price" id="price">‚Äî</div>
                <div class="badge" id="stockBadge">‚Äî</div>
              </div>

              <div class="actions">
                <div class="qtyRow">
                  <label>Quantity</label>
                  <div class="qty">
                    <button id="minus" type="button">‚àí</button>
                    <input id="qty" value="1" inputmode="numeric" />
                    <button id="plus" type="button">+</button>
                  </div>
                </div>

                <button class="btn2" id="addBtn" type="button">Add to cart</button>
                <button class="btn" id="buyBtn" type="button">Buy now</button>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </main>
  </div>

  <div class="cartBack" id="cartBack"></div>
  <div class="cartDrawer" id="cartDrawer">
    <div class="cartHead">
      <div class="cartTitle">Cart</div>
      <button class="cartClose" id="closeCart" type="button">‚úï</button>
    </div>

    <div class="cartBody" id="cartBody"></div>

    <div class="cartFoot">
      <div class="cartSumRow">
        <div>Total</div>
        <div id="cartTotal">‚Äî</div>
      </div>
      <div class="cartActions">
        <button class="btn" id="cartCheckout" type="button">Checkout</button>
        <button class="btn2" id="cartClear" type="button">Clear cart</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div style="font-weight:800" id="toastTitle">Notice</div>
    <small id="toastMsg">‚Äî</small>
  </div>
<script>
  const API_PRODUCT = "/api/product";
  const API_CHECKOUT = "/api/checkout";

  const CART_KEY = "mp_cart";
  const MP_CUR_KEY = "mp_currency";
  const MP_SHIP_KEY = "mp_ship_country";

  const el = (id) => document.getElementById(id);

  const elCurrency = el("currency");
  const elShipCountry = el("shipCountry");

  function readCart(){
    try{
      const raw = localStorage.getItem(CART_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(_){ return []; }
  }
  function writeCart(arr){ localStorage.setItem(CART_KEY, JSON.stringify(arr)); }
  function cartCount(){ return readCart().reduce((s,it)=>s+(Number(it?.qty)||0),0); }

  function updateCartBadge(){
    const badge = el("cartBadge");
    if (badge) badge.textContent = String(cartCount());
  }

  const toastEl = el("toast");
  const toastTitle = el("toastTitle");
  const toastMsg = el("toastMsg");

  function toast(title, msg){
    if (!toastEl || !toastTitle || !toastMsg) return;
    toastTitle.textContent = title;
    toastMsg.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=> toastEl.classList.remove("show"), 2600);
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function getCurrency(){
    const saved = (localStorage.getItem(MP_CUR_KEY) || "").toUpperCase();
    if (saved === "EUR" || saved === "USD") return saved;
    return String(elCurrency?.value || "EUR").toUpperCase();
  }
  function setCurrency(cur){
    cur = String(cur || "EUR").toUpperCase();
    if (cur !== "EUR" && cur !== "USD") cur = "EUR";
    try{ localStorage.setItem(MP_CUR_KEY, cur); }catch(_){}
    if (elCurrency) elCurrency.value = cur;
  }

  // ‚úÖ hard rule: US/CA => USD, DE/EU => EUR
  function enforceCurrencyByShipping(){
    const ship = String(elShipCountry?.value || "DE").toUpperCase();
    const must = (ship === "US" || ship === "CA") ? "USD" : "EUR";
    if (getCurrency() !== must){
      setCurrency(must);
      toast("Currency", `Auto set: ${must}`);
    }
  }

  // ‚úÖ restore persisted selects (currency + shipping)
  (function restoreSettings(){
    try{
      // currency
      const cur = (localStorage.getItem(MP_CUR_KEY) || "").toUpperCase();
      if (cur && (cur === "EUR" || cur === "USD") && elCurrency) elCurrency.value = cur;

      // shipping
      const ship = (localStorage.getItem(MP_SHIP_KEY) || "").toUpperCase();
      if (ship && ["DE","EU","US","CA"].includes(ship) && elShipCountry) elShipCountry.value = ship;

      // if nothing saved yet ‚Äî try guess from locale (DE default)
      if (!localStorage.getItem(MP_SHIP_KEY) && elShipCountry){
        let guess = "DE";
        try{
          const loc = (navigator.language || "").split("-")[1] || "";
          const cc = String(loc).toUpperCase();
          if (cc === "US") guess = "US";
          else if (cc === "CA") guess = "CA";
          else if (cc === "DE") guess = "DE";
          else if (cc) guess = "EU";
        }catch(_){}
        elShipCountry.value = guess;
        try{ localStorage.setItem(MP_SHIP_KEY, guess); }catch(_){}
      }

      // ‚úÖ enforce once on load
      enforceCurrencyByShipping();
      setCurrency(getCurrency());
    }catch(_){}
  })();

  // ‚úÖ Map UI selection -> ISO2 for API
  // IMPORTANT: EU must send a real EU ISO2 code so backend detectZone() returns "EU"
  function getShippingCountryISO2(){
    const v = String(elShipCountry?.value || "DE").toUpperCase();
    if (v === "US") return "US";
    if (v === "CA") return "CA";
    if (v === "EU") return "FR"; // ‚úÖ any EU ISO2 works: FR/ES/IT/NL...
    return "DE";
  }

  // will be set later after product loads
  let currentProduct = null;
  function refreshCurrencyUI(){
    renderCart();
    if (currentProduct){
      el("price").textContent = priceText(currentProduct.price);
    }
  }

  // ‚úÖ persist on change (but do not allow wrong currency)
  if (elCurrency){
    elCurrency.addEventListener("change", () => {
      setCurrency(elCurrency.value);
      enforceCurrencyByShipping();  // ‚úÖ snaps back if not allowed
      refreshCurrencyUI();
    });
  }

  if (elShipCountry){
    elShipCountry.addEventListener("change", () => {
      try{ localStorage.setItem(MP_SHIP_KEY, String(elShipCountry.value || "DE").toUpperCase()); }catch(_){}
      enforceCurrencyByShipping();
      refreshCurrencyUI();
      toast("Shipping", `Destination: ${elShipCountry.value}`);
    });
  }

  function priceText(priceObj){
    const cur = getCurrency();
    const v = priceObj?.[cur];
    if (typeof v !== "number") return cur === "EUR" ? "‚Äî ‚Ç¨" : "‚Äî $";
    return cur === "EUR" ? `${v.toFixed(2)} ‚Ç¨` : `${v.toFixed(2)} $`;
  }

  function clampQty(q, max){
    q = Number(q);
    if (!Number.isFinite(q)) q = 1;
    if (q < 1) q = 1;
    if (max >= 1 && q > max) q = max;
    return q;
  }

  /* =========================
     CART DRAWER
  ========================== */
  const elOpenCart = el("openCart");
  const elCartBack = el("cartBack");
  const elCartDrawer = el("cartDrawer");
  const elCloseCart = el("closeCart");
  const elCartBody = el("cartBody");
  const elCartTotal = el("cartTotal");
  const elCartCheckout = el("cartCheckout");
  const elCartClear = el("cartClear");

  function openCart(){
    elCartBack?.classList.add("show");
    elCartDrawer?.classList.add("show");
    document.body.style.overflow = "hidden";
    renderCart();
  }
  function closeCart(){
    elCartBack?.classList.remove("show");
    elCartDrawer?.classList.remove("show");
    document.body.style.overflow = "";
  }

  elOpenCart?.addEventListener("click", openCart);
  elCloseCart?.addEventListener("click", closeCart);
  elCartBack?.addEventListener("click", closeCart);

  // ‚úÖ Escape closes cart only if cart is open
  window.addEventListener("keydown", (e)=>{
    if (e.key !== "Escape") return;
    const cartOpen = elCartDrawer?.classList.contains("show");
    if (cartOpen) closeCart();
  });

  function cartTotal(){
    const cur = getCurrency();
    const cart = readCart();
    let sum = 0;
    for (const it of cart){
      const unit = Number(it?.price?.[cur]);
      if (Number.isFinite(unit)) sum += unit * (Number(it?.qty)||0);
    }
    return sum;
  }

  function setCartQty(pin, qty){
    const cart = readCart();
    const idx = cart.findIndex(x => String(x.pin) === String(pin));
    if (idx < 0) return;

    const stock = Number(cart[idx].stock ?? 0);
    qty = Number(qty);
    if (!Number.isFinite(qty)) qty = 1;
    qty = Math.max(1, qty);
    if (stock > 0) qty = Math.min(stock, qty);

    cart[idx].qty = qty;
    writeCart(cart);
    updateCartBadge();
    renderCart();
  }

  function removeFromCart(pin){
    const cart = readCart().filter(x => String(x.pin) !== String(pin));
    writeCart(cart);
    updateCartBadge();
    renderCart();
  }

  function clearCart(){
    writeCart([]);
    updateCartBadge();
    renderCart();
  }

  function renderCart(){
    if (!elCartBody || !elCartTotal || !elCartCheckout) return;

    const cart = readCart();

    if (!cart.length){
      elCartBody.innerHTML = `<div class="cartEmpty">Your cart is empty.</div>`;
      elCartTotal.textContent = "‚Äî";
      elCartCheckout.disabled = true;
      elCartCheckout.textContent = "Checkout";
      return;
    }

    elCartCheckout.disabled = false;
    elCartCheckout.textContent = "Checkout";

    const cur = getCurrency();

    elCartBody.innerHTML = cart.map(it => {
      const img = it.image
        ? `<img src="${escapeHtml(it.image)}" alt="${escapeHtml(it.title)}" />`
        : `<span>‚Äî</span>`;

      const unit = it?.price?.[cur];
      const unitText = (typeof unit === "number")
        ? (cur==="EUR" ? `${unit.toFixed(2)} ‚Ç¨` : `${unit.toFixed(2)} $`)
        : "‚Äî";

      return `
        <div class="cartItem" data-pin="${escapeHtml(String(it.pin || ""))}">
          <div class="cartImg">${img}</div>
          <div>
            <p class="cartName">${escapeHtml(it.title || it.pin)}</p>
            <div class="cartMeta">${escapeHtml(it.pin)} ‚Ä¢ ${unitText}</div>
            <div class="cartRow">
              <div class="cartQty">
                <button type="button" data-act="minus">‚àí</button>
                <input value="${escapeHtml(String(it.qty || 1))}" inputmode="numeric" />
                <button type="button" data-act="plus">+</button>
              </div>
              <button class="cartRemove" type="button" data-act="remove">‚úï</button>
            </div>
            <div class="cartMeta" style="margin-top:8px;">Stock: ${escapeHtml(it.stock ?? "‚Äî")}</div>
          </div>
        </div>
      `;
    }).join("");

    [...elCartBody.querySelectorAll(".cartItem")].forEach(row => {
      const pin = row.getAttribute("data-pin");
      const input = row.querySelector("input");

      row.querySelector('button[data-act="minus"]')?.addEventListener("click", () => setCartQty(pin, Number(input.value) - 1));
      row.querySelector('button[data-act="plus"]')?.addEventListener("click",  () => setCartQty(pin, Number(input.value) + 1));

      input?.addEventListener("input", () => {
        const v = Number(input.value);
        if (!Number.isFinite(v)) return;
        setCartQty(pin, v);
      });

      row.querySelector('button[data-act="remove"]')?.addEventListener("click", () => removeFromCart(pin));
    });

    const sum = cartTotal();
    elCartTotal.textContent = (cur==="EUR") ? `${sum.toFixed(2)} ‚Ç¨` : `${sum.toFixed(2)} $`;
  }

  elCartClear?.addEventListener("click", () => { clearCart(); toast("Cart", "Cleared"); });

  // ‚úÖ checkout from cart
  elCartCheckout?.addEventListener("click", async () => {
    const cur = getCurrency();
    const cart = readCart();

    if (!cart.length){
      toast("Checkout", "Your cart is empty");
      return;
    }

    // ‚úÖ ensure ship saved + enforce currency before sending
    try{ localStorage.setItem(MP_SHIP_KEY, String(elShipCountry?.value || "DE").toUpperCase()); }catch(_){}
    enforceCurrencyByShipping();

    const items = cart.map(it => ({ pin: String(it.pin), qty: Number(it.qty) || 1 }));

    elCartCheckout.disabled = true;
    const oldText = elCartCheckout.textContent;
    elCartCheckout.textContent = "Redirecting‚Ä¶";

    try{
      const r = await fetch(API_CHECKOUT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          currency: getCurrency(),
          shippingCountry: getShippingCountryISO2(),
          items
        }),
      });

      const data = await r.json().catch(()=>({}));
      if (!r.ok || !data?.ok || !data?.url){
        throw new Error(data?.error || "Checkout failed");
      }

      window.location.href = data.url;
    }catch(e){
      toast("Checkout", String(e?.message || e));
      elCartCheckout.disabled = false;
      elCartCheckout.textContent = oldText;
    }
  });

  /* =========================
     PRODUCT PAGE
  ========================== */
  const hero = el("hero");
  const heroInner = el("heroInner");
  const carousel = el("carousel");
  const prevBtn = el("prevBtn");
  const nextBtn = el("nextBtn");
  const counter = el("counter");

  let currentIndex = 0;
  let imagesState = [];
  let carouselWired = false;

  function updateNav(){
    const n = imagesState.length;
    const hasMany = n > 1;
    if (counter){
      counter.style.display = n >= 2 ? "block" : "none";
      counter.textContent = `${Math.min(currentIndex+1, n)} / ${n}`;
    }
    if (prevBtn) prevBtn.disabled = !hasMany || currentIndex <= 0;
    if (nextBtn) nextBtn.disabled = !hasMany || currentIndex >= n-1;
  }

  function syncThumbs(){
    const thumbs = el("thumbs");
    if (!thumbs) return;
    thumbs.querySelectorAll(".t").forEach(t => t.classList.remove("active"));
    const active = thumbs.querySelector(`.t[data-idx="${currentIndex}"]`);
    if (active) active.classList.add("active");
  }

  function scrollToIndex(idx, smooth=true){
    const n = imagesState.length;
    if (!n || !carousel) return;
    currentIndex = Math.max(0, Math.min(idx, n-1));
    const x = carousel.clientWidth * currentIndex;
    carousel.scrollTo({ left: x, behavior: smooth ? "smooth" : "auto" });
    syncThumbs();
    updateNav();
  }

  function detectIndexFromScroll(){
    if (!carousel) return;
    const w = carousel.clientWidth || 1;
    const idx = Math.round(carousel.scrollLeft / w);
    const n = imagesState.length;
    const clamped = Math.max(0, Math.min(idx, Math.max(0, n-1)));
    if (clamped !== currentIndex){
      currentIndex = clamped;
      syncThumbs();
    }
    updateNav();
  }

  function buildCarousel(images, title){
    imagesState = images.slice();
    currentIndex = 0;

    if (!carousel) return;
    carousel.innerHTML = "";

    if (!imagesState.length){
      carousel.innerHTML = `<div class="heroEmpty">No image</div>`;
      updateNav();
      return;
    }

    imagesState.forEach((u) => {
      const s = document.createElement("div");
      s.className = "slide";
      s.innerHTML = `<img src="${escapeHtml(u)}" alt="${escapeHtml(title)}" draggable="false" />`;
      carousel.appendChild(s);
    });

    requestAnimationFrame(() => scrollToIndex(0, false));
  }

  function renderThumbs(images, title){
    const thumbs = el("thumbs");
    if (!thumbs) return;
    thumbs.innerHTML = "";

    images.forEach((u, idx) => {
      const d = document.createElement("div");
      d.className = "t" + (idx===0 ? " active" : "");
      d.dataset.idx = String(idx);
      d.innerHTML = `<img src="${escapeHtml(u)}" alt="${escapeHtml(title)}" draggable="false" />`;
      d.addEventListener("click", () => scrollToIndex(idx));
      thumbs.appendChild(d);
    });
  }

  function enableDragScroll(){
    if (!carousel) return;

    let isDown = false;
    let startX = 0;
    let startLeft = 0;

    const onDown = (e) => {
      if (e.pointerType === "mouse" && e.button !== 0) return;
      isDown = true;
      carousel.classList.add("dragging");
      startX = e.clientX;
      startLeft = carousel.scrollLeft;
      try{ carousel.setPointerCapture(e.pointerId); }catch(_){}
    };

    const onMove = (e) => {
      if (!isDown) return;
      const dx = e.clientX - startX;
      carousel.scrollLeft = startLeft - dx;
    };

    const onUp = () => {
      if (!isDown) return;
      isDown = false;
      carousel.classList.remove("dragging");
      detectIndexFromScroll();
      scrollToIndex(currentIndex);
    };

    carousel.addEventListener("pointerdown", onDown);
    window.addEventListener("pointermove", onMove, { passive:true });
    window.addEventListener("pointerup", onUp);
    window.addEventListener("pointercancel", onUp);
  }

  function wireCarouselOnce(){
    if (carouselWired) return;
    carouselWired = true;

    prevBtn?.addEventListener("click", () => scrollToIndex(currentIndex - 1));
    nextBtn?.addEventListener("click", () => scrollToIndex(currentIndex + 1));

    let t;
    carousel?.addEventListener("scroll", () => {
      clearTimeout(t);
      t = setTimeout(detectIndexFromScroll, 80);
    });

    enableDragScroll();
    window.addEventListener("resize", () => scrollToIndex(currentIndex, false));
  }

  function setupParallax(){
    const reduceMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    if (reduceMotion || !hero || !heroInner) return;

    let target = { x:0, y:0, rx:0, ry:0, s:1.02 };
    let curr   = { x:0, y:0, rx:0, ry:0, s:1.02 };

    function apply(){
      const k = 0.12;
      curr.x  += (target.x  - curr.x)  * k;
      curr.y  += (target.y  - curr.y)  * k;
      curr.rx += (target.rx - curr.rx) * k;
      curr.ry += (target.ry - curr.ry) * k;

      heroInner.style.transform =
        `translate3d(${curr.x}px, ${curr.y}px, 0) rotateX(${curr.rx}deg) rotateY(${curr.ry}deg) scale(${target.s})`;

      requestAnimationFrame(apply);
    }
    requestAnimationFrame(apply);

    function reset(){ target.x=0; target.y=0; target.rx=0; target.ry=0; }

    hero.addEventListener("mousemove", (e) => {
      const r = hero.getBoundingClientRect();
      const nx = (e.clientX - r.left) / r.width  - 0.5;
      const ny = (e.clientY - r.top)  / r.height - 0.5;

      const maxMove = 6;
      const maxTilt = 2.0;

      target.x = nx * maxMove;
      target.y = ny * maxMove;
      target.rx = (-ny) * maxTilt;
      target.ry = (nx) * maxTilt;
    });
    hero.addEventListener("mouseleave", reset);
  }

  function addToCart(p, qty){
    qty = Number(qty);
    if (!Number.isFinite(qty) || qty <= 0) qty = 1;

    const stock = Number(p.stock ?? 0);
    if (stock <= 0){
      toast("Cart", "Sold out");
      return;
    }

    const cart = readCart();
    const idx = cart.findIndex(x => String(x.pin) === String(p.pin));

    if (idx >= 0){
      const next = Math.min(stock, (Number(cart[idx].qty)||0) + qty);
      cart[idx].qty = next;
      cart[idx].stock = stock;
      cart[idx].title = p.title;
      cart[idx].image = (p.images && p.images[0]) ? p.images[0] : (cart[idx].image || "");
      cart[idx].price = p.price || cart[idx].price || {};
    } else {
      cart.push({
        pin: String(p.pin),
        qty: Math.min(stock, qty),
        title: String(p.title || p.pin),
        image: (p.images && p.images[0]) ? p.images[0] : "",
        price: p.price || {},
        stock: stock
      });
    }

    writeCart(cart);
    updateCartBadge();
    if (elCartDrawer?.classList.contains("show")) renderCart();
    toast("Cart", "Added ‚úÖ");
  }

  async function buyNowOneItem(p, qty){
    // ‚úÖ enforce currency just before checkout
    enforceCurrencyByShipping();

    // ‚úÖ ensure country saved
    try{ localStorage.setItem(MP_SHIP_KEY, String(elShipCountry?.value || "DE").toUpperCase()); }catch(_){}

    const payload = {
      currency: getCurrency(),
      shippingCountry: getShippingCountryISO2(),
      items: [{ pin: String(p.pin), qty: Number(qty) || 1 }],
    };

    const r = await fetch(API_CHECKOUT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const data = await r.json().catch(()=>({}));
    if (!r.ok || !data?.ok || !data?.url) {
      throw new Error(data?.error || "Checkout failed");
    }

    window.location.href = data.url;
  }

  async function load(){
    updateCartBadge();
    renderCart();

    // ‚úÖ keep currency consistent if user changed ship on another page
    enforceCurrencyByShipping();
    setCurrency(getCurrency());

    const url = new URL(window.location.href);
    const pin = (url.searchParams.get("pin") || "").trim();
    if (!pin){
      el("hTitle").textContent = "Missing PIN";
      el("hSub").textContent = "Open a product from the shop page.";
      return;
    }

    let r, data;
    try{
      r = await fetch(`${API_PRODUCT}?pin=${encodeURIComponent(pin)}`, { cache:"no-store" });
      data = await r.json();
    }catch(_){
      el("hTitle").textContent = "Network error";
      el("hSub").textContent = "API is not reachable";
      toast("Error", "Product API is not reachable");
      return;
    }

    if (!r.ok){
      el("hTitle").textContent = "Not found";
      el("hSub").textContent = data?.error || "Product not found";
      return;
    }

    const p = data.product;
    currentProduct = p;

    document.title = `${p.title} ‚Ä¢ Mosaic Pins`;
    el("hTitle").textContent = p.title;
    el("hSub").textContent = `${p.pin} ‚Ä¢ √ò ${p.diameter ?? "‚Äî"} mm`;

    el("kicker").textContent = p.type ? String(p.type) : "";
    el("title").textContent = p.title;
    el("desc").textContent = (p.description || "").trim();

    const chips = [];
    if (p.color) chips.push(`Color: ${p.color}`);
    if (p.diameter != null) chips.push(`√ò ${p.diameter} mm`);
    (p.materials || []).forEach(m => chips.push(m));
    el("chips").innerHTML = chips.map(c => `<span class="chip">${escapeHtml(c)}</span>`).join("");

    const images = Array.isArray(p.images) ? p.images : [];
    buildCarousel(images, p.title);
    renderThumbs(images, p.title);
    wireCarouselOnce();
    updateNav();

    const stock = Number(p.stock || 0);
    const badge = el("stockBadge");
    const buyBtn = el("buyBtn");
    const addBtn = el("addBtn");

    if (stock > 0){
      badge.textContent = `In stock: ${stock}`;
      badge.classList.remove("sold");
      buyBtn.disabled = false;
      addBtn.disabled = false;
    } else {
      badge.textContent = "Sold out";
      badge.classList.add("sold");
      buyBtn.disabled = true;
      addBtn.disabled = true;
    }

    const qtyInput = el("qty");
    qtyInput.value = "1";
    const setQty = (v) => { qtyInput.value = String(clampQty(v, stock)); };
    el("minus").addEventListener("click", () => setQty(Number(qtyInput.value) - 1));
    el("plus").addEventListener("click", () => setQty(Number(qtyInput.value) + 1));
    qtyInput.addEventListener("input", () => setQty(qtyInput.value));

    const renderPrice = () => { el("price").textContent = priceText(p.price); };
    if (elCurrency) elCurrency.addEventListener("change", renderPrice);
    renderPrice();

    addBtn.addEventListener("click", () => {
      const quantity = clampQty(qtyInput.value, stock);
      if (stock <= 0) return;
      addToCart(p, quantity);
    });

    buyBtn.addEventListener("click", async () => {
      const quantity = clampQty(qtyInput.value, stock);
      if (stock <= 0) return;

      buyBtn.disabled = true;
      const oldText = buyBtn.textContent;
      buyBtn.textContent = "Redirecting‚Ä¶";

      try{
        await buyNowOneItem(p, quantity);
      }catch(e){
        toast("Checkout", String(e?.message || e));
        buyBtn.disabled = false;
        buyBtn.textContent = oldText;
      }
    });

    setupParallax();
  }

  load();
</script>
</body>
</html>