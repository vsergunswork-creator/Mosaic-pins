<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Product • Mosaic Pins</title>
  <style>
    :root{
      --bg:#0b0d11;
      --panel:#11141b;
      --panel2:#0f1218;
      --text:#e9eef7;
      --muted:#a8b3c7;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 30px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1100px 700px at 35% -10%, rgba(50,220,150,.25), transparent 55%),
                  radial-gradient(900px 600px at 75% 10%, rgba(120,90,255,.22), transparent 55%),
                  var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    .app{display:grid; grid-template-columns: 280px 1fr; height:100vh; gap:16px; padding:16px;}
    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sb-top{padding:18px 18px 10px; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px;}
    .dot{width:10px;height:10px;border-radius:50%; background:linear-gradient(135deg,#22c55e,#60a5fa);}
    .pill{padding:8px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--line); color:var(--muted); font-size:12px;}

    .sb-nav{padding:6px; display:grid; gap:6px;}
    .nav-item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:12px;
      color:var(--muted); text-decoration:none; border:1px solid transparent;
    }
    .nav-item:hover{background:rgba(255,255,255,.05); color:var(--text);}
    .nav-item.active{background:rgba(34,197,94,.12); border-color: rgba(34,197,94,.22); color:var(--text);}

    .main{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column; min-width:0;
    }
    .topbar{
      padding:16px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
    }
    .h-title{font-weight:900; font-size:18px; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .sub{color:var(--muted); font-size:12px; margin-top:4px}

    .content{padding:18px; overflow:auto; min-height:0;}
    .wrap{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width:980px){
      .app{grid-template-columns:1fr}
      .sidebar{display:none}
      body{overflow:auto}
      .main{height:auto; min-height:100vh}
      .wrap{grid-template-columns:1fr}
    }

    .panel{
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      border-radius:16px;
      overflow:hidden;
    }

    /* Gallery */
    .gallery{
      padding:12px;
      display:grid;
      gap:10px;
    }

    /* === Premium hero carousel + parallax === */
    .hero{
      aspect-ratio: 1/1;
      border-radius:14px;
      overflow:hidden;
      background:linear-gradient(135deg, rgba(34,197,94,.14), rgba(96,165,250,.10));
      border:1px solid var(--line);
      position:relative;
      perspective: 900px;
      user-select:none;
      touch-action: pan-y;
    }

    .hero-inner{
      width:100%;
      height:100%;
      transform-style: preserve-3d;
      will-change: transform;
    }

    .carousel{
      width:100%;
      height:100%;
      overflow-x:auto;
      overflow-y:hidden;
      display:flex;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
      user-select:none;
      cursor: grab;
    }
    .carousel::-webkit-scrollbar{display:none;}
    .carousel.dragging{cursor: grabbing;}

    .slide{
      flex: 0 0 100%;
      width:100%;
      height:100%;
      scroll-snap-align:center;
      position:relative;
    }
    .slide img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      pointer-events:none;
      transform: translateZ(0);
    }

    .heroEmpty{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
    }

    .navBtn{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.45);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      backdrop-filter: blur(8px);
      transition: transform .15s ease, filter .15s ease, opacity .15s ease;
      opacity:.95;
      user-select:none;
      z-index:5;
    }
    .navBtn:hover{filter:brightness(1.1); transform:translateY(-50%) scale(1.03)}
    .navBtn:active{transform:translateY(-50%) scale(.98)}
    .navPrev{left:10px;}
    .navNext{right:10px;}
    .navBtn[disabled]{opacity:.35; cursor:not-allowed;}
    @media (max-width:980px){
      .navBtn{display:none;} /* mobile: чистый swipe */
    }

    .counter{
      position:absolute;
      left:10px;
      bottom:10px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.35);
      color:var(--text);
      backdrop-filter: blur(6px);
      z-index:5;
      display:none;
    }

    .thumbs{display:flex; gap:10px; overflow:auto; padding-bottom:4px;}
    .t{
      width:72px; height:72px; border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      overflow:hidden; cursor:pointer;
      flex:0 0 auto;
      opacity:.8;
    }
    .t.active{outline:2px solid rgba(34,197,94,.45); opacity:1}
    .t img{width:100%; height:100%; object-fit:cover; display:block;}

    /* Details */
    .details{padding:16px;}
    .kicker{color:var(--muted); font-size:12px}
    .title{font-size:22px; font-weight:950; margin:6px 0 8px;}

    /* Keep Airtable paragraphs */
    .meta{
      color:var(--muted);
      font-size:13px;
      line-height:1.65;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px;}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      font-size:12px;
    }

    .priceRow{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      margin:16px 0 10px;
    }
    .price{font-size:20px; font-weight:950;}
    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.35);
      color:var(--text);
    }
    .sold{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.25)}

    .actions{display:grid; gap:10px; margin-top:14px;}
    .qtyRow{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .qtyRow label{color:var(--muted); font-size:13px}
    .qty{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
    }
    .qty button{
      width:34px; height:34px; border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .qty input{
      width:52px;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:14px;
      text-align:center;
    }

    .btn{
      border:none; cursor:pointer;
      padding:12px 14px;
      border-radius:12px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#07110b;
      font-weight:950;
      box-shadow: 0 10px 18px rgba(34,197,94,.18);
      transition: filter .15s ease, transform .15s ease;
    }
    .btn:hover{filter:brightness(1.05); transform: translateY(-1px)}
    .btn:disabled{
      cursor:not-allowed;
      background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.55);
      box-shadow:none;
    }

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(0,0,0,.55);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 14px;
      color: var(--text);
      box-shadow: var(--shadow);
      max-width: 360px;
      display:none;
    }
    .toast.show{display:block}
    .toast small{color:var(--muted)}

    @media (prefers-reduced-motion: reduce){
      .hero-inner{will-change:auto}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand"><span class="dot"></span> Mosaic Pins</div>
        <div class="pill" id="sbCount">Product</div>
      </div>

      <nav class="sb-nav">
        <a class="nav-item" href="/" id="navShop">← Back to shop</a>
        <a class="nav-item active" href="#" id="navProduct">Product</a>
      </nav>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <h1 class="h-title" id="hTitle">Loading…</h1>
          <div class="sub" id="hSub"></div>
        </div>

        <select class="currency" id="currency" title="Currency">
          <option value="EUR">EUR €</option>
          <option value="USD">USD $</option>
        </select>
      </div>

      <div class="content">
        <div class="wrap">
          <section class="panel">
            <div class="gallery">
              <div class="hero" id="hero">
                <div class="hero-inner" id="heroInner">
                  <div class="carousel" id="carousel" aria-label="Product images">
                    <div class="heroEmpty">No image</div>
                  </div>
                </div>

                <button class="navBtn navPrev" id="prevBtn" aria-label="Previous image">←</button>
                <button class="navBtn navNext" id="nextBtn" aria-label="Next image">→</button>
                <div class="counter" id="counter">1 / 1</div>
              </div>

              <div class="thumbs" id="thumbs"></div>
            </div>
          </section>

          <aside class="panel">
            <div class="details">
              <div class="kicker" id="kicker"></div>
              <div class="title" id="title"></div>
              <div class="meta" id="desc"></div>

              <div class="chips" id="chips"></div>

              <div class="priceRow">
                <div class="price" id="price">—</div>
                <div class="badge" id="stockBadge">—</div>
              </div>

              <div class="actions">
                <div class="qtyRow">
                  <label>Quantity</label>
                  <div class="qty">
                    <button id="minus">−</button>
                    <input id="qty" value="1" inputmode="numeric" />
                    <button id="plus">+</button>
                  </div>
                </div>

                <button class="btn" id="buyBtn">Buy now</button>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </main>
  </div>

  <div class="toast" id="toast">
    <div style="font-weight:800" id="toastTitle">Checkout</div>
    <small id="toastMsg">Opening Stripe…</small>
  </div>

<script>
  const API_PRODUCT = "/api/product";
  const API_CHECKOUT = "/api/checkout";

  const el = (id) => document.getElementById(id);
  const toastEl = el("toast");
  const toastTitle = el("toastTitle");
  const toastMsg = el("toastMsg");

  // gallery elements
  const hero = el("hero");
  const heroInner = el("heroInner");
  const carousel = el("carousel");
  const prevBtn = el("prevBtn");
  const nextBtn = el("nextBtn");
  const counter = el("counter");

  let currentIndex = 0;
  let imagesState = [];

  function toast(title, msg){
    toastTitle.textContent = title;
    toastMsg.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=> toastEl.classList.remove("show"), 2400);
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function priceText(priceObj){
    const cur = el("currency").value;
    const v = priceObj?.[cur];
    if (typeof v !== "number") return cur === "EUR" ? "— €" : "— $";
    return cur === "EUR" ? `${v.toFixed(2)} €` : `${v.toFixed(2)} $`;
  }

  function clampQty(q, max){
    q = Number(q);
    if (!Number.isFinite(q)) q = 1;
    if (q < 1) q = 1;
    if (max >= 1 && q > max) q = max;
    return q;
  }

  // ===== carousel =====
  function updateNav(){
    const n = imagesState.length;
    const hasMany = n > 1;
    counter.style.display = n >= 2 ? "block" : "none";
    counter.textContent = `${Math.min(currentIndex+1, n)} / ${n}`;

    prevBtn.disabled = !hasMany || currentIndex <= 0;
    nextBtn.disabled = !hasMany || currentIndex >= n-1;
  }

  function syncThumbs(){
    const thumbs = el("thumbs");
    thumbs.querySelectorAll(".t").forEach(t => t.classList.remove("active"));
    const active = thumbs.querySelector(`.t[data-idx="${currentIndex}"]`);
    if (active) active.classList.add("active");
  }

  function scrollToIndex(idx, smooth=true){
    const n = imagesState.length;
    if (!n) return;
    currentIndex = Math.max(0, Math.min(idx, n-1));
    const x = carousel.clientWidth * currentIndex;
    carousel.scrollTo({ left: x, behavior: smooth ? "smooth" : "auto" });
    syncThumbs();
    updateNav();
  }

  function detectIndexFromScroll(){
    const w = carousel.clientWidth || 1;
    const idx = Math.round(carousel.scrollLeft / w);
    const n = imagesState.length;
    const clamped = Math.max(0, Math.min(idx, Math.max(0, n-1)));
    if (clamped !== currentIndex){
      currentIndex = clamped;
      syncThumbs();
    }
    updateNav();
  }

  function buildCarousel(images, title){
    imagesState = images.slice();
    currentIndex = 0;

    carousel.innerHTML = "";
    if (!imagesState.length){
      carousel.innerHTML = `<div class="heroEmpty">No image</div>`;
      updateNav();
      return;
    }

    imagesState.forEach((u) => {
      const s = document.createElement("div");
      s.className = "slide";
      s.innerHTML = `<img src="${u}" alt="${escapeHtml(title)}" draggable="false" />`;
      carousel.appendChild(s);
    });

    requestAnimationFrame(() => scrollToIndex(0, false));
  }

  function renderThumbs(images, title){
    const thumbs = el("thumbs");
    thumbs.innerHTML = "";
    images.forEach((u, idx) => {
      const d = document.createElement("div");
      d.className = "t" + (idx===0 ? " active" : "");
      d.dataset.idx = String(idx);
      d.innerHTML = `<img src="${u}" alt="${escapeHtml(title)}" draggable="false" />`;
      d.addEventListener("click", () => scrollToIndex(idx));
      thumbs.appendChild(d);
    });
  }

  function enableDragScroll(){
    let isDown = false;
    let startX = 0;
    let startLeft = 0;

    const onDown = (e) => {
      // left button only
      if (e.pointerType === "mouse" && e.button !== 0) return;
      isDown = true;
      carousel.classList.add("dragging");
      startX = e.clientX;
      startLeft = carousel.scrollLeft;
      try{ carousel.setPointerCapture(e.pointerId); }catch(_){}
    };

    const onMove = (e) => {
      if (!isDown) return;
      const dx = e.clientX - startX;
      carousel.scrollLeft = startLeft - dx;
    };

    const onUp = () => {
      if (!isDown) return;
      isDown = false;
      carousel.classList.remove("dragging");
      detectIndexFromScroll();
      scrollToIndex(currentIndex);
    };

    carousel.addEventListener("pointerdown", onDown);
    window.addEventListener("pointermove", onMove, { passive:true });
    window.addEventListener("pointerup", onUp);
    window.addEventListener("pointercancel", onUp);
  }

  function wireCarousel(){
    prevBtn.addEventListener("click", () => scrollToIndex(currentIndex - 1));
    nextBtn.addEventListener("click", () => scrollToIndex(currentIndex + 1));

    let t;
    carousel.addEventListener("scroll", () => {
      clearTimeout(t);
      t = setTimeout(detectIndexFromScroll, 80);
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") scrollToIndex(currentIndex - 1);
      if (e.key === "ArrowRight") scrollToIndex(currentIndex + 1);
    });

    enableDragScroll();
    window.addEventListener("resize", () => scrollToIndex(currentIndex, false));
  }

  // ===== parallax (tilt + tiny shift) =====
  function setupParallax(){
    const reduceMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    if (reduceMotion) return;

    let target = { x:0, y:0, rx:0, ry:0, s:1.02 };
    let curr   = { x:0, y:0, rx:0, ry:0, s:1.02 };
    let running = true;

    function apply(){
      const k = 0.12;
      curr.x  += (target.x  - curr.x)  * k;
      curr.y  += (target.y  - curr.y)  * k;
      curr.rx += (target.rx - curr.rx) * k;
      curr.ry += (target.ry - curr.ry) * k;

      heroInner.style.transform =
        `translate3d(${curr.x}px, ${curr.y}px, 0) rotateX(${curr.rx}deg) rotateY(${curr.ry}deg) scale(${target.s})`;

      if (running) requestAnimationFrame(apply);
    }
    requestAnimationFrame(apply);

    function reset(){
      target.x = 0; target.y = 0; target.rx = 0; target.ry = 0;
    }

    // Desktop mouse tilt
    hero.addEventListener("mousemove", (e) => {
      const r = hero.getBoundingClientRect();
      const nx = (e.clientX - r.left) / r.width  - 0.5;
      const ny = (e.clientY - r.top)  / r.height - 0.5;

      const maxMove = 6;   // px
      const maxTilt = 2.0; // deg

      target.x = nx * maxMove;
      target.y = ny * maxMove;
      target.rx = (-ny) * maxTilt;
      target.ry = (nx) * maxTilt;
    });
    hero.addEventListener("mouseleave", reset);

    // Mobile gyro
    let gyroEnabled = false;

    function onOrient(ev){
      const g = Number(ev.gamma);
      const b = Number(ev.beta);
      if (!Number.isFinite(g) || !Number.isFinite(b)) return;

      const maxMove = 7;
      const maxTilt = 2.2;

      const nx = Math.max(-1, Math.min(1, g / 35));
      const ny = Math.max(-1, Math.min(1, b / 35));

      target.x = nx * maxMove;
      target.y = ny * maxMove;
      target.rx = (-ny) * maxTilt;
      target.ry = (nx) * maxTilt;
    }

    async function enableGyro(){
      if (gyroEnabled) return;
      const DOE = window.DeviceOrientationEvent;
      if (DOE && typeof DOE.requestPermission === "function"){
        try{
          const res = await DOE.requestPermission();
          if (res !== "granted"){
            toast("Parallax", "Gyroscope permission not granted");
            return;
          }
        }catch(_){
          toast("Parallax", "Gyroscope permission blocked");
          return;
        }
      }
      window.addEventListener("deviceorientation", onOrient, { passive:true });
      gyroEnabled = true;
      toast("Parallax", "Gyroscope enabled ✅");
    }

    if ("DeviceOrientationEvent" in window){
      const DOE = window.DeviceOrientationEvent;
      if (DOE && typeof DOE.requestPermission === "function"){
        // iOS: enable on tap
        hero.addEventListener("click", enableGyro);
      } else {
        // Android/others: enable immediately
        enableGyro();
      }
    }
  }

  async function load(){
    const url = new URL(window.location.href);
    const pin = (url.searchParams.get("pin") || "").trim();
    if (!pin){
      el("hTitle").textContent = "Missing PIN";
      el("hSub").textContent = "Open a product from the shop page.";
      return;
    }

    const r = await fetch(`${API_PRODUCT}?pin=${encodeURIComponent(pin)}`);
    const data = await r.json();

    if (!r.ok){
      el("hTitle").textContent = "Not found";
      el("hSub").textContent = data?.error || "Product not found";
      return;
    }

    const p = data.product;

    document.title = `${p.title} • Mosaic Pins`;
    el("hTitle").textContent = p.title;
    el("hSub").textContent = `${p.pin} • Ø ${p.diameter ?? "—"} mm`;

    el("kicker").textContent = p.type ? String(p.type) : "";
    el("title").textContent = p.title;
    el("desc").textContent = (p.description || "").trim();

    // chips
    const chips = [];
    if (p.color) chips.push(`Color: ${p.color}`);
    if (p.diameter != null) chips.push(`Ø ${p.diameter} mm`);
    (p.materials || []).forEach(m => chips.push(m));
    el("chips").innerHTML = chips.map(c => `<span class="chip">${escapeHtml(c)}</span>`).join("");

    // images
    const images = Array.isArray(p.images) ? p.images : [];
    buildCarousel(images, p.title);
    renderThumbs(images, p.title);
    wireCarousel();
    updateNav();

    // stock
    const stock = Number(p.stock || 0);
    const badge = el("stockBadge");
    const buyBtn = el("buyBtn");
    if (stock > 0){
      badge.textContent = `In stock: ${stock}`;
      badge.classList.remove("sold");
      buyBtn.disabled = false;
    } else {
      badge.textContent = "Sold out";
      badge.classList.add("sold");
      buyBtn.disabled = true;
    }

    // qty controls
    const qtyInput = el("qty");
    qtyInput.value = "1";
    const setQty = (v) => { qtyInput.value = String(clampQty(v, stock)); };
    el("minus").addEventListener("click", () => setQty(Number(qtyInput.value) - 1));
    el("plus").addEventListener("click", () => setQty(Number(qtyInput.value) + 1));
    qtyInput.addEventListener("input", () => setQty(qtyInput.value));

    // price
    const renderPrice = () => { el("price").textContent = priceText(p.price); };
    el("currency").addEventListener("change", renderPrice);
    renderPrice();

    // checkout
    buyBtn.addEventListener("click", async () => {
      const quantity = clampQty(qtyInput.value, stock);
      if (stock <= 0) return;

      toast("Checkout", "Opening Stripe…");
      buyBtn.disabled = true;

      try{
        const res = await fetch(API_CHECKOUT, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ pin: p.pin, quantity })
        });
        const out = await res.json();
        if (out.url) window.location.href = out.url;
        else {
          toast("Error", out.error || "Checkout failed");
          buyBtn.disabled = false;
          console.log(out);
        }
      }catch(e){
        toast("Error", "Network error");
        buyBtn.disabled = false;
        console.error(e);
      }
    });

    setupParallax();
  }

  load();
</script>
</body>
</html>