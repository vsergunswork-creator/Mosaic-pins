<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Product ‚Ä¢ Mosaic Pins</title>

  <meta name="description" content="Handcrafted mosaic pins for knife handles." />
  <link rel="canonical" href="https://mosaicpins.space/" />

  <style>
    :root{
      --bg:#0b0d11;
      --text:#e9eef7;
      --muted:#a8b3c7;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 30px rgba(0,0,0,.45);
      --r:18px;

      --overlay: rgba(0,0,0,.72);
      --overlay2: rgba(0,0,0,.82);
      --panel: rgba(0,0,0,.28);
      --panelHover: rgba(255,255,255,.05);
    }

    *{box-sizing:border-box}
    *{ -webkit-tap-highlight-color: rgba(0,0,0,0); }

    html,body{height:100%}

    /* ‚úÖ body –Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è ‚Äî —Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –≤ .content */
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color:var(--text);
      overflow:hidden;
      position:relative;
      isolation:isolate;
      overscroll-behavior:none;
    }

    body::before{
      content:"";
      position:fixed;
      inset:-20vh -20vw;
      z-index:-1;
      pointer-events:none;
      background:
        radial-gradient(1100px 700px at 35% -10%, rgba(50,220,150,.25), transparent 55%),
        radial-gradient(900px 600px at 75% 10%, rgba(120,90,255,.22), transparent 55%),
        var(--bg);
      filter: blur(18px) saturate(1.05);
      transform: translateZ(0);
      will-change: transform;
    }

    *{
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.18) rgba(0,0,0,.25);
    }
    *::-webkit-scrollbar{width:10px;height:10px}
    *::-webkit-scrollbar-track{background:rgba(0,0,0,.25); border-radius:999px}
    *::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18); border-radius:999px; border:2px solid rgba(0,0,0,.25)}
    *::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.25)}

    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      height:100vh;
      gap:16px;
      padding:16px;
      min-height:0;
    }

    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
    }
    .sb-top{padding:18px 18px 10px; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.4px;}
    .dot{width:10px;height:10px;border-radius:50%; background:linear-gradient(135deg,#22c55e,#60a5fa);}
    .pill{padding:8px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--line); color:var(--muted); font-size:12px; white-space:nowrap;}

    .sb-nav{padding:6px; display:grid; gap:6px;}
    .nav-item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:12px;
      color:var(--muted); text-decoration:none; border:1px solid transparent;
    }
    .nav-item:hover{background:rgba(255,255,255,.05); color:var(--text);}
    .nav-item.active{background:rgba(34,197,94,.12); border-color: rgba(34,197,94,.22); color:var(--text);}

    .main{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
      min-height:0;
    }

    .topbar{
      padding:16px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
      flex-wrap:wrap;
      flex:0 0 auto;
    }

    .h-title{font-weight:900; font-size:18px; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .sub{color:var(--muted); font-size:12px; margin-top:4px}
    .topRight{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}

    .currency,
    .shipCountry{
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-size:13px;
      outline:none;
      white-space:nowrap;
      min-height:44px;
      appearance:none;
    }

    .cartBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.28);
      border:1px solid var(--line);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
      text-decoration:none;
      min-height:44px;
      line-height:1.1;
    }
    .cartBtn:hover{background:rgba(255,255,255,.06)}
    .cartBadge{
      padding:4px 8px;
      border-radius:999px;
      background:rgba(34,197,94,.18);
      border:1px solid rgba(34,197,94,.25);
      color:var(--text);
      font-size:12px;
      font-weight:900;
      line-height:1;
      min-width:24px;
      text-align:center;
    }

    /* ‚úÖ –≥–ª–∞–≤–Ω—ã–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª —Ç–µ–ø–µ—Ä—å —Ç—É—Ç (+ –∑–∞—â–∏—Ç–∞ –æ—Ç –Ω–∏–∂–Ω–∏—Ö –∫–Ω–æ–ø–æ–∫) */
    .content{
      padding:18px;
      padding-bottom: calc(18px + env(safe-area-inset-bottom, 0px) + 14px);
      overflow:auto;
      min-height:0;
      flex:1 1 auto;

      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }

    .wrap{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      align-items:stretch;
    }

    @media (max-width:980px){
      .app{grid-template-columns:1fr; height:100vh; padding:12px;}
      .sidebar{display:none}
      .wrap{grid-template-columns:1fr; align-items:start;}
      .content{padding:14px; padding-bottom: calc(14px + env(safe-area-inset-bottom, 0px) + 14px);}
    }

    .panel{
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      border-radius:16px;
      overflow:hidden;
      box-shadow: var(--shadow);
    }

    .gallery{padding:12px; display:grid; gap:10px;}

    .hero{
      aspect-ratio: 1/1;
      border-radius:14px;
      overflow:hidden;
      background:linear-gradient(135deg, rgba(34,197,94,.14), rgba(96,165,250,.10));
      border:1px solid var(--line);
      position:relative;
      perspective: 900px;
      user-select:none;
      touch-action: pan-y;
    }

    .hero-inner{width:100%; height:100%; transform-style: preserve-3d; will-change: transform;}

    .carousel{
      width:100%;
      height:100%;
      overflow-x:auto;
      overflow-y:hidden;
      display:flex;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
      user-select:none;
      cursor: grab;
      touch-action: pan-x pan-y;
    }
    .carousel::-webkit-scrollbar{display:none;}
    .carousel.dragging{cursor: grabbing;}
    .slide{flex: 0 0 100%; width:100%; height:100%; scroll-snap-align:center;}
    .slide img{width:100%; height:100%; object-fit:cover; display:block; pointer-events:none;}
    .heroEmpty{width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--muted);}

    .navBtn{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.55);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      backdrop-filter: blur(10px);
      transition: transform .15s ease, filter .15s ease, opacity .15s ease;
      opacity:.95;
      user-select:none;
      z-index:5;
    }
    .navBtn:hover{filter:brightness(1.1); transform:translateY(-50%) scale(1.03)}
    .navBtn:active{transform:translateY(-50%) scale(.98)}
    .navPrev{left:10px;}
    .navNext{right:10px;}
    .navBtn[disabled]{opacity:.35; cursor:not-allowed;}
    @media (max-width:980px){ .navBtn{display:none;} }

    .counter{
      position:absolute;
      left:10px;
      bottom:10px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.55);
      color:var(--text);
      backdrop-filter: blur(10px);
      z-index:5;
      display:none;
    }

    .thumbs{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:4px;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-x;
    }

    .t{
      width:72px; height:72px; border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      overflow:hidden; cursor:pointer;
      flex:0 0 auto;
      opacity:.8;
    }
    .t.active{outline:2px solid rgba(34,197,94,.45); opacity:1}
    .t img{width:100%; height:100%; object-fit:cover; display:block;}

    #rightPanel{
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    #rightPanel .details{
      flex:1 1 auto;
      min-height:0;
      overflow:visible;
    }

    .details{padding:16px;}
    .kicker{color:var(--muted); font-size:12px}
    .title{font-size:22px; font-weight:950; margin:6px 0 8px;}

    .meta{
      color:var(--text);
      font-size:13px;
      line-height:1.7;
      word-break: break-word;
      margin-top:10px;
    }
    .meta p{margin:0 0 10px}
    .meta p:last-child{margin-bottom:0}
    .meta ul, .meta ol{margin:10px 0 10px 18px; padding:0}
    .meta li{margin:6px 0}
    .meta strong{font-weight:950}
    .meta em{opacity:.95}
    .meta h3, .meta h4, .meta h5{
      margin:14px 0 8px;
      font-weight:950;
      letter-spacing:.2px;
      color:var(--text);
    }
    .meta h3{font-size:15px}
    .meta h4{font-size:14px}
    .meta h5{font-size:13px}
    .meta a{color:inherit; text-decoration:underline; text-underline-offset:2px}

    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px;}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      font-size:12px;
    }

    .priceRow{
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
      margin:16px 0 10px;
    }
    .price{font-size:20px; font-weight:950;}
    .badge{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.55);
      color:var(--text);
      backdrop-filter: blur(10px);
    }
    .sold{background:rgba(239,68,68,.22); border-color:rgba(239,68,68,.28)}

    .actions{display:grid; gap:10px; margin-top:14px; position:relative; z-index:1;}
    .qtyRow{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .qtyRow label{color:var(--muted); font-size:13px}
    .qty{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
    }
    .qty button{
      width:34px; height:34px; border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .qty input{
      width:52px;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:14px;
      text-align:center;
      font-weight:900;
    }

    .btn{
      border:none; cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#07110b;
      font-weight:950;
      box-shadow: 0 10px 18px rgba(34,197,94,.18);
      transition: filter .15s ease, transform .15s ease;
      display:block;
      width:100%;
      min-height:44px;
    }
    .btn:hover{filter:brightness(1.05); transform: translateY(-1px)}
    .btn:disabled{
      cursor:not-allowed;
      background:rgba(255,255,255,.10);
      color:rgba(255,255,255,.55);
      box-shadow:none;
      transform:none;
    }

    .btn2{
      border:none; cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:950;
      transition: background .15s ease, transform .15s ease;
      display:block;
      width:100%;
      min-height:44px;
    }
    .btn2:hover{background:rgba(255,255,255,.10); transform: translateY(-1px)}
    .btn2:disabled{opacity:.45; cursor:not-allowed}

    /* ‚úÖ PayPal wrapper inside product card (looks like button) */
    .ppOneWrap{
      width:100%;
      min-height:44px;
      height:44px;
      border-radius:14px;
      overflow:visible; /* IMPORTANT: do not block PayPal iframe clicks */
      display:none;     /* shown when product in stock */
      align-items:center;
      justify-content:center;
      padding:0;
    }
    #paypal-one-container{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .ppOneNote{
      display:none;
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      text-align:center;
    }

    .toast{
      position: fixed;
      right: 16px;
      bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      background: rgba(0,0,0,.65);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 14px;
      color: var(--text);
      box-shadow: var(--shadow);
      max-width: 360px;
      display:none;
      z-index:999;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:block}
    .toast small{color:var(--muted)}

    /* ‚úÖ CART DRAWER */
    .cartBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.74);
      display:none;
      z-index:1100;
      backdrop-filter: blur(6px);
    }
    .cartBack.show{display:block}
    .cartDrawer{
      position:fixed;
      top:0; right:0; bottom:0;
      width:min(420px, 92vw);
      border-left:1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,0,0,.92), rgba(0,0,0,.78));
      box-shadow: -18px 0 40px rgba(0,0,0,.60);
      transform: translateX(100%);
      transition: transform .18s ease;
      z-index:1101;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      backdrop-filter: blur(10px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    .cartDrawer.show{transform: translateX(0)}
    .cartHead{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.14), rgba(0,0,0,0));
    }
    .cartTitle{font-weight:950; letter-spacing:.2px;}
    .cartClose{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.30);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:950;
      line-height:1;
    }
    .cartClose:hover{background:rgba(255,255,255,.06)}
    .cartBody{padding:12px; overflow:auto; min-height:0; -webkit-overflow-scrolling: touch;}
    .cartEmpty{
      padding:14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.04);
      color:var(--muted);
    }
    .cartItem{
      display:grid;
      grid-template-columns:64px 1fr;
      gap:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      margin-bottom:10px;
    }
    .cartImg{
      width:64px;height:64px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      color:var(--muted);
      font-size:12px;
    }
    .cartImg img{width:100%;height:100%;object-fit:cover;display:block;}
    .cartName{font-weight:900; font-size:13px; margin:0}
    .cartMeta{color:var(--muted); font-size:12px; margin:4px 0 0}
    .cartRow{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px;}
    .cartQty{
      display:flex; align-items:center; gap:6px;
      padding:6px 8px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
    }
    .cartQty button{
      width:30px;height:30px;border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .cartQty input{
      width:44px;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      text-align:center;
      font-weight:900;
    }
    .cartRemove{
      border:none;
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      font-weight:900;
      line-height:1;
    }
    .cartRemove:hover{background:rgba(255,255,255,.06)}
    .cartFoot{
      padding:12px;
      border-top:1px solid var(--line);
      background:rgba(0,0,0,.40);
      padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
    }
    .cartSumRow{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; color:var(--text); font-weight:950;}
    .cartActions{display:grid; gap:10px;}

    /* ‚úÖ EXACT buttons row like About: PayPal + Checkout + Clear */
    .actionRow{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      align-items:stretch;
    }
    .actionBtn{
      width:100%;
      min-height:44px;
      height:44px;
      padding:0 12px;
      line-height:44px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:visible; /* IMPORTANT for PayPal iframe clicks */
    }
    .ppWrap{
      display:none;
      padding:0;
    }
    #paypal-cart-container{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .ppNote{
      color:var(--muted);
      font-size:12px;
      margin-top:0;
      line-height:1.35;
      display:none;
      text-align:center;
    }

    /* ‚úÖ Footer –ù–ï —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –Ω–æ —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –Ω–∏–∂–Ω–∏–º –æ—Ç—Å—Ç—É–ø–æ–º */
    .footer{
      margin-top:auto;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.25);
      padding:14px 18px;
      padding-bottom: calc(14px + env(safe-area-inset-bottom, 0px));
      flex: 0 0 auto;
    }
    .footerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .footerBrand{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .footerLinks{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .footerLinks a{
      text-decoration:none;
      color:var(--muted);
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      transition: background .15s ease, transform .15s ease;
      white-space:nowrap;
    }
    .footerLinks a:hover{
      background:rgba(255,255,255,.08);
      transform: translateY(-1px);
      color:var(--text);
    }
    @media (max-width:980px){
      .footer{padding:12px 14px; padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));}
      .footerRow{justify-content:center;}
      .footerLinks{justify-content:center;}
    }

    @media (max-width:520px){
      .actionRow{grid-template-columns:1fr;}
      .actionBtn{height:46px; min-height:46px; line-height:46px;}
    }

    @media (prefers-reduced-motion: reduce){
      .hero-inner{will-change:auto}
    }

/* ‚úÖ GREEN CHECKOUT BUTTON (Cart) ‚Äî identical to About */
#cartCheckout{
  background: linear-gradient(135deg,#22c55e,#16a34a);
  color:#07110b;
  border:none;
  box-shadow: 0 10px 18px rgba(34,197,94,.18);
}

#cartCheckout:hover{
  filter: brightness(1.05);
  transform: translateY(-1px);
}

#cartCheckout:disabled{
  background: rgba(255,255,255,.10);
  color: rgba(255,255,255,.55);
  box-shadow:none;
  transform:none;
} 
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand"><span class="dot"></span> Mosaic Pins</div>
        <div class="pill" id="sbCount">Product</div>
      </div>

      <nav class="sb-nav">
        <a class="nav-item" href="/" id="navShop">‚Üê Back to shop</a>
        <a class="nav-item active" href="#" id="navProduct">Product</a>
      </nav>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <h1 class="h-title" id="hTitle">Loading‚Ä¶</h1>
          <div class="sub" id="hSub"></div>
        </div>

        <div class="topRight">
          <button class="cartBtn" id="openCart" type="button" title="Cart">
            üõí Cart <span class="cartBadge" id="cartBadge">0</span>
          </button>

          <select class="currency" id="currency" title="Currency">
            <option value="EUR">EUR ‚Ç¨</option>
            <option value="USD">USD $</option>
          </select>

          <select class="shipCountry" id="shipCountry" title="Shipping country">
            <option value="DE">Germany (DE)</option>
            <option value="EU">Europe (EU)</option>
            <option value="US">United States (US)</option>
            <option value="CA">Canada (CA)</option>
          </select>
        </div>
      </div>

      <div class="content">
        <div class="wrap" id="wrap">
          <section class="panel" id="leftPanel">
            <div class="gallery">
              <div class="hero" id="hero">
                <div class="hero-inner" id="heroInner">
                  <div class="carousel" id="carousel" aria-label="Product images">
                    <div class="heroEmpty">No image</div>
                  </div>
                </div>

                <button class="navBtn navPrev" id="prevBtn" type="button" aria-label="Previous image">‚Üê</button>
                <button class="navBtn navNext" id="nextBtn" type="button" aria-label="Next image">‚Üí</button>
                <div class="counter" id="counter">1 / 1</div>
              </div>

              <div class="thumbs" id="thumbs"></div>
            </div>
          </section>

          <aside class="panel" id="rightPanel">
            <div class="details">
              <div class="kicker" id="kicker"></div>
              <div class="title" id="title"></div>

              <div class="meta" id="desc"></div>
              <div class="chips" id="chips"></div>

              <div class="priceRow">
                <div class="price" id="price">‚Äî</div>
                <div class="badge" id="stockBadge">‚Äî</div>
              </div>

              <div class="actions">
                <div class="qtyRow">
                  <label>Quantity</label>
                  <div class="qty">
                    <button id="minus" type="button">‚àí</button>
                    <input id="qty" value="1" inputmode="numeric" />
                    <button id="plus" type="button">+</button>
                  </div>
                </div>

                <!-- Add to cart -->
                <button class="btn2" id="addBtn" type="button">Add to cart</button>

                <!-- ‚úÖ PayPal for this ONE product (below Add to cart) -->
                <div class="ppOneWrap btn2" id="ppOneWrap" aria-label="PayPal for this item">
                  <div id="paypal-one-container"></div>
                </div>
                <p class="ppOneNote" id="ppOneNote">PayPal is loading‚Ä¶</p>

                <!-- Stripe Buy Now (keep) -->
                <button class="btn" id="buyBtn" type="button">Buy now</button>
              </div>
            </div>
          </aside>
        </div>

        <!-- Footer inside content -->
        <footer class="footer">
          <div class="footerRow">
            <div class="footerBrand">
              <span style="display:inline-flex;align-items:center;gap:8px;">
                <span class="dot"></span>
                <span>¬© <span id="year"></span> Mosaic Pins</span>
              </span>
            </div>

            <div class="footerLinks">
              <a href="/index.html">Shop</a>
              <a href="/about">About</a>
              <a href="/shipping">Shipping</a>
              <a href="/returns">Returns</a>
              <a href="/reviews">Reviews</a>
              <a href="/privacy.html">Privacy Policy</a>
              <a href="/impressum.html">Impressum</a>
              <a href="mailto:mosaicpinsspace@gmail.com">Support</a>
            </div>
          </div>
        </footer>

      </div>
    </main>
  </div>

  <!-- Cart drawer -->
  <div class="cartBack" id="cartBack"></div>
  <div class="cartDrawer" id="cartDrawer">
    <div class="cartHead">
      <div class="cartTitle">Cart</div>
      <button class="cartClose" id="closeCart" type="button">‚úï</button>
    </div>

    <div class="cartBody" id="cartBody"></div>

    <div class="cartFoot">
      <div class="cartSumRow">
        <div>Total</div>
        <div id="cartTotal">‚Äî</div>
      </div>

      <!-- ‚úÖ EXACT Like About: PayPal + Checkout + Clear -->
      <div class="cartActions">
        <div class="actionRow">
          <div class="ppWrap btn2 actionBtn" id="ppWrap">
            <div id="paypal-cart-container"></div>
          </div>

          <button class="btn2 actionBtn" id="cartCheckout" type="button">Checkout</button>
          <button class="btn2 actionBtn" id="cartClear" type="button">Clear cart</button>
        </div>

        <div class="ppNote" id="ppNote">PayPal is loading‚Ä¶</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div style="font-weight:800" id="toastTitle">Notice</div>
    <small id="toastMsg">‚Äî</small>
  </div>

  <!-- ‚úÖ PayPal SDK placeholder (About style) -->
  <script id="pp-sdk" data-loaded="0"></script>

 <script>
  // ‚úÖ footer year
  (function(){
    const y = document.getElementById("year");
    if (y) y.textContent = String(new Date().getFullYear());
  })();

  const API_PRODUCT  = "/api/product";
  const API_CHECKOUT = "/api/checkout";

  // ‚úÖ PayPal endpoints ‚Äî SAME MODEL AS ABOUT
  const API_PP_CONFIG  = "/api/paypal/config";        // returns { clientId }
  const API_PP_CREATE  = "/api/paypal/create-order";  // returns { id }
  const API_PP_CAPTURE = "/api/paypal/capture";       // returns { ok }

  const CART_KEY    = "mp_cart";
  const MP_CUR_KEY  = "mp_currency";
  const MP_SHIP_KEY = "mp_ship_country";

  // ‚úÖ DEFAULTS (only if nothing saved yet)
  const DEFAULT_SHIP = "US";
  const DEFAULT_CUR  = "USD";

  const el = (id) => document.getElementById(id);

  // UI refs
  const elCurrency    = el("currency");
  const elShipCountry = el("shipCountry");

  function readCart(){
    try{
      const raw = localStorage.getItem(CART_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(_){ return []; }
  }
  function writeCart(arr){
    try{ localStorage.setItem(CART_KEY, JSON.stringify(arr)); }catch(_){}
  }
  function cartCount(){
    return readCart().reduce((s,it)=> s + (Number(it?.qty)||0), 0);
  }
  function updateCartBadge(){
    const badge = el("cartBadge");
    if (badge) badge.textContent = String(cartCount());
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // toast
  const toastEl    = el("toast");
  const toastTitle = el("toastTitle");
  const toastMsg   = el("toastMsg");

  function toast(title, msg){
    if (!toastEl || !toastTitle || !toastMsg) return;
    toastTitle.textContent = String(title || "Notice");
    toastMsg.textContent   = String(msg || "");
    toastEl.classList.add("show");
    clearTimeout(toastEl.__t);
    toastEl.__t = setTimeout(()=> toastEl.classList.remove("show"), 2600);
  }

  function isMobile(){
    return window.matchMedia && window.matchMedia("(max-width: 980px)").matches;
  }

  // ==========================
  // Currency + Shipping rules
  // ==========================
  function mustCurrencyByShip(ship){
    ship = String(ship || DEFAULT_SHIP).toUpperCase();
    return (ship === "US" || ship === "CA") ? "USD" : "EUR";
  }

  function getCurrency(){
    const saved = (localStorage.getItem(MP_CUR_KEY) || "").toUpperCase();
    if (saved === "EUR" || saved === "USD") return saved;
    return String(elCurrency?.value || DEFAULT_CUR).toUpperCase();
  }

  function setCurrency(cur){
    cur = String(cur || DEFAULT_CUR).toUpperCase();
    if (cur !== "EUR" && cur !== "USD") cur = DEFAULT_CUR;
    try{ localStorage.setItem(MP_CUR_KEY, cur); }catch(_){}
    if (elCurrency) elCurrency.value = cur;
  }

  function enforceCurrencyByShipping(){
    const ship = String(elShipCountry?.value || DEFAULT_SHIP).toUpperCase();
    const must = mustCurrencyByShip(ship);
    if (getCurrency() !== must){
      setCurrency(must);
    }
  }

  (function restoreSettings(){
    try{
      const shipSaved = (localStorage.getItem(MP_SHIP_KEY) || "").toUpperCase();
      const curSaved  = (localStorage.getItem(MP_CUR_KEY)  || "").toUpperCase();

      // SHIPPING
      if (shipSaved && ["DE","EU","US","CA"].includes(shipSaved) && elShipCountry){
        elShipCountry.value = shipSaved;
      } else if (elShipCountry){
        elShipCountry.value = DEFAULT_SHIP;
        try{ localStorage.setItem(MP_SHIP_KEY, DEFAULT_SHIP); }catch(_){}
      }

      // CURRENCY
      if (curSaved && (curSaved === "EUR" || curSaved === "USD") && elCurrency){
        elCurrency.value = curSaved;
      } else {
        setCurrency(DEFAULT_CUR);
      }

      enforceCurrencyByShipping();
      setCurrency(getCurrency());
    }catch(_){}
  })();

  // IMPORTANT: EU must send a real EU ISO2 so backend detectZone() returns "EU"
  function getShippingCountryISO2(){
    const v = String(elShipCountry?.value || DEFAULT_SHIP).toUpperCase();
    if (v === "US") return "US";
    if (v === "CA") return "CA";
    if (v === "EU") return "FR"; // any EU ISO2 works
    return "DE";
  }

  // ==========================
  // Product URL + helpers
  // ==========================
  function getPinFromUrl(){
    const u = new URL(window.location.href);

    const qPin = (u.searchParams.get("pin") || "").trim();
    if (qPin) return qPin;

    const parts = u.pathname.split("/").filter(Boolean);
    if (parts[0] === "p" && parts[1]) return decodeURIComponent(parts[1]).trim();

    return "";
  }

  let currentProduct = null;

  function priceText(priceObj){
    const cur = getCurrency();
    const v = priceObj?.[cur];
    if (typeof v !== "number") return cur === "EUR" ? "‚Äî ‚Ç¨" : "‚Äî $";
    return cur === "EUR" ? `${v.toFixed(2)} ‚Ç¨` : `${v.toFixed(2)} $`;
  }

  function refreshPriceUI(){
    if (currentProduct){
      el("price").textContent = priceText(currentProduct.price);
    }
  }

  function clampQty(q, max){
    q = Number(q);
    if (!Number.isFinite(q)) q = 1;
    if (q < 1) q = 1;
    if (max >= 1 && q > max) q = max;
    return q;
  }

  // ==========================
  // Airtable text -> HTML (your rich text)
  // ==========================
  function mdInlineToHtml(line){
    let s = escapeHtml(line);
    s = s.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
    s = s.replace(/(^|[^*])\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, "$1<em>$2</em>");
    s = s.replace(/__(.+?)__/g, "<u>$1</u>");
    s = s.replace(
      /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
      `<a href="$2" target="_blank" rel="noopener" style="color:inherit; text-decoration:underline; opacity:.95;">$1</a>`
    );
    return s;
  }

  function airtableTextToHtml(raw){
    const text = String(raw || "").replace(/\r\n/g, "\n").trim();
    if (!text) return "";

    const lines = text.split("\n");
    let html = "";
    let inList = false;

    const closeList = () => {
      if (inList){
        html += "</ul>";
        inList = false;
      }
    };

    for (let i=0;i<lines.length;i++){
      const l0 = lines[i];
      const line = l0.trimEnd();

      if (!line.trim()){
        closeList();
        html += "<div style='height:10px'></div>";
        continue;
      }

      if (line.startsWith("# ")){
        closeList();
        html += `<h3 style="margin:14px 0 8px; font-size:14px; letter-spacing:.2px;">${mdInlineToHtml(line.slice(2).trim())}</h3>`;
        continue;
      }

      const isBullet = line.trim().startsWith("- ") || line.trim().startsWith("‚Ä¢ ");
      if (isBullet){
        if (!inList){
          html += "<ul style='margin:10px 0 0 18px; padding:0; display:grid; gap:6px;'>";
          inList = true;
        }
        const item = line.trim().replace(/^(- |‚Ä¢ )/, "");
        html += `<li style="color:var(--muted); font-size:13px; line-height:1.55;">${mdInlineToHtml(item)}</li>`;
        continue;
      }

      closeList();
      html += `<p style="margin:0 0 10px; color:var(--muted); font-size:13px; line-height:1.65;">${mdInlineToHtml(line)}</p>`;
    }

    closeList();
    return html;
  }

  // ==========================
  // Listeners: currency/shipping
  // ==========================
  if (elCurrency){
    elCurrency.addEventListener("change", () => {
      setCurrency(elCurrency.value);
      enforceCurrencyByShipping();
      renderCart();

      // ‚úÖ currency affects PayPal SDK -> hard reset like About
      resetPayPalHard();

      refreshPriceUI();
    });
  }

  if (elShipCountry){
    elShipCountry.addEventListener("change", () => {
      try{ localStorage.setItem(MP_SHIP_KEY, String(elShipCountry.value || DEFAULT_SHIP).toUpperCase()); }catch(_){}
      enforceCurrencyByShipping();
      renderCart();

      // ‚úÖ shipping may switch currency -> hard reset PayPal
      resetPayPalHard();

      refreshPriceUI();
      toast("Shipping", `Destination: ${elShipCountry.value}`);
    });
  }

  // ==========================
  // Cart drawer refs + open/close
  // ==========================
  const elOpenCart     = el("openCart");
  const elCartBack     = el("cartBack");
  const elCartDrawer   = el("cartDrawer");
  const elCloseCart    = el("closeCart");
  const elCartBody     = el("cartBody");
  const elCartTotal    = el("cartTotal");
  const elCartCheckout = el("cartCheckout");
  const elCartClear    = el("cartClear");

  // PayPal UI (cart)
  const elPpWrap = el("ppWrap");
  const elPpNote = el("ppNote");

  function openCart(){
    elCartBack?.classList.add("show");
    elCartDrawer?.classList.add("show");
    if (!isMobile()) document.body.style.overflow = "hidden";

    renderCart();

    // ‚úÖ IMPORTANT: drawer must be visible before PayPal renders
    setTimeout(() => {
      maybeInitPayPal();
    }, 180);
  }

  function closeCart(){
    elCartBack?.classList.remove("show");
    elCartDrawer?.classList.remove("show");
    document.body.style.overflow = "";
  }

  elOpenCart?.addEventListener("click", openCart);
  elCloseCart?.addEventListener("click", closeCart);
  elCartBack?.addEventListener("click", closeCart);

  window.addEventListener("keydown", (e)=>{
    if (e.key !== "Escape") return;
    const cartOpen = elCartDrawer?.classList.contains("show");
    if (cartOpen) closeCart();
  });

  // ==========================
  // Cart logic (render)
  // ==========================
  function cartTotal(){
    const cur = getCurrency();
    const cart = readCart();
    let sum = 0;
    for (const it of cart){
      const unit = Number(it?.price?.[cur]);
      if (Number.isFinite(unit)) sum += unit * (Number(it?.qty)||0);
    }
    return sum;
  }

  function setCartQty(pin, qty){
    const cart = readCart();
    const idx = cart.findIndex(x => String(x.pin) === String(pin));
    if (idx < 0) return;

    const stock = Number(cart[idx].stock ?? 0);
    qty = Number(qty);
    if (!Number.isFinite(qty)) qty = 1;
    qty = Math.max(1, qty);
    if (stock > 0) qty = Math.min(stock, qty);

    cart[idx].qty = qty;
    writeCart(cart);
    updateCartBadge();
    renderCart();

    // ‚úÖ PayPal must re-render for new snapshot
    ppRenderedForKey = "";
    renderPayPalButtonsIfNeeded();
  }

  function removeFromCart(pin){
    const cart = readCart().filter(x => String(x.pin) !== String(pin));
    writeCart(cart);
    updateCartBadge();
    renderCart();

    ppRenderedForKey = "";
    renderPayPalButtonsIfNeeded();
  }

  function clearCart(){
    writeCart([]);
    updateCartBadge();
    renderCart();

    ppRenderedForKey = "";
    renderPayPalButtonsIfNeeded();
  }

  function priceTextFromItem(it, cur){
    const unit = it?.price?.[cur];
    if (typeof unit !== "number") return "‚Äî";
    return cur === "EUR" ? `${unit.toFixed(2)} ‚Ç¨` : `${unit.toFixed(2)} $`;
  }

  function renderCart(){
    if (!elCartBody || !elCartTotal || !elCartCheckout) return;

    const cart = readCart();
    const cur = getCurrency();

    // ‚úÖ show/hide PayPal button like About
    if (elPpWrap) elPpWrap.style.display = cart.length ? "flex" : "none";
    if (elPpNote){
      elPpNote.style.display = cart.length ? "block" : "none";
      elPpNote.textContent = cart.length ? "PayPal is loading‚Ä¶" : "";
    }

    elCartCheckout.disabled = !cart.length;
    elCartClear.disabled = !cart.length;

    if (!cart.length){
      elCartBody.innerHTML = `<div class="cartEmpty">Your cart is empty.</div>`;
      elCartTotal.textContent = "‚Äî";

      clearPayPalButtons();
      ppRenderedForKey = "";
      return;
    }

    elCartBody.innerHTML = cart.map(it => {
      const img = it.image
        ? `<img src="${escapeHtml(it.image)}" alt="${escapeHtml(it.title)}" />`
        : `<span>‚Äî</span>`;

      const unitText = priceTextFromItem(it, cur);

      return `
        <div class="cartItem" data-pin="${escapeHtml(String(it.pin || ""))}">
          <div class="cartImg">${img}</div>
          <div>
            <p class="cartName">${escapeHtml(it.title || it.pin)}</p>
            <div class="cartMeta">${escapeHtml(it.pin)} ‚Ä¢ ${unitText}</div>
            <div class="cartRow">
              <div class="cartQty">
                <button type="button" data-act="minus">‚àí</button>
                <input value="${escapeHtml(String(it.qty || 1))}" inputmode="numeric" />
                <button type="button" data-act="plus">+</button>
              </div>
              <button class="cartRemove" type="button" data-act="remove">‚úï</button>
            </div>
            <div class="cartMeta" style="margin-top:8px;">Stock: ${escapeHtml(it.stock ?? "‚Äî")}</div>
          </div>
        </div>
      `;
    }).join("");

    [...elCartBody.querySelectorAll(".cartItem")].forEach(row => {
      const pin = row.getAttribute("data-pin") || "";
      const input = row.querySelector("input");

      row.querySelector('button[data-act="minus"]')?.addEventListener("click", () => setCartQty(pin, Number(input?.value) - 1));
      row.querySelector('button[data-act="plus"]')?.addEventListener("click",  () => setCartQty(pin, Number(input?.value) + 1));

      input?.addEventListener("input", () => {
        const v = Number(input.value);
        if (!Number.isFinite(v)) return;
        setCartQty(pin, v);
      });

      row.querySelector('button[data-act="remove"]')?.addEventListener("click", () => removeFromCart(pin));
    });

    const sum = cartTotal();
    elCartTotal.textContent = (cur==="EUR") ? `${sum.toFixed(2)} ‚Ç¨` : `${sum.toFixed(2)} $`;

    // ‚úÖ init/render PayPal when cart visible
    setTimeout(() => {
      maybeInitPayPal();
      renderPayPalButtonsIfNeeded();
    }, 0);
  }

  elCartClear?.addEventListener("click", () => { clearCart(); toast("Cart", "Cleared"); });

  // Stripe checkout from cart
  async function startCheckout(){
    const cart = readCart();
    if (!cart.length){ toast("Checkout", "Cart is empty"); return; }

    try{ localStorage.setItem(MP_SHIP_KEY, String(elShipCountry?.value || DEFAULT_SHIP).toUpperCase()); }catch(_){}
    enforceCurrencyByShipping();

    const payload = {
      currency: getCurrency(),
      shippingCountry: getShippingCountryISO2(),
      items: cart.map(it => ({ pin: String(it.pin), qty: Number(it.qty) || 1 })),
    };

    if (elCartCheckout){
      elCartCheckout.disabled = true;
      elCartCheckout.textContent = "Redirecting‚Ä¶";
    }

    try{
      const r = await fetch(API_CHECKOUT, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
      });

      const data = await r.json().catch(()=>({}));
      if (!r.ok || !data?.ok || !data?.url){
        throw new Error(data?.error || "Checkout failed");
      }

      window.location.href = data.url;
    }catch(e){
      toast("Checkout", String(e?.message || e));
      if (elCartCheckout){
        elCartCheckout.disabled = false;
        elCartCheckout.textContent = "Checkout";
      }
    }finally{
      if (elCartCheckout && !elCartCheckout.disabled) elCartCheckout.textContent = "Checkout";
    }
  }
  elCartCheckout?.addEventListener("click", startCheckout);

  // initial state
  updateCartBadge();
  renderCart();

  // enforce currency on first load too
  enforceCurrencyByShipping();
  setCurrency(getCurrency());

  // ==========================
  // ‚úÖ PayPal (About-style) ‚Äî shared for cart + one-item
  // ==========================
  let ppReady = false;
  let ppLoading = false;
  let ppRenderedForKey = "";

  function cartSnapshotKey(){
    const cart = readCart();
    const cur = getCurrency();
    const ship = String(elShipCountry?.value || DEFAULT_SHIP).toUpperCase();
    const itemsKey = cart.map(it => `${String(it.pin)}:${Number(it.qty)||1}`).sort().join("|");
    return `${cur}|${ship}|${itemsKey}`;
  }

  function showPayPalNote(msg){
    if (!elPpNote) return;
    elPpNote.textContent = String(msg || "");
    elPpNote.style.display = msg ? "block" : "none";
  }

  async function fetchPayPalClientId(){
    const r = await fetch(API_PP_CONFIG, { method:"GET", cache:"no-store" });
    const j = await r.json().catch(()=>null);
    if (!r.ok || !j?.clientId) throw new Error(j?.error || "PayPal config error");
    return String(j.clientId);
  }

  function clearPayPalButtons(){
    const wrap = document.getElementById("paypal-cart-container");
    if (wrap) wrap.innerHTML = "";
  }

  // HARD reset: remove SDK script + window.paypal (important for currency changes)
  function resetPayPalHard(){
    ppReady = false;
    ppLoading = false;
    ppRenderedForKey = "";

    try{ clearPayPalButtons(); }catch(_){}
    try{ showPayPalNote(""); }catch(_){}

    try{
      const old = document.getElementById("pp-sdk");
      if (old && old.parentNode){
        old.parentNode.removeChild(old);
      }
    }catch(_){}

    try{ delete window.paypal; }catch(_){}
    try{ window.paypal = undefined; }catch(_){}

    // recreate placeholder
    try{
      const s = document.createElement("script");
      s.id = "pp-sdk";
      s.setAttribute("data-loaded","0");
      document.body.appendChild(s);
    }catch(_){}

    // also reset ONE item render state
    ppOneRenderedForKey = "";
    clearPayPalOneButtons();
  }

// ==========================
  // PayPal SDK loader (About-style)
  // ==========================
  function loadPayPalSDK(clientId){
    return new Promise((resolve, reject) => {
      try{
        // already available
        if (window.paypal && typeof window.paypal.Buttons === "function"){
          resolve(true);
          return;
        }

        const s = document.getElementById("pp-sdk");
        if (!s) throw new Error("pp-sdk tag missing");

        const cur = getCurrency();

        const url =
          "https://www.paypal.com/sdk/js" +
          `?client-id=${encodeURIComponent(clientId)}` +
          `&currency=${encodeURIComponent(cur)}` +
          `&intent=capture` +
          `&components=buttons` +
          `&disable-funding=card,sepa,ideal,bancontact,sofort,giropay,eps,mybank,p24,venmo`;

        // if same src already set: wait until ready
        if (s.src && s.src === url){
          const t0 = Date.now();
          const tick = () => {
            if (window.paypal && typeof window.paypal.Buttons === "function") return resolve(true);
            if (Date.now() - t0 > 12000) return reject(new Error("PayPal SDK timeout"));
            setTimeout(tick, 120);
          };
          tick();
          return;
        }

        // if different src: hard reset then retry
        if (s.src && s.src !== url){
          resetPayPalHard();
          fetchPayPalClientId().then(loadPayPalSDK).then(resolve).catch(reject);
          return;
        }

        s.onload = () => resolve(true);
        s.onerror = () => reject(new Error("PayPal SDK failed to load"));
        s.src = url;
        s.setAttribute("data-loaded","1");
      }catch(e){
        reject(e);
      }
    });
  }

  async function maybeInitPayPal(){
    try{
      const cart = readCart();
      const cartOpen = elCartDrawer?.classList.contains("show");

      // only when drawer is open and has items
      if (!cartOpen) return;
      if (!cart.length){
        if (elPpWrap) elPpWrap.style.display = "none";
        return;
      }

      if (elPpWrap) elPpWrap.style.display = "flex";

      enforceCurrencyByShipping();
      setCurrency(getCurrency());

      if (ppReady){
        renderPayPalButtonsIfNeeded();
        return;
      }
      if (ppLoading) return;

      ppLoading = true;
      showPayPalNote("PayPal is loading‚Ä¶");

      const clientId = await fetchPayPalClientId();
      await loadPayPalSDK(clientId);

      ppReady = true;
      ppLoading = false;

      showPayPalNote("");
      renderPayPalButtonsIfNeeded();
    }catch(e){
      ppLoading = false;
      ppReady = false;
      showPayPalNote(`PayPal unavailable: ${String(e?.message || e)}`);
    }
  }

  function renderPayPalButtonsIfNeeded(){
    if (!ppReady) return;
    if (!window.paypal || typeof window.paypal.Buttons !== "function") return;

    const cartOpen = elCartDrawer?.classList.contains("show");
    if (!cartOpen) return;

    const cart = readCart();
    if (!cart.length){
      clearPayPalButtons();
      ppRenderedForKey = "";
      return;
    }

    // ensure wrap is visible (otherwise iframe becomes unclickable)
    if (elPpWrap && getComputedStyle(elPpWrap).display === "none") return;

    const key = cartSnapshotKey();
    if (key === ppRenderedForKey) return;

    // clear old iframe/buttons
    clearPayPalButtons();
    ppRenderedForKey = key;

    window.paypal.Buttons({
      style: { layout:"horizontal", tagline:false, height: 44 },

      createOrder: async () => {
        const cartNow = readCart();
        if (!cartNow.length) throw new Error("Cart is empty");

        enforceCurrencyByShipping();
        setCurrency(getCurrency());

        const payload = {
          currency: getCurrency(),
          shippingCountry: getShippingCountryISO2(),
          items: cartNow.map(it => ({ pin: String(it.pin), qty: Number(it.qty) || 1 })),
        };

        const r = await fetch(API_PP_CREATE, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload),
        });

        const data = await r.json().catch(()=>({}));
        if (!r.ok || !data?.id) throw new Error(data?.error || "PayPal create order failed");
        return data.id;
      },

      onApprove: async (data) => {
        try{
          const orderID = data?.orderID;
          if (!orderID) throw new Error("Missing orderID");

          const r = await fetch(API_PP_CAPTURE, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ orderID }),
          });

          const j = await r.json().catch(()=>({}));
          if (!r.ok || !j?.ok) throw new Error(j?.error || "Capture failed");

          writeCart([]);
          updateCartBadge();
          renderCart();
          toast("PayPal", "Payment success ‚úÖ");

          // close cart after success (optional)
          closeCart();
        }catch(e){
          toast("PayPal", String(e?.message || e));
        }
      },

      onCancel: () => toast("PayPal", "Canceled"),
      onError: (err) => toast("PayPal", String(err?.message || err || "PayPal error")),
    }).render("#paypal-cart-container");
  }

  // ==========================
  // ‚úÖ PayPal ONE-ITEM (under Add to cart)
  // uses SAME SDK as cart, but different container
  // ==========================
  const elPpOneWrap = el("ppOneWrap");
  const elPpOneNote = el("ppOneNote");

  function clearPayPalOneButtons(){
    const wrap = document.getElementById("paypal-one-container");
    if (wrap) wrap.innerHTML = "";
  }

  let ppOneRenderedForKey = "";

  function oneSnapshotKey(){
    const p = currentProduct;
    if (!p) return "";
    const cur = getCurrency();
    const ship = String(elShipCountry?.value || DEFAULT_SHIP).toUpperCase();
    const qty = Number(el("qty")?.value || 1) || 1;
    return `${cur}|${ship}|${String(p.pin)}|${qty}`;
  }

  async function maybeInitPayPalOne(){
    const p = currentProduct;
    if (!p) return;

    const stock = Number(p.stock || 0);
    if (stock <= 0) return;

    if (!elPpOneWrap) return;

    // must be visible for clickability
    if (getComputedStyle(elPpOneWrap).display === "none") return;

    // ensure currency/shipping rules
    enforceCurrencyByShipping();
    setCurrency(getCurrency());

    // ensure SDK ready
    if (!ppReady && !ppLoading){
      // If cart isn't open, we still can init SDK for one-item:
      try{
        ppLoading = true;
        if (elPpOneNote){
          elPpOneNote.textContent = "PayPal is loading‚Ä¶";
          elPpOneNote.style.display = "block";
        }
        const clientId = await fetchPayPalClientId();
        await loadPayPalSDK(clientId);
        ppReady = true;
        ppLoading = false;
      }catch(e){
        ppLoading = false;
        ppReady = false;
        if (elPpOneNote){
          elPpOneNote.textContent = `PayPal unavailable: ${String(e?.message || e)}`;
          elPpOneNote.style.display = "block";
        }
        return;
      }
    } else if (ppLoading){
      return;
    }

    // now render buttons
    if (!window.paypal || typeof window.paypal.Buttons !== "function") return;

    const key = oneSnapshotKey();
    if (key === ppOneRenderedForKey) return;

    clearPayPalOneButtons();
    ppOneRenderedForKey = key;

    if (elPpOneNote){
      elPpOneNote.textContent = "";
      elPpOneNote.style.display = "none";
    }

    window.paypal.Buttons({
      style: { layout:"horizontal", tagline:false, height: 44 },

      createOrder: async () => {
        enforceCurrencyByShipping();
        setCurrency(getCurrency());

        const qtyInput = el("qty");
        const q = clampQty(qtyInput?.value || 1, Number(p.stock || 0));

        const payload = {
          currency: getCurrency(),
          shippingCountry: getShippingCountryISO2(),
          items: [{ pin: String(p.pin), qty: Number(q) || 1 }],
        };

        const r = await fetch(API_PP_CREATE, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload),
        });

        const data = await r.json().catch(()=>({}));
        if (!r.ok || !data?.id) throw new Error(data?.error || "PayPal create order failed");
        return data.id;
      },

      onApprove: async (data) => {
        try{
          const orderID = data?.orderID;
          if (!orderID) throw new Error("Missing orderID");

          const r = await fetch(API_PP_CAPTURE, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ orderID }),
          });

          const j = await r.json().catch(()=>({}));
          if (!r.ok || !j?.ok) throw new Error(j?.error || "Capture failed");

          toast("PayPal", "Payment success ‚úÖ");

          // IMPORTANT: for one-item PayPal we do NOT clear cart
          // redirect if backend returns url (optional)
          if (j?.redirectUrl) window.location.href = j.redirectUrl;
        }catch(e){
          toast("PayPal", String(e?.message || e));
        }
      },

      onCancel: () => toast("PayPal", "Canceled"),
      onError: (err) => toast("PayPal", String(err?.message || err || "PayPal error")),
    }).render("#paypal-one-container");
  }

  // re-render one-item paypal when qty changes
  (function wireQtyForPayPalOne(){
    const qtyInput = el("qty");
    if (!qtyInput) return;

    let t;
    qtyInput.addEventListener("input", () => {
      clearTimeout(t);
      t = setTimeout(() => {
        ppOneRenderedForKey = "";
        maybeInitPayPalOne();
      }, 120);
    });
  })();

// ==========================
  // Carousel (unchanged)
  // ==========================
  const hero      = el("hero");
  const heroInner = el("heroInner");
  const carousel  = el("carousel");
  const prevBtn   = el("prevBtn");
  const nextBtn   = el("nextBtn");
  const counter   = el("counter");

  let currentIndex = 0;
  let imagesState = [];
  let carouselWired = false;

  function updateNav(){
    const n = imagesState.length;
    const hasMany = n > 1;

    if (counter){
      counter.style.display = n >= 2 ? "block" : "none";
      counter.textContent = `${Math.min(currentIndex+1, n)} / ${n}`;
    }
    if (prevBtn) prevBtn.disabled = !hasMany || currentIndex <= 0;
    if (nextBtn) nextBtn.disabled = !hasMany || currentIndex >= n-1;
  }

  function syncThumbs(){
    const thumbs = el("thumbs");
    if (!thumbs) return;
    thumbs.querySelectorAll(".t").forEach(t => t.classList.remove("active"));
    const active = thumbs.querySelector(`.t[data-idx="${currentIndex}"]`);
    if (active) active.classList.add("active");
  }

  function scrollToIndex(idx, smooth=true){
    const n = imagesState.length;
    if (!n || !carousel) return;

    currentIndex = Math.max(0, Math.min(idx, n-1));
    const x = carousel.clientWidth * currentIndex;

    carousel.scrollTo({ left: x, behavior: smooth ? "smooth" : "auto" });
    syncThumbs();
    updateNav();
  }

  function detectIndexFromScroll(){
    if (!carousel) return;
    const w = carousel.clientWidth || 1;
    const idx = Math.round(carousel.scrollLeft / w);
    const n = imagesState.length;
    const clamped = Math.max(0, Math.min(idx, Math.max(0, n-1)));

    if (clamped !== currentIndex){
      currentIndex = clamped;
      syncThumbs();
    }
    updateNav();
  }

  function buildCarousel(images, title){
    imagesState = images.slice();
    currentIndex = 0;

    if (!carousel) return;
    carousel.innerHTML = "";

    if (!imagesState.length){
      carousel.innerHTML = `<div class="heroEmpty">No image</div>`;
      updateNav();
      return;
    }

    imagesState.forEach((u) => {
      const s = document.createElement("div");
      s.className = "slide";
      s.innerHTML = `<img src="${escapeHtml(u)}" alt="${escapeHtml(title)}" draggable="false" />`;
      carousel.appendChild(s);
    });

    requestAnimationFrame(() => scrollToIndex(0, false));
  }

  function renderThumbs(images, title){
    const thumbs = el("thumbs");
    if (!thumbs) return;
    thumbs.innerHTML = "";

    images.forEach((u, idx) => {
      const d = document.createElement("div");
      d.className = "t" + (idx===0 ? " active" : "");
      d.dataset.idx = String(idx);
      d.innerHTML = `<img src="${escapeHtml(u)}" alt="${escapeHtml(title)}" draggable="false" />`;
      d.addEventListener("click", () => scrollToIndex(idx));
      thumbs.appendChild(d);
    });
  }

  /* ==========================================================
     ‚úÖ MOBILE SWIPE FIX (stable)
  ========================================================== */
  function enableDragScroll(){
    if (!carousel) return;

    let active = false;
    let locked = false;
    let startX = 0, startY = 0;
    let lastX = 0;
    let pointerId = null;

    const THRESH = 6;

    const onDown = (e) => {
      if (e.pointerType === "mouse" && e.button !== 0) return;

      active = true;
      locked = false;
      pointerId = e.pointerId;

      startX = e.clientX;
      startY = e.clientY;
      lastX  = e.clientX;

      try{ carousel.setPointerCapture(pointerId); }catch(_){}
    };

    const onMove = (e) => {
      if (!active || pointerId == null) return;
      if (e.pointerId !== pointerId) return;

      const dx = e.clientX - startX;
      const dy = e.clientY - startY;

      if (!locked){
        if (Math.abs(dx) < THRESH && Math.abs(dy) < THRESH) return;

        if (Math.abs(dy) > Math.abs(dx)){
          active = false;
          pointerId = null;
          try{ carousel.releasePointerCapture(e.pointerId); }catch(_){}
          return;
        }

        locked = true;
        carousel.classList.add("dragging");
      }

      if (locked){
        e.preventDefault();
        const ddx = e.clientX - lastX;
        lastX = e.clientX;
        carousel.scrollLeft -= ddx;
      }
    };

    const onUp = () => {
      const wasLocked = locked;

      active = false;
      locked = false;
      pointerId = null;

      carousel.classList.remove("dragging");

      if (wasLocked){
        detectIndexFromScroll();
        scrollToIndex(currentIndex);
      }
    };

    carousel.addEventListener("pointerdown", onDown, { passive:true });
    carousel.addEventListener("pointermove", onMove, { passive:false });
    carousel.addEventListener("pointerup", onUp, { passive:true });
    carousel.addEventListener("pointercancel", onUp, { passive:true });
    carousel.addEventListener("lostpointercapture", onUp, { passive:true });
  }

  function wireCarouselOnce(){
    if (carouselWired) return;
    carouselWired = true;

    prevBtn?.addEventListener("click", () => scrollToIndex(currentIndex - 1));
    nextBtn?.addEventListener("click", () => scrollToIndex(currentIndex + 1));

    let t;
    carousel?.addEventListener("scroll", () => {
      clearTimeout(t);
      t = setTimeout(detectIndexFromScroll, 80);
    });

    enableDragScroll();
    window.addEventListener("resize", () => scrollToIndex(currentIndex, false));
  }

  function setupParallax(){
    const reduceMotion =
      window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    if (reduceMotion || !hero || !heroInner) return;

    const target = { x:0, y:0, rx:0, ry:0, s:1.02 };
    const curr   = { x:0, y:0, rx:0, ry:0, s:1.02 };

    function apply(){
      const k = 0.12;
      curr.x  += (target.x  - curr.x)  * k;
      curr.y  += (target.y  - curr.y)  * k;
      curr.rx += (target.rx - curr.rx) * k;
      curr.ry += (target.ry - curr.ry) * k;

      heroInner.style.transform =
        `translate3d(${curr.x}px, ${curr.y}px, 0) rotateX(${curr.rx}deg) rotateY(${curr.ry}deg) scale(${target.s})`;

      requestAnimationFrame(apply);
    }
    requestAnimationFrame(apply);

    function reset(){ target.x=0; target.y=0; target.rx=0; target.ry=0; }

    hero.addEventListener("mousemove", (e) => {
      const r = hero.getBoundingClientRect();
      const nx = (e.clientX - r.left) / r.width  - 0.5;
      const ny = (e.clientY - r.top)  / r.height - 0.5;

      const maxMove = 6;
      const maxTilt = 2.0;

      target.x  = nx * maxMove;
      target.y  = ny * maxMove;
      target.rx = (-ny) * maxTilt;
      target.ry = (nx) * maxTilt;
    });
    hero.addEventListener("mouseleave", reset);
  }

  // ==========================
  // Cart add + one-item checkout helpers
  // ==========================
  function addToCart(p, qty){
    qty = Number(qty);
    if (!Number.isFinite(qty) || qty <= 0) qty = 1;

    const stock = Number(p.stock ?? 0);
    if (stock <= 0){
      toast("Cart", "Sold out");
      return;
    }

    const cart = readCart();
    const idx = cart.findIndex(x => String(x.pin) === String(p.pin));

    if (idx >= 0){
      const next = Math.min(stock, (Number(cart[idx].qty)||0) + qty);
      cart[idx].qty   = next;
      cart[idx].stock = stock;
      cart[idx].title = p.title;
      cart[idx].image = (p.images && p.images[0]) ? p.images[0] : (cart[idx].image || "");
      cart[idx].price = p.price || cart[idx].price || {};
    } else {
      cart.push({
        pin:   String(p.pin),
        qty:   Math.min(stock, qty),
        title: String(p.title || p.pin),
        image: (p.images && p.images[0]) ? p.images[0] : "",
        price: p.price || {},
        stock: stock
      });
    }

    writeCart(cart);
    updateCartBadge();

    // if drawer is open, refresh view + paypal
    if (elCartDrawer?.classList.contains("show")){
      renderCart();
      ppRenderedForKey = "";
      setTimeout(()=> maybeInitPayPal(), 0);
    }

    toast("Cart", "Added ‚úÖ");
  }

  async function buyNowOneItemStripe(p, qty){
    enforceCurrencyByShipping();
    try{
      localStorage.setItem(MP_SHIP_KEY, String(elShipCountry?.value || DEFAULT_SHIP).toUpperCase());
    }catch(_){}

    const payload = {
      currency: getCurrency(),
      shippingCountry: getShippingCountryISO2(),
      items: [{ pin: String(p.pin), qty: Number(qty) || 1 }],
    };

    const r = await fetch(API_CHECKOUT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const data = await r.json().catch(()=>({}));
    if (!r.ok || !data?.ok || !data?.url){
      throw new Error(data?.error || "Checkout failed");
    }

    window.location.href = data.url;
  }

  // ==========================
  // Main load
  // ==========================
  async function load(){
    updateCartBadge();
    renderCart();

    enforceCurrencyByShipping();
    setCurrency(getCurrency());

    const pin = getPinFromUrl();
    if (!pin){
      window.location.replace("/index.html");
      return;
    }

    let r, data;
    try{
      r = await fetch(`${API_PRODUCT}?pin=${encodeURIComponent(pin)}`, { cache:"no-store" });
      data = await r.json();
    }catch(_){
      el("hTitle").textContent = "Network error";
      el("hSub").textContent = "API is not reachable";
      toast("Error", "Product API is not reachable");
      return;
    }

    if (!r.ok){
      el("hTitle").textContent = "Not found";
      el("hSub").textContent = data?.error || "Product not found";
      return;
    }

    const p = data.product;
    currentProduct = p;

    // SEO
    document.title = `${p.title} ‚Ä¢ Mosaic Pins`;
    const metaDesc = document.querySelector('meta[name="description"]');
    if (metaDesc) metaDesc.setAttribute("content", String(p.description || "").slice(0, 155));

    el("hTitle").textContent = p.title;
    el("hSub").textContent = `${p.pin} ‚Ä¢ √ò ${p.diameter ?? "‚Äî"} mm`;

    el("kicker").textContent = p.type ? String(p.type) : "";
    el("title").textContent  = p.title;

    const d = (p.description || "").trim();
    const descEl = el("desc");
    if (descEl){
      if (/<[a-z][\s\S]*>/i.test(d)) descEl.innerHTML = d;
      else descEl.innerHTML = airtableTextToHtml(d);
    }

    const chips = [];
    if (p.color) chips.push(`Color: ${p.color}`);
    if (p.diameter != null) chips.push(`√ò ${p.diameter} mm`);
    (p.materials || []).forEach(m => chips.push(m));
    el("chips").innerHTML = chips.map(c => `<span class="chip">${escapeHtml(c)}</span>`).join("");

    const images = Array.isArray(p.images) ? p.images : [];
    buildCarousel(images, p.title);
    renderThumbs(images, p.title);
    wireCarouselOnce();
    updateNav();

    const stock = Number(p.stock || 0);
    const badge = el("stockBadge");

    const buyBtn    = el("buyBtn");
    const addBtn    = el("addBtn");
    const qtyInput  = el("qty");

    // show/hide PayPal ONE button area
    if (elPpOneWrap) elPpOneWrap.style.display = (stock > 0) ? "flex" : "none";
    if (elPpOneNote){
      elPpOneNote.textContent = (stock > 0) ? "PayPal is loading‚Ä¶" : "";
      elPpOneNote.style.display = (stock > 0) ? "block" : "none";
    }

    if (stock > 0){
      badge.textContent = `In stock: ${stock}`;
      badge.classList.remove("sold");
      buyBtn.disabled = false;
      addBtn.disabled = false;
    } else {
      badge.textContent = "Sold out";
      badge.classList.add("sold");
      buyBtn.disabled = true;
      addBtn.disabled = true;
    }

    qtyInput.value = "1";
    const setQty = (v) => { qtyInput.value = String(clampQty(v, stock)); };

    el("minus")?.addEventListener("click", () => setQty(Number(qtyInput.value) - 1));
    el("plus") ?.addEventListener("click", () => setQty(Number(qtyInput.value) + 1));
    qtyInput?.addEventListener("input", () => setQty(qtyInput.value));

    const renderPrice = () => { el("price").textContent = priceText(p.price); };
    if (elCurrency) elCurrency.addEventListener("change", renderPrice);
    renderPrice();

    addBtn?.addEventListener("click", () => {
      const quantity = clampQty(qtyInput.value, stock);
      if (stock <= 0) return;
      addToCart(p, quantity);
    });

    // Stripe Buy Now (single item)
    buyBtn?.addEventListener("click", async () => {
      const quantity = clampQty(qtyInput.value, stock);
      if (stock <= 0) return;

      buyBtn.disabled = true;
      const oldText = buyBtn.textContent;
      buyBtn.textContent = "Redirecting‚Ä¶";

      try{
        await buyNowOneItemStripe(p, quantity);
      }catch(e){
        toast("Checkout", String(e?.message || e));
        buyBtn.disabled = false;
        buyBtn.textContent = oldText;
      }
    });

    // ‚úÖ One-item PayPal: render after product is ready and visible
    setTimeout(() => {
      ppOneRenderedForKey = "";
      maybeInitPayPalOne();
    }, 140);

    setupParallax();
  }

  load();
</script>
</body>
</html>
